"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Simctl = exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _index = _interopRequireDefault(require("./subcommands/index.js"));

var _which = _interopRequireDefault(require("which"));

var _logger = _interopRequireWildcard(require("./logger"));

var _helpers = require("./helpers");

var _teen_process = require("teen_process");

const SIMCTL_ENV_PREFIX = 'SIMCTL_CHILD_';
const DEFAULT_OPTS = {
  xcrun: {
    path: null
  },
  execTimeout: _helpers.DEFAULT_EXEC_TIMEOUT,
  logErrors: true
};

class Simctl {
  constructor(opts = {}) {
    opts = _lodash.default.cloneDeep(opts);

    _lodash.default.defaultsDeep(opts, DEFAULT_OPTS);

    for (const key of _lodash.default.keys(DEFAULT_OPTS)) {
      this[key] = opts[key];
    }

    this._udid = _lodash.default.isNil(opts.udid) ? null : opts.udid;
    this._devicesSetPath = _lodash.default.isNil(opts.devicesSetPath) ? null : opts.devicesSetPath;
  }

  set udid(value) {
    this._udid = value;
  }

  get udid() {
    return this._udid;
  }

  set devicesSetPath(value) {
    this._devicesSetPath = value;
  }

  get devicesSetPath() {
    return this._devicesSetPath;
  }

  requireUdid(commandName = null) {
    if (!this.udid) {
      throw new Error(`udid is required to be set for ` + (commandName ? `the '${commandName}' command` : 'this simctl command'));
    }

    return this.udid;
  }

  async requireXcrun() {
    if (!this.xcrun.path) {
      try {
        this.xcrun.path = await (0, _which.default)(_helpers.XCRUN_BINARY);
      } catch (e) {
        throw new Error(`${_helpers.XCRUN_BINARY} tool has not been found in PATH. ` + `Are Xcode developers tools installed?`);
      }
    }

    return this.xcrun.path;
  }

  async exec(subcommand, opts = {}) {
    let {
      args = [],
      env = {},
      asynchronous = false,
      encoding,
      logErrors = true
    } = opts;
    args = ['simctl', ...(this.devicesSetPath ? ['--set', this.devicesSetPath] : []), subcommand, ...args];
    env = _lodash.default.defaults(_lodash.default.mapKeys(env, (value, key) => _lodash.default.startsWith(key, SIMCTL_ENV_PREFIX) ? key : `${SIMCTL_ENV_PREFIX}${key}`), process.env);
    const execOpts = {
      env,
      encoding
    };

    if (!asynchronous) {
      execOpts.timeout = this.execTimeout;
    }

    const xcrun = await this.requireXcrun();

    try {
      return asynchronous ? new _teen_process.SubProcess(xcrun, args, execOpts) : await (0, _teen_process.exec)(xcrun, args, execOpts);
    } catch (e) {
      if (!this.logErrors || !logErrors) {
        throw e;
      } else if (e.stderr) {
        const msg = `Error running '${subcommand}': ${e.stderr.trim()}`;

        _logger.default.debug(_logger.LOG_PREFIX, msg);

        throw Error(msg);
      } else {
        _logger.default.debug(_logger.LOG_PREFIX, e.message);

        throw e;
      }
    }
  }

}

exports.Simctl = Simctl;

for (const [fnName, fn] of _lodash.default.toPairs(_index.default)) {
  Simctl.prototype[fnName] = fn;
}

var _default = Simctl;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW1jdGwuanMiXSwibmFtZXMiOlsiU0lNQ1RMX0VOVl9QUkVGSVgiLCJERUZBVUxUX09QVFMiLCJ4Y3J1biIsInBhdGgiLCJleGVjVGltZW91dCIsIkRFRkFVTFRfRVhFQ19USU1FT1VUIiwibG9nRXJyb3JzIiwiU2ltY3RsIiwiY29uc3RydWN0b3IiLCJvcHRzIiwiXyIsImNsb25lRGVlcCIsImRlZmF1bHRzRGVlcCIsImtleSIsImtleXMiLCJfdWRpZCIsImlzTmlsIiwidWRpZCIsIl9kZXZpY2VzU2V0UGF0aCIsImRldmljZXNTZXRQYXRoIiwidmFsdWUiLCJyZXF1aXJlVWRpZCIsImNvbW1hbmROYW1lIiwiRXJyb3IiLCJyZXF1aXJlWGNydW4iLCJYQ1JVTl9CSU5BUlkiLCJlIiwiZXhlYyIsInN1YmNvbW1hbmQiLCJhcmdzIiwiZW52IiwiYXN5bmNocm9ub3VzIiwiZW5jb2RpbmciLCJkZWZhdWx0cyIsIm1hcEtleXMiLCJzdGFydHNXaXRoIiwicHJvY2VzcyIsImV4ZWNPcHRzIiwidGltZW91dCIsIlN1YlByb2Nlc3MiLCJzdGRlcnIiLCJtc2ciLCJ0cmltIiwibG9nIiwiZGVidWciLCJMT0dfUFJFRklYIiwibWVzc2FnZSIsImZuTmFtZSIsImZuIiwidG9QYWlycyIsInN1YmNvbW1hbmRzIiwicHJvdG90eXBlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBRUEsTUFBTUEsaUJBQWlCLEdBQUcsZUFBMUI7QUFDQSxNQUFNQyxZQUFZLEdBQUc7QUFDbkJDLEVBQUFBLEtBQUssRUFBRTtBQUNMQyxJQUFBQSxJQUFJLEVBQUU7QUFERCxHQURZO0FBSW5CQyxFQUFBQSxXQUFXLEVBQUVDLDZCQUpNO0FBS25CQyxFQUFBQSxTQUFTLEVBQUU7QUFMUSxDQUFyQjs7QUEyQ0EsTUFBTUMsTUFBTixDQUFhO0FBSVhDLEVBQUFBLFdBQVcsQ0FBRUMsSUFBSSxHQUFHLEVBQVQsRUFB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LE9BQVQsR0FBbUIsS0FBS2xDLFdBQXhCO0FBQ0Q7O0FBQ0QsVUFBTUYsS0FBSyxHQUFHLE1BQU0sS0FBS3NCLFlBQUwsRUFBcEI7O0FBQ0EsUUFBSTtBQUNGLGFBQU9PLFlBQVksR0FBRyxJQUFJUSx3QkFBSixDQUFlckMsS0FBZixFQUFzQjJCLElBQXRCLEVBQTRCUSxRQUE1QixDQUFILEdBQTJDLE1BQU0sd0JBQU9uQyxLQUFQLEVBQWMyQixJQUFkLEVBQW9CUSxRQUFwQixDQUFwRTtBQUNELEtBRkQsQ0FFRSxPQUFPWCxDQUFQLEVBQVU7QUFDVixVQUFJLENBQUMsS0FBS3BCLFNBQU4sSUFBbUIsQ0FBQ0EsU0FBeEIsRUFBbUM7QUFHakMsY0FBTW9CLENBQU47QUFDRCxPQUpELE1BSU8sSUFBSUEsQ0FBQyxDQUFDYyxNQUFOLEVBQWM7QUFDbkIsY0FBTUMsR0FBRyxHQUFJLGtCQUFpQmIsVUFBVyxNQUFLRixDQUFDLENBQUNjLE1BQUYsQ0FBU0UsSUFBVCxFQUFnQixFQUE5RDs7QUFDQUMsd0JBQUlDLEtBQUosQ0FBVUMsa0JBQVYsRUFBc0JKLEdBQXRCOztBQUNBLGNBQU1sQixLQUFLLENBQUNrQixHQUFELENBQVg7QUFDRCxPQUpNLE1BSUE7QUFDTEUsd0JBQUlDLEtBQUosQ0FBVUMsa0JBQVYsRUFBc0JuQixDQUFDLENBQUNvQixPQUF4Qjs7QUFDQSxjQUFNcEIsQ0FBTjtBQUNEO0FBQ0Y7QUFDRjs7QUExR1U7Ozs7QUErR2IsS0FBSyxNQUFNLENBQUNxQixNQUFELEVBQVNDLEVBQVQsQ0FBWCxJQUEyQnRDLGdCQUFFdUMsT0FBRixDQUFVQyxjQUFWLENBQTNCLEVBQW1EO0FBQ2pEM0MsRUFBQUEsTUFBTSxDQUFDNEMsU0FBUCxDQUFpQkosTUFBakIsSUFBMkJDLEVBQTNCO0FBQ0Q7O2VBRWN6QyxNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBzdWJjb21tYW5kcyBmcm9tICcuL3N1YmNvbW1hbmRzL2luZGV4LmpzJztcbmltcG9ydCB3aGljaCBmcm9tICd3aGljaCc7XG5pbXBvcnQgbG9nLCB7IExPR19QUkVGSVggfSBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQge1xuICBERUZBVUxUX0VYRUNfVElNRU9VVCwgWENSVU5fQklOQVJZLFxufSBmcm9tICcuL2hlbHBlcnMnO1xuaW1wb3J0IHsgZXhlYyBhcyB0cEV4ZWMsIFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuXG5jb25zdCBTSU1DVExfRU5WX1BSRUZJWCA9ICdTSU1DVExfQ0hJTERfJztcbmNvbnN0IERFRkFVTFRfT1BUUyA9IHtcbiAgeGNydW46IHtcbiAgICBwYXRoOiBudWxsLFxuICB9LFxuICBleGVjVGltZW91dDogREVGQVVMVF9FWEVDX1RJTUVPVVQsXG4gIGxvZ0Vycm9yczogdHJ1ZSxcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gRXhlY09wdHNcbiAqIEBwcm9wZXJ0eSB7QXJyYXkuPHN0cmluZz59IGFyZ3MgW1tdXSAtIFRoZSBsaXN0IG9mIGFkZGl0aW9uYWwgc3ViY29tbWFuZCBhcmd1bWVudHMuXG4gKiBJdCdzIGVtcHR5IGJ5IGRlZmF1bHQuXG4gKiBAcHJvcGVydHkge09iamVjdH0gZW52IFt7fV0gLSBFbnZpcm9ubWVudCB2YXJpYWJsZXMgbWFwcGluZy4gQWxsIHRoZXNlIHZhcmlhYmxlc1xuICogd2lsbCBiZSBwYXNzZWQgU2ltdWxhdG9yIGFuZCB1c2VkIGluIHRoZSBleGVjdXRpbmcgZnVuY3Rpb24uXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGxvZ0Vycm9ycyBbdHJ1ZV0gLSBTZXQgaXQgdG8gX2ZhbHNlXyB0byB0aHJvdyBleGVjdXRpb24gZXJyb3JzXG4gKiBpbW1lZGlhdGVseSB3aXRob3V0IGxvZ2dpbmcgYW55IGFkZGl0aW9uYWwgaW5mb3JtYXRpb24uXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGFzeW5jaHJvbm91cyBbZmFsc2VdIC0gV2hldGhlciB0byBleGVjdXRlIHRoZSBnaXZlbiBjb21tYW5kXG4gKiAnc3luY2hyb25vdXNseScgb3IgJ2FzeW5jaHJvbm91c2x5Jy4gQWZmZWN0cyB0aGUgcmV0dXJuZWQgcmVzdWx0IG9mIHRoZSBmdW5jdGlvbi5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gZW5jb2RpbmcgLSBFeHBsaWNpdGx5IHNldHMgc3RyZWFtcyBlbmNvZGluZyBmb3IgdGhlIGV4ZWN1dGVkXG4gKiBjb21tYW5kIGlucHV0IGFuZCBvdXRwdXRzLlxuICovXG5cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTaW1jdGxPcHRzXG4gKiBAcHJvcGVydHkgez9PYmplY3R9IHhjcnVuIC0gVGhlIHhjcnVuIHByb3BlcnRpZXMuIEN1cnJlbnRseSBvbmx5IG9uZSBwcm9wZXJ0eVxuICogaXMgc3VwcG9ydGVkLCB3aGljaCBpcyBgcGF0aGAgYW5kIGl0IGJ5IGRlZmF1bHQgY29udGFpbnMgYG51bGxgLCB3aGljaCBlbmZvcmNlc1xuICogdGhlIGluc3RhbmNlIHRvIGF1dG9tYXRpY2FsbHkgZGV0ZWN0IHRoZSBmdWxsIHBhdGggdG8gYHhjcnVuYCB0b29sIGFuZCB0byB0aHJvd1xuICogYW4gZXhjZXB0aW9uIGlmIGl0IGNhbm5vdCBiZSBkZXRlY3RlZC4gSWYgdGhlIHBhdGggaXMgc2V0IHVwb24gaW5zdGFuY2UgY3JlYXRpb25cbiAqIHRoZW4gaXQgaXMgZ29pbmcgdG8gYmUgdXNlZCBieSBgZXhlY2AgYW5kIG5vIGF1dG9kZXRlY3Rpb24gd2lsbCBoYXBwZW4uXG4gKiBAcHJvcGVydHkgez9udW1iZXJ9IGV4ZWNUaW1lb3V0IFs2MDAwMDBdIC0gVGhlIG1heGltdW0gbnVtYmVyIG9mIG1pbGxpc2Vjb25kc1xuICogdG8gd2FpdCBmb3Igc2luZ2xlIHN5bmNocm9ub3VzIHhjcnVuIGNvbW1hbmQuXG4gKiBAcHJvcGVydHkgez9ib29sZWFufSBsb2dFcnJvcnMgW3RydWVdIC0gV2hldGhlciB0byB3aXJlIHhjcnVuIGVycm9yIG1lc3NhZ2VzXG4gKiBpbnRvIGRlYnVnIGxvZyBiZWZvcmUgdGhyb3dpbmcgdGhlbS5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdWRpZCBbbnVsbF0gLSBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGN1cnJlbnQgZGV2aWNlLCB3aGljaCBpc1xuICogZ29pbmcgdG8gYmUgaW1wbGljaXRseSBwYXNzZWQgdG8gYWxsIG1ldGhvZHMsIHdoaWNoIHJlcXVpcmUgaXQuIEl0IGNhbiBlaXRoZXIgYmUgc2V0XG4gKiB1cG9uIGluc3RhbmNlIGNyZWF0aW9uIGlmIGl0IGlzIGFscmVhZHkga25vd24gaW4gYWR2YW5jZSBvciBsYXRlciB3aGVuL2lmIG5lZWRlZCB2aWEgdGhlXG4gKiBjb3JyZXNwb25kaW5nIGluc3RhbmNlIHNldHRlci5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gZGV2aWNlc1NldFBhdGggLSBGdWxsIHBhdGggdG8gdGhlIHNldCBvZiBkZXZpY2VzIHRoYXQgeW91IHdhbnQgdG8gbWFuYWdlLlxuICogQnkgZGVmYXVsdCB0aGlzIHBhdGggdXN1YWxseSBlcXVhbHMgdG8gfi9MaWJyYXJ5L0RldmVsb3Blci9Db3JlU2ltdWxhdG9yL0RldmljZXNcbiAqL1xuXG5cbmNsYXNzIFNpbWN0bCB7XG4gIC8qKlxuICAgKiBAcGFyYW0gez9TaW1jdGxPcHRzfSBvcHRzXG4gICAqL1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgb3B0cyA9IF8uY2xvbmVEZWVwKG9wdHMpO1xuICAgIF8uZGVmYXVsdHNEZWVwKG9wdHMsIERFRkFVTFRfT1BUUyk7XG4gICAgZm9yIChjb25zdCBrZXkgb2YgXy5rZXlzKERFRkFVTFRfT1BUUykpIHtcbiAgICAgIHRoaXNba2V5XSA9IG9wdHNba2V5XTtcbiAgICB9XG4gICAgdGhpcy5fdWRpZCA9IF8uaXNOaWwob3B0cy51ZGlkKSA/IG51bGwgOiBvcHRzLnVkaWQ7XG4gICAgdGhpcy5fZGV2aWNlc1NldFBhdGggPSBfLmlzTmlsKG9wdHMuZGV2aWNlc1NldFBhdGgpID8gbnVsbCA6IG9wdHMuZGV2aWNlc1NldFBhdGg7XG4gIH1cblxuICBzZXQgdWRpZCAodmFsdWUpIHtcbiAgICB0aGlzLl91ZGlkID0gdmFsdWU7XG4gIH1cblxuICBnZXQgdWRpZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3VkaWQ7XG4gIH1cblxuICBzZXQgZGV2aWNlc1NldFBhdGggKHZhbHVlKSB7XG4gICAgdGhpcy5fZGV2aWNlc1NldFBhdGggPSB2YWx1ZTtcbiAgfVxuXG4gIGdldCBkZXZpY2VzU2V0UGF0aCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2RldmljZXNTZXRQYXRoO1xuICB9XG5cbiAgcmVxdWlyZVVkaWQgKGNvbW1hbmROYW1lID0gbnVsbCkge1xuICAgIGlmICghdGhpcy51ZGlkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHVkaWQgaXMgcmVxdWlyZWQgdG8gYmUgc2V0IGZvciBgICtcbiAgICAgICAgKGNvbW1hbmROYW1lID8gYHRoZSAnJHtjb21tYW5kTmFtZX0nIGNvbW1hbmRgIDogJ3RoaXMgc2ltY3RsIGNvbW1hbmQnKSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnVkaWQ7XG4gIH1cblxuICBhc3luYyByZXF1aXJlWGNydW4gKCkge1xuICAgIGlmICghdGhpcy54Y3J1bi5wYXRoKSB7XG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLnhjcnVuLnBhdGggPSBhd2FpdCB3aGljaChYQ1JVTl9CSU5BUlkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7WENSVU5fQklOQVJZfSB0b29sIGhhcyBub3QgYmVlbiBmb3VuZCBpbiBQQVRILiBgICtcbiAgICAgICAgICBgQXJlIFhjb2RlIGRldmVsb3BlcnMgdG9vbHMgaW5zdGFsbGVkP2ApO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy54Y3J1bi5wYXRoO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGUgdGhlIHBhcnRpY3VsYXIgc2ltY3RsIGNvbW1hbmQuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzdWJjb21tYW5kIC0gT25lIG9mIGF2YWlsYWJsZSBzaW1jdGwgc3ViY29tbWFuZHMuXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgRXhlY3V0ZSBgeGNydW4gc2ltY3RsYCBpbiBUZXJtaW5hbCB0byBzZWUgdGhlIGZ1bGwgbGlzdFxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgIG9mIGF2YWlsYWJsZSBzdWJjb21tYW5kcy5cbiAgICogQHBhcmFtIHs/RXhlY09wdHN9IG9wdHNcbiAgICogQHJldHVybiB7RXhlY1Jlc3VsdHxTdWJQcm9jZXNzfSBFaXRoZXIgdGhlIHJlc3VsdCBvZiB0ZWVuIHByb2Nlc3MncyBgZXhlY2Agb3JcbiAgICogYFN1YlByb2Nlc3NgIGluc3RhbmNlIGRlcGVuZGluZyBvZiBgb3B0cy5hc3luY2hyb25vdXNgIHZhbHVlLlxuICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIHNpbWN0bCBzdWJjb21tYW5kIGNvbW1hbmQgcmV0dXJucyBub24temVybyByZXR1cm4gY29kZS5cbiAgICovXG4gIGFzeW5jIGV4ZWMgKHN1YmNvbW1hbmQsIG9wdHMgPSB7fSkge1xuICAgIGxldCB7XG4gICAgICBhcmdzID0gW10sXG4gICAgICBlbnYgPSB7fSxcbiAgICAgIGFzeW5jaHJvbm91cyA9IGZhbHNlLFxuICAgICAgZW5jb2RpbmcsXG4gICAgICBsb2dFcnJvcnMgPSB0cnVlLFxuICAgIH0gPSBvcHRzO1xuICAgIC8vIHJ1biBhIHBhcnRpY3VsYXIgc2ltY3RsIGNvbW1hbmRcbiAgICBhcmdzID0gWydzaW1jdGwnLFxuICAgICAgLi4uKHRoaXMuZGV2aWNlc1NldFBhdGggPyBbJy0tc2V0JywgdGhpcy5kZXZpY2VzU2V0UGF0aF0gOiBbXSksXG4gICAgICBzdWJjb21tYW5kLFxuICAgICAgLi4uYXJnc1xuICAgIF07XG4gICAgLy8gUHJlZml4IGFsbCBwYXNzZWQgaW4gZW52aXJvbm1lbnQgdmFyaWFibGVzIHdpdGggJ1NJTUNUTF9DSElMRF8nLCBzaW1jdGxcbiAgICAvLyB3aWxsIHRoZW4gcGFzcyB0aGVzZSB0byB0aGUgY2hpbGQgKHNwYXduZWQpIHByb2Nlc3MuXG4gICAgZW52ID0gXy5kZWZhdWx0cyhcbiAgICAgIF8ubWFwS2V5cyhlbnYsXG4gICAgICAgICh2YWx1ZSwga2V5KSA9PiBfLnN0YXJ0c1dpdGgoa2V5LCBTSU1DVExfRU5WX1BSRUZJWCkgPyBrZXkgOiBgJHtTSU1DVExfRU5WX1BSRUZJWH0ke2tleX1gKSxcbiAgICAgIHByb2Nlc3MuZW52KTtcblxuICAgIGNvbnN0IGV4ZWNPcHRzID0ge1xuICAgICAgZW52LFxuICAgICAgZW5jb2RpbmcsXG4gICAgfTtcbiAgICBpZiAoIWFzeW5jaHJvbm91cykge1xuICAgICAgZXhlY09wdHMudGltZW91dCA9IHRoaXMuZXhlY1RpbWVvdXQ7XG4gICAgfVxuICAgIGNvbnN0IHhjcnVuID0gYXdhaXQgdGhpcy5yZXF1aXJlWGNydW4oKTtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGFzeW5jaHJvbm91cyA/IG5ldyBTdWJQcm9jZXNzKHhjcnVuLCBhcmdzLCBleGVjT3B0cykgOiBhd2FpdCB0cEV4ZWMoeGNydW4sIGFyZ3MsIGV4ZWNPcHRzKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoIXRoaXMubG9nRXJyb3JzIHx8ICFsb2dFcnJvcnMpIHtcbiAgICAgICAgLy8gaWYgd2UgZG9uJ3Qgd2FudCB0byBzZWUgdGhlIGVycm9ycywganVzdCB0aHJvdyBhbmQgYWxsb3cgdGhlIGNhbGxpbmdcbiAgICAgICAgLy8gY29kZSBkbyB3aGF0IGl0IHdhbnRzXG4gICAgICAgIHRocm93IGU7XG4gICAgICB9IGVsc2UgaWYgKGUuc3RkZXJyKSB7XG4gICAgICAgIGNvbnN0IG1zZyA9IGBFcnJvciBydW5uaW5nICcke3N1YmNvbW1hbmR9JzogJHtlLnN0ZGVyci50cmltKCl9YDtcbiAgICAgICAgbG9nLmRlYnVnKExPR19QUkVGSVgsIG1zZyk7XG4gICAgICAgIHRocm93IEVycm9yKG1zZyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoTE9HX1BSRUZJWCwgZS5tZXNzYWdlKTtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuXG4vLyBhZGQgYWxsIHRoZSBzdWJjb21tYW5kcyB0byB0aGUgU2ltY3RsIHByb3RvdHlwZVxuZm9yIChjb25zdCBbZm5OYW1lLCBmbl0gb2YgXy50b1BhaXJzKHN1YmNvbW1hbmRzKSkge1xuICBTaW1jdGwucHJvdG90eXBlW2ZuTmFtZV0gPSBmbjtcbn1cblxuZXhwb3J0IGRlZmF1bHQgU2ltY3RsO1xuZXhwb3J0IHsgU2ltY3RsIH07Il0sImZpbGUiOiJsaWIvc2ltY3RsLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=

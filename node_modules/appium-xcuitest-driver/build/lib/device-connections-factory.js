"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.DeviceConnectionsFactory = exports.DEVICE_CONNECTIONS_FACTORY = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _net = _interopRequireDefault(require("net"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumSupport = require("appium-support");

var _appiumIosDevice = require("appium-ios-device");

var _portscanner = require("portscanner");

class iProxy {
  constructor(udid, localport, deviceport) {
    this.localport = parseInt(localport, 10);
    this.deviceport = parseInt(deviceport, 10);
    this.udid = udid;
    this.serverSocket = null;
    this.log = _appiumSupport.logger.getLogger(`iProxy@${_lodash.default.truncate(udid, {
      length: 8
    })}`);
  }

  async start() {
    if (this.serverSocket) {
      return;
    }

    this.serverSocket = _net.default.createServer(async connection => {
      try {
        const socket = await _appiumIosDevice.utilities.connectPort(this.udid, this.deviceport);
        socket.on('close', connection.destroy);
        socket.on('error', e => this.log.error(e));
        connection.on('close', socket.destroy);
        connection.on('error', e => this.log.error(e));
        connection.pipe(socket);
        socket.pipe(connection);
      } catch (e) {
        this.log.warn(e.message);
        connection.destroy();
      }
    });
    const status = new _bluebird.default((resolve, reject) => {
      this.serverSocket.once('listening', resolve);
      this.serverSocket.once('error', reject);
    });
    this.serverSocket.listen(this.localport);
    await status;
  }

  quit() {
    if (!this.serverSocket) {
      return;
    }

    this.serverSocket.close();
    this.serverSocket = null;
  }

}

const log = _appiumSupport.logger.getLogger('DevCon Factory');

const SPLITTER = ':';

class DeviceConnectionsFactory {
  constructor() {
    this._connectionsMapping = {};
  }

  _udidAsToken(udid) {
    return `${_appiumSupport.util.hasValue(udid) ? udid : ''}${SPLITTER}`;
  }

  _portAsToken(port) {
    return `${SPLITTER}${_appiumSupport.util.hasValue(port) ? port : ''}`;
  }

  _toKey(udid = null, port = null) {
    return `${_appiumSupport.util.hasValue(udid) ? udid : ''}${SPLITTER}${_appiumSupport.util.hasValue(port) ? port : ''}`;
  }

  _releaseProxiedConnections(connectionKeys) {
    const result = [];
    connectionKeys.filter(k => _lodash.default.has(this._connectionsMapping[k], 'iproxy')).map(k => {
      log.info(`Releasing the listener for '${k}'`);

      try {
        this._connectionsMapping[k].iproxy.quit();
      } catch (err) {
        log.warn(`Cannot release the listener for '${k}': ${err.message}`);
      }

      result.push(k);
    });
    return result;
  }

  listConnections(udid = null, port = null, strict = false) {
    if (!udid && !port) {
      return [];
    }

    return _lodash.default.keys(this._connectionsMapping).filter(key => strict && udid && port ? key === this._toKey(udid, port) : udid && key.startsWith(this._udidAsToken(udid)) || port && key.endsWith(this._portAsToken(port)));
  }

  async requestConnection(udid, port, options = {}) {
    if (!udid || !port) {
      log.warn('Did not know how to request the connection:');

      if (!udid) {
        log.warn('- Device UDID is unset');
      }

      if (!port) {
        log.warn('- The local port number is unset');
      }

      return;
    }

    const {
      usePortForwarding,
      devicePort
    } = options;
    log.info(`Requesting connection for device ${udid} on local port ${port}` + (devicePort ? `, device port ${devicePort}` : ''));
    log.debug(`Cached connections count: ${_lodash.default.size(this._connectionsMapping)}`);
    const connectionsOnPort = this.listConnections(null, port);

    if (!_lodash.default.isEmpty(connectionsOnPort)) {
      log.info(`Found cached connections on port #${port}: ${JSON.stringify(connectionsOnPort)}`);
    }

    if (usePortForwarding) {
      let isPortBusy = (await (0, _portscanner.checkPortStatus)(port, '127.0.0.1')) === 'open';
      log.warn(`Port #${port} is busy`);

      if (isPortBusy && !_lodash.default.isEmpty(connectionsOnPort)) {
        log.info('Trying to release the port');

        for (const key of this._releaseProxiedConnections(connectionsOnPort)) {
          delete this._connectionsMapping[key];
        }

        if ((await (0, _portscanner.checkPortStatus)(port, '127.0.0.1')) !== 'open') {
          log.info(`Port #${port} has been successfully released`);
          isPortBusy = false;
        } else {
          log.warn(`Did not know how to release port #${port}`);
        }
      }

      if (isPortBusy) {
        throw new Error(`The port #${port} is occupied by an other process. ` + `You can either quit that process or select another free port.`);
      }
    }

    const currentKey = this._toKey(udid, port);

    if (usePortForwarding) {
      const iproxy = new iProxy(udid, port, devicePort);

      try {
        await iproxy.start();
        this._connectionsMapping[currentKey] = {
          iproxy
        };
      } catch (e) {
        iproxy.quit();
        throw e;
      }
    } else {
      this._connectionsMapping[currentKey] = {};
    }

    log.info(`Successfully requested the connection for ${currentKey}`);
  }

  releaseConnection(udid = null, port = null) {
    if (!udid && !port) {
      log.warn('Neither device UDID nor local port is set. ' + 'Did not know how to release the connection');
      return;
    }

    log.info(`Releasing connections for ${udid || 'any'} device on ${port || 'any'} port number`);
    const keys = this.listConnections(udid, port, true);

    if (_lodash.default.isEmpty(keys)) {
      log.info('No cached connections have been found');
      return;
    }

    log.info(`Found cached connections to release: ${JSON.stringify(keys)}`);

    this._releaseProxiedConnections(keys);

    for (const key of keys) {
      delete this._connectionsMapping[key];
    }

    log.debug(`Cached connections count: ${_lodash.default.size(this._connectionsMapping)}`);
  }

}

exports.DeviceConnectionsFactory = DeviceConnectionsFactory;
const DEVICE_CONNECTIONS_FACTORY = new DeviceConnectionsFactory();
exports.DEVICE_CONNECTIONS_FACTORY = DEVICE_CONNECTIONS_FACTORY;
var _default = DEVICE_CONNECTIONS_FACTORY;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UtY29ubmVjdGlvbnMtZmFjdG9yeS5qcyJdLCJuYW1lcyI6WyJpUHJveHkiLCJjb25zdHJ1Y3RvciIsInVkaWQiLCJsb2NhbHBvcnQiLCJkZXZpY2Vwb3J0IiwicGFyc2VJbnQiLCJzZXJ2ZXJTb2NrZXQiLCJsb2ciLCJsb2dnZXIiLCJnZXRMb2dnZXIiLCJfIiwidHJ1bmNhdGUiLCJsZW5ndGgiLCJzdGFydCIsIm5ldCIsImNyZWF0ZVNlcnZlciIsImNvbm5lY3Rpb24iLCJzb2NrZXQiLCJ1dGlsaXRpZXMiLCJjb25uZWN0UG9ydCIsIm9uIiwiZGVzdHJveSIsImUiLCJlcnJvciIsInBpcGUiLCJ3YXJuIiwibWVzc2FnZSIsInN0YXR1cyIsIkIiLCJyZXNvbHZlIiwicmVqZWN0Iiwib25jZSIsImxpc3RlbiIsInF1aXQiLCJjbG9zZSIsIlNQTElUVEVSIiwiRGV2aWNlQ29ubmVjdGlvbnNGYWN0b3J5IiwiX2Nvbm5lY3Rpb25zTWFwcGluZyIsIl91ZGlkQXNUb2tlbiIsInV0aWwiLCJoYXNWYWx1ZSIsIl9wb3J0QXNUb2tlbiIsInBvcnQiLCJfdG9LZXkiLCJfcmVsZWFzZVByb3hpZWRDb25uZWN0aW9ucyIsImNvbm5lY3Rpb25LZXlzIiwicmVzdWx0IiwiZmlsdGVyIiwiayIsImhhcyIsIm1hcCIsImluZm8iLCJpcHJveHkiLCJlcnIiLCJwdXNoIiwibGlzdENvbm5lY3Rpb25zIiwic3RyaWN0Iiwia2V5cyIsImtleSIsInN0YXJ0c1dpdGgiLCJlbmRzV2l0aCIsInJlcXVlc3RDb25uZWN0aW9uIiwib3B0aW9ucyIsInVzZVBvcnRGb3J3YXJkaW5nIiwiZGV2aWNlUG9ydCIsImRlYnVnIiwic2l6ZSIsImNvbm5lY3Rpb25zT25Qb3J0IiwiaXNFbXB0eSIsIkpTT04iLCJzdHJpbmdpZnkiLCJpc1BvcnRCdXN5IiwiRXJyb3IiLCJjdXJyZW50S2V5IiwicmVsZWFzZUNvbm5lY3Rpb24iLCJERVZJQ0VfQ09OTkVDVElPTlNfRkFDVE9SWSJd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QUFVLDZCQUE0QmpELElBQUksSUFBSSxLQUFNLGNBQWF3QyxJQUFJLElBQUksS0FBTSxjQUEvRTtBQUVBLFVBQU1lLElBQUksR0FBRyxLQUFLRixlQUFMLENBQXFCckQsSUFBckIsRUFBMkJ3QyxJQUEzQixFQUFpQyxJQUFqQyxDQUFiOztBQUNBLFFBQUloQyxnQkFBRTBELE9BQUYsQ0FBVVgsSUFBVixDQUFKLEVBQXFCO0FBQ25CbEQsTUFBQUEsR0FBRyxDQUFDNEMsSUFBSixDQUFTLHVDQUFUO0FBQ0E7QUFDRDs7QUFDRDVDLElBQUFBLEdBQUcsQ0FBQzRDLElBQUosQ0FBVSx3Q0FBdUNrQixJQUFJLENBQUNDLFNBQUwsQ0FBZWIsSUFBZixDQUFxQixFQUF0RTs7QUFDQSxTQUFLYiwwQkFBTCxDQUFnQ2EsSUFBaEM7O0FBQ0EsU0FBSyxNQUFNQyxHQUFYLElBQWtCRCxJQUFsQixFQUF3QjtBQUN0QixhQUFPLEtBQUtwQixtQkFBTCxDQUF5QnFCLEdBQXpCLENBQVA7QUFDRDs7QUFDRG5ELElBQUFBLEdBQUcsQ0FBQzBELEtBQUosQ0FBVyw2QkFBNEJ2RCxnQkFBRXdELElBQUYsQ0FBTyxLQUFLN0IsbUJBQVosQ0FBaUMsRUFBeEU7QUFDRDs7QUFsSTRCOzs7QUFxSS9CLE1BQU1zQywwQkFBMEIsR0FBRyxJQUFJdkMsd0JBQUosRUFBbkM7O2VBR2V1QywwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBsb2dnZXIsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyB1dGlsaXRpZXMgfSBmcm9tICdhcHBpdW0taW9zLWRldmljZSc7XG5pbXBvcnQgeyBjaGVja1BvcnRTdGF0dXMgfSBmcm9tICdwb3J0c2Nhbm5lcic7XG5cbmNsYXNzIGlQcm94eSB7XG4gIGNvbnN0cnVjdG9yICh1ZGlkLCBsb2NhbHBvcnQsIGRldmljZXBvcnQpIHtcbiAgICB0aGlzLmxvY2FscG9ydCA9IHBhcnNlSW50KGxvY2FscG9ydCwgMTApO1xuICAgIHRoaXMuZGV2aWNlcG9ydCA9IHBhcnNlSW50KGRldmljZXBvcnQsIDEwKTtcbiAgICB0aGlzLnVkaWQgPSB1ZGlkO1xuICAgIHRoaXMuc2VydmVyU29ja2V0ID0gbnVsbDtcbiAgICB0aGlzLmxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoYGlQcm94eUAke18udHJ1bmNhdGUodWRpZCwge2xlbmd0aDogOH0pfWApO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKCkge1xuICAgIGlmICh0aGlzLnNlcnZlclNvY2tldCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnNlcnZlclNvY2tldCA9IG5ldC5jcmVhdGVTZXJ2ZXIoYXN5bmMgKGNvbm5lY3Rpb24pID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHNvY2tldCA9IGF3YWl0IHV0aWxpdGllcy5jb25uZWN0UG9ydCh0aGlzLnVkaWQsIHRoaXMuZGV2aWNlcG9ydCk7XG4gICAgICAgIHNvY2tldC5vbignY2xvc2UnLCBjb25uZWN0aW9uLmRlc3Ryb3kpO1xuICAgICAgICBzb2NrZXQub24oJ2Vycm9yJywgKGUpID0+IHRoaXMubG9nLmVycm9yKGUpKTtcbiAgICAgICAgY29ubmVjdGlvbi5vbignY2xvc2UnLCBzb2NrZXQuZGVzdHJveSk7XG4gICAgICAgIGNvbm5lY3Rpb24ub24oJ2Vycm9yJywgKGUpID0+IHRoaXMubG9nLmVycm9yKGUpKTtcbiAgICAgICAgY29ubmVjdGlvbi5waXBlKHNvY2tldCk7XG4gICAgICAgIHNvY2tldC5waXBlKGNvbm5lY3Rpb24pO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aGlzLmxvZy53YXJuKGUubWVzc2FnZSk7XG4gICAgICAgIGNvbm5lY3Rpb24uZGVzdHJveSgpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGNvbnN0IHN0YXR1cyA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuc2VydmVyU29ja2V0Lm9uY2UoJ2xpc3RlbmluZycsIHJlc29sdmUpO1xuICAgICAgdGhpcy5zZXJ2ZXJTb2NrZXQub25jZSgnZXJyb3InLCByZWplY3QpO1xuICAgIH0pO1xuICAgIHRoaXMuc2VydmVyU29ja2V0Lmxpc3Rlbih0aGlzLmxvY2FscG9ydCk7XG4gICAgYXdhaXQgc3RhdHVzO1xuICB9XG5cbiAgcXVpdCAoKSB7XG4gICAgaWYgKCF0aGlzLnNlcnZlclNvY2tldCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnNlcnZlclNvY2tldC5jbG9zZSgpO1xuICAgIHRoaXMuc2VydmVyU29ja2V0ID0gbnVsbDtcbiAgfVxufVxuXG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ0RldkNvbiBGYWN0b3J5Jyk7XG5jb25zdCBTUExJVFRFUiA9ICc6JztcblxuY2xhc3MgRGV2aWNlQ29ubmVjdGlvbnNGYWN0b3J5IHtcbiAgY29uc3RydWN0b3IgKCkge1xuICAgIHRoaXMuX2Nvbm5lY3Rpb25zTWFwcGluZyA9IHt9O1xuICB9XG5cbiAgX3VkaWRBc1Rva2VuICh1ZGlkKSB7XG4gICAgcmV0dXJuIGAke3V0aWwuaGFzVmFsdWUodWRpZCkgPyB1ZGlkIDogJyd9JHtTUExJVFRFUn1gO1xuICB9XG5cbiAgX3BvcnRBc1Rva2VuIChwb3J0KSB7XG4gICAgcmV0dXJuIGAke1NQTElUVEVSfSR7dXRpbC5oYXNWYWx1ZShwb3J0KSA/IHBvcnQgOiAnJ31gO1xuICB9XG5cbiAgX3RvS2V5ICh1ZGlkID0gbnVsbCwgcG9ydCA9IG51bGwpIHtcbiAgICByZXR1cm4gYCR7dXRpbC5oYXNWYWx1ZSh1ZGlkKSA/IHVkaWQgOiAnJ30ke1NQTElUVEVSfSR7dXRpbC5oYXNWYWx1ZShwb3J0KSA/IHBvcnQgOiAnJ31gO1xuICB9XG5cbiAgX3JlbGVhc2VQcm94aWVkQ29ubmVjdGlvbnMgKGNvbm5lY3Rpb25LZXlzKSB7XG4gICAgY29uc3QgcmVzdWx0ID0gW107XG4gICAgY29ubmVjdGlvbktleXNcbiAgICAgIC5maWx0ZXIoKGspID0+IF8uaGFzKHRoaXMuX2Nvbm5lY3Rpb25zTWFwcGluZ1trXSwgJ2lwcm94eScpKVxuICAgICAgLm1hcCgoaykgPT4ge1xuICAgICAgICBsb2cuaW5mbyhgUmVsZWFzaW5nIHRoZSBsaXN0ZW5lciBmb3IgJyR7a30nYCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgdGhpcy5fY29ubmVjdGlvbnNNYXBwaW5nW2tdLmlwcm94eS5xdWl0KCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGxvZy53YXJuKGBDYW5ub3QgcmVsZWFzZSB0aGUgbGlzdGVuZXIgZm9yICcke2t9JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgICAgICByZXN1bHQucHVzaChrKTtcbiAgICAgIH0pO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBsaXN0Q29ubmVjdGlvbnMgKHVkaWQgPSBudWxsLCBwb3J0ID0gbnVsbCwgc3RyaWN0ID0gZmFsc2UpIHtcbiAgICBpZiAoIXVkaWQgJiYgIXBvcnQpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICAvLyBgdGhpcy5fY29ubmVjdGlvbk1hcHBpbmdgIGtleXMgaGF2ZSBmb3JtYXQgYHVkaWQ6cG9ydGBcbiAgICAvLyB0aGUgYHN0cmljdGAgYXJndW1lbnQgZW5mb3JjZXMgdG8gbWF0Y2gga2V5cyBoYXZpbmcgYm90aCBgdWRpZGAgYW5kIGBwb3J0YFxuICAgIC8vIGlmIHRoZXkgYXJlIGRlZmluZWRcbiAgICAvLyB3aGlsZSBpbiBub24tc3RyaWN0IG1vZGUga2V5cyBoYXZpbmcgYW55IG9mIHRoZXNlIGFyZSBnb2luZyB0byBiZSBtYXRjaGVkXG4gICAgcmV0dXJuIF8ua2V5cyh0aGlzLl9jb25uZWN0aW9uc01hcHBpbmcpXG4gICAgICAuZmlsdGVyKChrZXkpID0+IChzdHJpY3QgJiYgdWRpZCAmJiBwb3J0KVxuICAgICAgICA/IChrZXkgPT09IHRoaXMuX3RvS2V5KHVkaWQsIHBvcnQpKVxuICAgICAgICA6ICh1ZGlkICYmIGtleS5zdGFydHNXaXRoKHRoaXMuX3VkaWRBc1Rva2VuKHVkaWQpKSB8fCBwb3J0ICYmIGtleS5lbmRzV2l0aCh0aGlzLl9wb3J0QXNUb2tlbihwb3J0KSkpXG4gICAgICApO1xuICB9XG5cbiAgYXN5bmMgcmVxdWVzdENvbm5lY3Rpb24gKHVkaWQsIHBvcnQsIG9wdGlvbnMgPSB7fSkge1xuICAgIGlmICghdWRpZCB8fCAhcG9ydCkge1xuICAgICAgbG9nLndhcm4oJ0RpZCBub3Qga25vdyBob3cgdG8gcmVxdWVzdCB0aGUgY29ubmVjdGlvbjonKTtcbiAgICAgIGlmICghdWRpZCkge1xuICAgICAgICBsb2cud2FybignLSBEZXZpY2UgVURJRCBpcyB1bnNldCcpO1xuICAgICAgfVxuICAgICAgaWYgKCFwb3J0KSB7XG4gICAgICAgIGxvZy53YXJuKCctIFRoZSBsb2NhbCBwb3J0IG51bWJlciBpcyB1bnNldCcpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHtcbiAgICAgIHVzZVBvcnRGb3J3YXJkaW5nLFxuICAgICAgZGV2aWNlUG9ydCxcbiAgICB9ID0gb3B0aW9ucztcblxuICAgIGxvZy5pbmZvKGBSZXF1ZXN0aW5nIGNvbm5lY3Rpb24gZm9yIGRldmljZSAke3VkaWR9IG9uIGxvY2FsIHBvcnQgJHtwb3J0fWAgK1xuICAgICAgKGRldmljZVBvcnQgPyBgLCBkZXZpY2UgcG9ydCAke2RldmljZVBvcnR9YCA6ICcnKSk7XG4gICAgbG9nLmRlYnVnKGBDYWNoZWQgY29ubmVjdGlvbnMgY291bnQ6ICR7Xy5zaXplKHRoaXMuX2Nvbm5lY3Rpb25zTWFwcGluZyl9YCk7XG4gICAgY29uc3QgY29ubmVjdGlvbnNPblBvcnQgPSB0aGlzLmxpc3RDb25uZWN0aW9ucyhudWxsLCBwb3J0KTtcbiAgICBpZiAoIV8uaXNFbXB0eShjb25uZWN0aW9uc09uUG9ydCkpIHtcbiAgICAgIGxvZy5pbmZvKGBGb3VuZCBjYWNoZWQgY29ubmVjdGlvbnMgb24gcG9ydCAjJHtwb3J0fTogJHtKU09OLnN0cmluZ2lmeShjb25uZWN0aW9uc09uUG9ydCl9YCk7XG4gICAgfVxuXG4gICAgaWYgKHVzZVBvcnRGb3J3YXJkaW5nKSB7XG4gICAgICBsZXQgaXNQb3J0QnVzeSA9IChhd2FpdCBjaGVja1BvcnRTdGF0dXMocG9ydCwgJzEyNy4wLjAuMScpKSA9PT0gJ29wZW4nO1xuICAgICAgbG9nLndhcm4oYFBvcnQgIyR7cG9ydH0gaXMgYnVzeWApO1xuICAgICAgaWYgKGlzUG9ydEJ1c3kgJiYgIV8uaXNFbXB0eShjb25uZWN0aW9uc09uUG9ydCkpIHtcbiAgICAgICAgbG9nLmluZm8oJ1RyeWluZyB0byByZWxlYXNlIHRoZSBwb3J0Jyk7XG4gICAgICAgIGZvciAoY29uc3Qga2V5IG9mIHRoaXMuX3JlbGVhc2VQcm94aWVkQ29ubmVjdGlvbnMoY29ubmVjdGlvbnNPblBvcnQpKSB7XG4gICAgICAgICAgZGVsZXRlIHRoaXMuX2Nvbm5lY3Rpb25zTWFwcGluZ1trZXldO1xuICAgICAgICB9XG4gICAgICAgIGlmICgoYXdhaXQgY2hlY2tQb3J0U3RhdHVzKHBvcnQsICcxMjcuMC4wLjEnKSkgIT09ICdvcGVuJykge1xuICAgICAgICAgIGxvZy5pbmZvKGBQb3J0ICMke3BvcnR9IGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSByZWxlYXNlZGApO1xuICAgICAgICAgIGlzUG9ydEJ1c3kgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsb2cud2FybihgRGlkIG5vdCBrbm93IGhvdyB0byByZWxlYXNlIHBvcnQgIyR7cG9ydH1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoaXNQb3J0QnVzeSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBwb3J0ICMke3BvcnR9IGlzIG9jY3VwaWVkIGJ5IGFuIG90aGVyIHByb2Nlc3MuIGAgK1xuICAgICAgICAgIGBZb3UgY2FuIGVpdGhlciBxdWl0IHRoYXQgcHJvY2VzcyBvciBzZWxlY3QgYW5vdGhlciBmcmVlIHBvcnQuYCk7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGN1cnJlbnRLZXkgPSB0aGlzLl90b0tleSh1ZGlkLCBwb3J0KTtcbiAgICBpZiAodXNlUG9ydEZvcndhcmRpbmcpIHtcbiAgICAgIGNvbnN0IGlwcm94eSA9IG5ldyBpUHJveHkodWRpZCwgcG9ydCwgZGV2aWNlUG9ydCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBpcHJveHkuc3RhcnQoKTtcbiAgICAgICAgdGhpcy5fY29ubmVjdGlvbnNNYXBwaW5nW2N1cnJlbnRLZXldID0ge2lwcm94eX07XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGlwcm94eS5xdWl0KCk7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2Nvbm5lY3Rpb25zTWFwcGluZ1tjdXJyZW50S2V5XSA9IHt9O1xuICAgIH1cbiAgICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IHJlcXVlc3RlZCB0aGUgY29ubmVjdGlvbiBmb3IgJHtjdXJyZW50S2V5fWApO1xuICB9XG5cbiAgcmVsZWFzZUNvbm5lY3Rpb24gKHVkaWQgPSBudWxsLCBwb3J0ID0gbnVsbCkge1xuICAgIGlmICghdWRpZCAmJiAhcG9ydCkge1xuICAgICAgbG9nLndhcm4oJ05laXRoZXIgZGV2aWNlIFVESUQgbm9yIGxvY2FsIHBvcnQgaXMgc2V0LiAnICtcbiAgICAgICAgJ0RpZCBub3Qga25vdyBob3cgdG8gcmVsZWFzZSB0aGUgY29ubmVjdGlvbicpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsb2cuaW5mbyhgUmVsZWFzaW5nIGNvbm5lY3Rpb25zIGZvciAke3VkaWQgfHwgJ2FueSd9IGRldmljZSBvbiAke3BvcnQgfHwgJ2FueSd9IHBvcnQgbnVtYmVyYCk7XG5cbiAgICBjb25zdCBrZXlzID0gdGhpcy5saXN0Q29ubmVjdGlvbnModWRpZCwgcG9ydCwgdHJ1ZSk7XG4gICAgaWYgKF8uaXNFbXB0eShrZXlzKSkge1xuICAgICAgbG9nLmluZm8oJ05vIGNhY2hlZCBjb25uZWN0aW9ucyBoYXZlIGJlZW4gZm91bmQnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbG9nLmluZm8oYEZvdW5kIGNhY2hlZCBjb25uZWN0aW9ucyB0byByZWxlYXNlOiAke0pTT04uc3RyaW5naWZ5KGtleXMpfWApO1xuICAgIHRoaXMuX3JlbGVhc2VQcm94aWVkQ29ubmVjdGlvbnMoa2V5cyk7XG4gICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgICAgZGVsZXRlIHRoaXMuX2Nvbm5lY3Rpb25zTWFwcGluZ1trZXldO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYENhY2hlZCBjb25uZWN0aW9ucyBjb3VudDogJHtfLnNpemUodGhpcy5fY29ubmVjdGlvbnNNYXBwaW5nKX1gKTtcbiAgfVxufVxuXG5jb25zdCBERVZJQ0VfQ09OTkVDVElPTlNfRkFDVE9SWSA9IG5ldyBEZXZpY2VDb25uZWN0aW9uc0ZhY3RvcnkoKTtcblxuZXhwb3J0IHsgREVWSUNFX0NPTk5FQ1RJT05TX0ZBQ1RPUlksIERldmljZUNvbm5lY3Rpb25zRmFjdG9yeSB9O1xuZXhwb3J0IGRlZmF1bHQgREVWSUNFX0NPTk5FQ1RJT05TX0ZBQ1RPUlk7XG4iXSwiZmlsZSI6ImxpYi9kZXZpY2UtY29ubmVjdGlvbnMtZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumIosDriver = require("appium-ios-driver");

var _appiumSupport = require("appium-support");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("../logger"));

let commands = {},
    extensions = {};
exports.commands = commands;
Object.assign(extensions, _appiumIosDriver.iosCommands.element);

commands.getNativeAttribute = async function getNativeAttribute(attribute, el) {
  if (attribute === 'contentSize') {
    return await this.getContentSize(el);
  }

  el = _appiumSupport.util.unwrapElement(el);
  let value = await this.proxyCommand(`/element/${el}/attribute/${attribute}`, 'GET');

  if ([0, 1].includes(value)) {
    value = !!value;
  }

  return _lodash.default.isNull(value) || _lodash.default.isString(value) ? value : JSON.stringify(value);
};

commands.getAttribute = async function getAttribute(attribute, el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (!this.isWebContext()) {
    return await this.getNativeAttribute(attribute, el);
  }

  const atomsElement = this.getAtomsElement(el);

  if (_lodash.default.isNull(atomsElement)) {
    throw new _appiumBaseDriver.errors.UnknownError(`Error converting element ID for using in WD atoms: '${el}`);
  }

  return await this.executeAtom('get_attribute_value', [atomsElement, attribute]);
};

commands.getText = async function getText(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (!this.isWebContext()) {
    return await this.proxyCommand(`/element/${el}/text`, 'GET');
  }

  let atomsElement = this.useAtomsElement(el);
  return await this.executeAtom('get_text', [atomsElement]);
};

commands.getElementRect = async function getElementRect(el) {
  if (this.isWebContext()) {
    const {
      x,
      y
    } = await this.getLocation(el);
    const {
      width,
      height
    } = await this.getSize(el);
    return {
      x,
      y,
      width,
      height
    };
  }

  el = _appiumSupport.util.unwrapElement(el);
  return await this.getNativeRect(el);
};

extensions.getNativeRect = async function getNativeRect(el) {
  return await this.proxyCommand(`/element/${el}/rect`, 'GET');
};

commands.getLocation = async function getLocation(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    const atomsElement = await this.useAtomsElement(el);
    let loc = await this.executeAtom('get_top_left_coordinates', [atomsElement]);

    if (this.opts.absoluteWebLocations) {
      const script = 'return [document.body.scrollLeft, document.body.scrollTop];';
      const [xOffset, yOffset] = await this.execute(script);
      loc.x += xOffset;
      loc.y += yOffset;
    }

    return loc;
  }

  const rect = await this.getElementRect(el);
  return {
    x: rect.x,
    y: rect.y
  };
};

commands.getLocationInView = async function getLocationInView(el) {
  return await this.getLocation(el);
};

commands.getSize = async function getSize(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    let atomsElement = this.getAtomsElement(el);

    if (atomsElement === null) {
      throw new _appiumBaseDriver.errors.UnknownError(`Error converting element ID for using in WD atoms: '${el}'`);
    }

    return await this.executeAtom('get_size', [atomsElement]);
  }

  const rect = await this.getElementRect(el);
  return {
    width: rect.width,
    height: rect.height
  };
};

function hasSpecialKeys(keys) {
  for (let char of keys) {
    if (isSpecialKey(char)) {
      return true;
    }
  }

  return false;
}

function isSpecialKey(k) {
  if (k === '\uE003' || k === '\ue017') {
    return true;
  } else if (k === '\uE006' || k === '\uE007') {
    return true;
  }

  return false;
}

function translateKey(k) {
  if (k === '\uE006' || k === '\uE007') {
    return '\n';
  } else if (k === '\uE003' || k === '\ue017') {
    return '\b';
  }

  return k;
}

extensions.bringUpKeyboard = async function bringUpKeyboard(element) {
  let implicitWaitMs = this.implicitWaitMs;
  await this.setImplicitWait(0);

  try {
    await (0, _asyncbox.retryInterval)(10, 10, async () => {
      try {
        await this.findNativeElementOrElements('class name', 'XCUIElementTypeKeyboard', false);

        _logger.default.debug('Keyboard found. Continuing with text input.');
      } catch (err) {
        _logger.default.debug('No keyboard found. Clicking element to open it.');

        await this.nativeClick(element);
        await this.findNativeElementOrElements('class name', 'XCUIElementTypeKeyboard', false);
      }
    });
  } finally {
    await this.setImplicitWait(implicitWaitMs);
  }
};

commands.setValueImmediate = async function setValueImmediate(value, el) {
  _logger.default.info('There is currently no way to bypass typing using XCUITest. Setting value through keyboard');

  await this.setValue(value, el);
};

commands.setValue = async function setValue(value, el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    let atomsElement = this.useAtomsElement(el);
    await this.executeAtom('click', [atomsElement]);
    await this.executeAtom('type', [atomsElement, value]);
  } else {
    const setFormattedValue = async (input, isKeyboardPresenceCheckEnabled) => {
      if (typeof input !== 'string' && !(input instanceof Array)) {
        input = input.toString().split('');
      }

      try {
        await this.proxyCommand(`/element/${el}/value`, 'POST', {
          value: input
        });
      } catch (err) {
        if (isKeyboardPresenceCheckEnabled && (await this.getAttribute('type', el)) === 'XCUIElementTypeTextField') {
          _logger.default.info(`Cannot type in the text field because of ${err}.\nTrying to apply a workaround...`);

          await this.bringUpKeyboard(el);
          await this.proxyCommand(`/element/${el}/value`, 'POST', {
            value: input
          });
        } else {
          throw err;
        }
      }
    };

    if (_lodash.default.isNull(value) || _lodash.default.isUndefined(value) || _lodash.default.isPlainObject(value)) {
      throw new Error(`Only strings and arrays of strings are supported as input arguments. Received: '${JSON.stringify(value)}'`);
    }

    if (_lodash.default.isArray(value)) {
      value = _lodash.default.flatMap(value, v => (_lodash.default.isString(v) ? v : JSON.stringify(v)).split(''));
    } else {
      value = (value || '').toString().split('');
    }

    if (!hasSpecialKeys(value)) {
      await setFormattedValue(value, true);
      return;
    }

    let buffer = [];
    let isFirstChar = true;

    for (let k of value) {
      let char = translateKey(k);

      if (char === k) {
        buffer.push(char);
        continue;
      }

      await setFormattedValue(buffer, isFirstChar);
      isFirstChar = false;
      buffer = [];
      await setFormattedValue([char], isFirstChar);
    }

    if (buffer.length) {
      await setFormattedValue(buffer, false);
    }
  }
};

commands.keys = async function keys(value) {
  if (_lodash.default.isArray(value)) {
    value = value.join('');
  }

  if (_lodash.default.isString(value)) {
    value = value.split('');
  }

  let buffer = [];

  for (let k of value) {
    let char = translateKey(k);
    buffer.push(char);
  }

  await this.proxyCommand('/wda/keys', 'POST', {
    value: buffer
  });
};

commands.clear = async function clear(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    let atomsElement = this.useAtomsElement(el);
    await this.executeAtom('clear', [atomsElement]);
    return;
  }

  await (0, _asyncbox.retry)(5, this.proxyCommand.bind(this), `/element/${el}/clear`, 'POST');
};

commands.getContentSize = async function getContentSize(el) {
  if (this.isWebContext()) {
    throw new _appiumBaseDriver.errors.NotYetImplementedError('Support for getContentSize for web context is not yet implemented. Please contact an Appium dev');
  }

  const type = await this.getAttribute('type', el);

  if (type !== 'XCUIElementTypeTable' && type !== 'XCUIElementTypeCollectionView') {
    throw new Error(`Can't get content size for type '${type}', only for ` + `tables and collection views`);
  }

  let locator = '*';

  if (type === 'XCUIElementTypeTable') {
    locator = 'XCUIElementTypeCell';
  }

  let contentHeight = 0;
  const children = await this.findElOrEls(`class chain`, locator, true, el);

  if (children.length === 1) {
    const rect = await this.getElementRect(_lodash.default.head(children));
    contentHeight = rect.height;
  } else if (children.length) {
    switch (type) {
      case 'XCUIElementTypeTable':
        {
          const firstRect = await this.getElementRect(_lodash.default.head(children));
          const lastRect = await this.getElementRect(_lodash.default.last(children));
          contentHeight = lastRect.y + lastRect.height - firstRect.y;
          break;
        }

      case 'XCUIElementTypeCollectionView':
        {
          let elsInRow = 1;
          let firstRect = await this.getElementRect(_lodash.default.head(children));
          let initialRects = [firstRect];

          for (let i = 1; i < children.length; i++) {
            const rect = await this.getElementRect(children[i]);
            initialRects.push(rect);

            if (rect.y !== firstRect.y) {
              elsInRow = i;
              break;
            }
          }

          const spaceBetweenEls = initialRects[elsInRow].y - initialRects[elsInRow - 1].y - initialRects[elsInRow - 1].height;
          const numRows = Math.ceil(children.length / elsInRow);
          contentHeight = numRows * firstRect.height + spaceBetweenEls * (numRows - 1);
          break;
        }

      default:
        throw new Error(`Programming error: type '${type}' was not ` + `valid but should have already been rejected`);
    }
  }

  const size = await this.getSize(el);
  const origin = await this.getLocationInView(el);
  return JSON.stringify({
    width: size.width,
    height: size.height,
    top: origin.y,
    left: origin.x,
    scrollableOffset: contentHeight
  });
};

commands.isKeyboardShown = async function isKeyboardShown() {
  try {
    await this.findNativeElementOrElements('class name', 'XCUIElementTypeKeyboard', false);
    return true;
  } catch (ign) {
    return false;
  }
};

Object.assign(extensions, commands);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9lbGVtZW50LmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiZXh0ZW5zaW9ucyIsIk9iamVjdCIsImFzc2lnbiIsImlvc0NvbW1hbmRzIiwiZWxlbWVudCIsImdldE5hdGl2ZUF0dHJpYnV0ZSIsImF0dHJpYnV0ZSIsImVsIiwiZ2V0Q29udGVudFNpemUiLCJ1dGlsIiwidW53cmFwRWxlbWVudCIsInZhbHVlIiwicHJveHlDb21tYW5kIiwiaW5jbHVkZXMiLCJfIiwiaXNOdWxsIiwiaXNTdHJpbmciLCJKU09OIiwic3RyaW5naWZ5IiwiZ2V0QXR0cmlidXRlIiwiaXNXZWJDb250ZXh0IiwiYXRvbXNFbGVtZW50IiwiZ2V0QXRvbXNFbGVtZW50IiwiZXJyb3JzIiwiVW5rbm93bkVycm9yIiwiZXhlY3V0ZUF0b20iLCJnZXRUZXh0IiwidXNlQXRvbXNFbGVtZW50IiwiZ2V0RWxlbWVudFJlY3QiLCJ4IiwieSIsImdldExvY2F0aW9uIiwid2lkdGgiLCJoZWlnaHQiLCJnZXRTaXplIiwiZ2V0TmF0aXZlUmVjdCIsImxvYyIsIm9wdHMiLCJhYnNvbHV0ZVdlYkxvY2F0aW9ucyIsInNjcmlwdCIsInhPZmZzZXQiLCJ5T2Zmc2V0IiwiZXhlY3V0ZSIsInJlY3QiLCJnZXRMb2NhdGlvbkluVmlldyIsImhhc1NwZWNpYWxLZXlzIiwia2V5cyIsImNoYXIiLCJpc1NwZWNpYWxLZXkiLCJrIiwidHJhbnNsYXRlS2V5IiwiYnJpbmdVcEtleWJvYXJkIiwiaW1wbGljaXRXYWl0TXMiLCJzZXRJbXBsaWNpdFdhaXQiLCJmaW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMiLCJsb2ciLCJkZWJ1ZyIsImVyciIsIm5hdGl2ZUNsaWNrIiwic2V0VmFsdWVJbW1lZGlhdGUiLCJpbmZvIiwic2V0VmFsdWUiLCJzZXRGb3JtYXR0ZWRWYWx1ZSIsImlucHV0IiwiaXNLZXlib2FyZFByZXNlbmNlQ2hlY2tFbmFibGVkIiwiQXJyYXkiLCJ0b1N0cmluZyIsInNwbGl0IiwiaXNVbmRlZmluZWQiLCJpc1BsYWluT2JqZWN0IiwiRXJyb3IiLCJpc0FycmF5IiwiZmxhdE1hcCIsInYiLCJidWZmZXIiLCJpc0ZpcnN0Q2hhciIsInB1c2giLCJsZW5ndGgiLCJqb2luIiwiY2xlYXIiLCJiaW5kIiwiTm90WWV0SW1wbGVtZW50ZWRFcnJvciIsInR5cGUiLCJsb2NhdG9yIiwiY29udGVudEhlaWdodCIsImNoaWxkcmVuIiwiZmluZEVsT3JFbHMiLCJoZWFkIiwiZmlyc3RSZWN0IiwibGFzdFJlY3QiLCJsYXN0IiwiZWxzSW5Sb3ciLCJpbml0aWFsUmVjdHMiLCJpIiwic3BhY2VCZXR3ZWVuRWxzIiwibnVtUm93cyIsIk1hdGgiLCJjZWlsIiwic2l6ZSIsIm9yaWdpbiIsInRvcCIsImxlZnQiLCJzY3JvbGxhYmxlT2Zmc2V0IiwiaXNLZXlib2FyZFNob3duIiwiaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLFVBQVUsR0FBRyxFQUFoQzs7QUFJQUMsTUFBTSxDQUFDQyxNQUFQLENBQWNGLFVBQWQsRUFBMEJHLDZCQUFZQyxPQUF0Qzs7QUFFQUwsUUFBUSxDQUFDTSxrQkFBVCxHQUE4QixlQUFlQSxrQkFBZixDQUFtQ0MsU0FBbkMsRUFBOENDLEVBQTlDLEVBQWtEO0FBQzlFLE1BQUlELFNBQVMsS0FBSyxhQUFsQixFQUFpQztBQUUvQixXQUFPLE1BQU0sS0FBS0UsY0FBTCxDQUFvQkQsRUFBcEIsQ0FBYjtBQUNEOztBQUVEQSxFQUFBQSxFQUFFLEdBQUdFLG9CQUFLQyxhQUFMLENBQW1CSCxFQUFuQixDQUFMO0FBR0EsTUFBSUksS0FBSyxHQUFHLE1BQU0sS0FBS0MsWUFBTCxDQUFtQixZQUFXTCxFQUFHLGNBQWFELFNBQVUsRUFBeEQsRUFBMkQsS0FBM0QsQ0FBbEI7O0FBRUEsTUFBSSxDQUFDLENBQUQsRUFBSSxDQUFKLEVBQU9PLFFBQVAs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LEVBQStDLHlCQUEvQyxFQUEwRSxLQUExRSxDQUFOO0FBQ0EsV0FBTyxJQUFQO0FBQ0QsR0FIRCxDQUdFLE9BQU9rRCxHQUFQLEVBQVk7QUFDWixXQUFPLEtBQVA7QUFDRDtBQUNGLENBUEQ7O0FBU0F2RyxNQUFNLENBQUNDLE1BQVAsQ0FBY0YsVUFBZCxFQUEwQkQsUUFBMUI7ZUFFZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgaW9zQ29tbWFuZHMgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCwgcmV0cnkgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5cblxubGV0IGNvbW1hbmRzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuLy8gcHVsbCBpbiBhbGwgdGhlIGVsZW1lbnQgY29tbWFuZHMgYW5kIGhlbHBlcnMgZnJvbSBpb3MtZHJpdmVyLFxuLy8gdGhlbiBvdmVycmlkZSBhbnl0aGluZyB3ZSB3YW50IGJlbG93XG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGlvc0NvbW1hbmRzLmVsZW1lbnQpO1xuXG5jb21tYW5kcy5nZXROYXRpdmVBdHRyaWJ1dGUgPSBhc3luYyBmdW5jdGlvbiBnZXROYXRpdmVBdHRyaWJ1dGUgKGF0dHJpYnV0ZSwgZWwpIHtcbiAgaWYgKGF0dHJpYnV0ZSA9PT0gJ2NvbnRlbnRTaXplJykge1xuICAgIC8vIGRvbid0IHByb3h5IHJlcXVlc3RzIGZvciB0aGUgY29udGVudCBzaXplIG9mIGEgc2Nyb2xsYWJsZSBlbGVtZW50XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0Q29udGVudFNpemUoZWwpO1xuICB9XG5cbiAgZWwgPSB1dGlsLnVud3JhcEVsZW1lbnQoZWwpO1xuXG4gIC8vIG90aGVyd2lzZSBsZXQgV0RBIGhhbmRsZSBhdHRyaWJ1dGUgcmVxdWVzdHNcbiAgbGV0IHZhbHVlID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7ZWx9L2F0dHJpYnV0ZS8ke2F0dHJpYnV0ZX1gLCAnR0VUJyk7XG4gIC8vIFRyYW5zZm9ybSB0aGUgcmVzdWx0IGZvciB0aGUgY2FzZSB3aGVuIFdEQSByZXR1cm5zIGFuIGludGVnZXIgcmVwcmVzZW50YXRpb24gZm9yIGEgYm9vbGVhbiB2YWx1ZVxuICBpZiAoWzAsIDFdLmluY2x1ZGVzKHZhbHVlKSkge1xuICAgIHZhbHVlID0gISF2YWx1ZTtcbiAgfVxuICAvLyBUaGUgcmV0dXJuZWQgdmFsdWUgbXVzdCBiZSBvZiB0eXBlIHN0cmluZyBhY2NvcmRpbmcgdG8gaHR0cHM6Ly93d3cudzMub3JnL1RSL3dlYmRyaXZlci8jZ2V0LWVsZW1lbnQtYXR0cmlidXRlXG4gIHJldHVybiAoXy5pc051bGwodmFsdWUpIHx8IF8uaXNTdHJpbmcodmFsdWUpKSA/IHZhbHVlIDogSlNPTi5zdHJpbmdpZnkodmFsdWUpO1xufTtcblxuY29tbWFuZHMuZ2V0QXR0cmlidXRlID0gYXN5bmMgZnVuY3Rpb24gZ2V0QXR0cmlidXRlIChhdHRyaWJ1dGUsIGVsKSB7XG4gIGVsID0gdXRpbC51bndyYXBFbGVtZW50KGVsKTtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0TmF0aXZlQXR0cmlidXRlKGF0dHJpYnV0ZSwgZWwpO1xuICB9XG4gIGNvbnN0IGF0b21zRWxlbWVudCA9IHRoaXMuZ2V0QXRvbXNFbGVtZW50KGVsKTtcbiAgaWYgKF8uaXNOdWxsKGF0b21zRWxlbWVudCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgRXJyb3IgY29udmVydGluZyBlbGVtZW50IElEIGZvciB1c2luZyBpbiBXRCBhdG9tczogJyR7ZWx9YCk7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF9hdHRyaWJ1dGVfdmFsdWUnLCBbYXRvbXNFbGVtZW50LCBhdHRyaWJ1dGVdKTtcbn07XG5cbmNvbW1hbmRzLmdldFRleHQgPSBhc3luYyBmdW5jdGlvbiBnZXRUZXh0IChlbCkge1xuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChgL2VsZW1lbnQvJHtlbH0vdGV4dGAsICdHRVQnKTtcbiAgfVxuICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3RleHQnLCBbYXRvbXNFbGVtZW50XSk7XG59O1xuXG5jb21tYW5kcy5nZXRFbGVtZW50UmVjdCA9IGFzeW5jIGZ1bmN0aW9uIGdldEVsZW1lbnRSZWN0IChlbCkge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIC8vIE1vYmlsZSBzYWZhcmkgZG9lc24ndCBzdXBwb3J0IHJlY3RcbiAgICBjb25zdCB7eCwgeX0gPSBhd2FpdCB0aGlzLmdldExvY2F0aW9uKGVsKTtcbiAgICBjb25zdCB7d2lkdGgsIGhlaWdodH0gPSBhd2FpdCB0aGlzLmdldFNpemUoZWwpO1xuICAgIHJldHVybiB7eCwgeSwgd2lkdGgsIGhlaWdodH07XG4gIH1cblxuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIHJldHVybiBhd2FpdCB0aGlzLmdldE5hdGl2ZVJlY3QoZWwpO1xufTtcblxuZXh0ZW5zaW9ucy5nZXROYXRpdmVSZWN0ID0gYXN5bmMgZnVuY3Rpb24gZ2V0TmF0aXZlUmVjdCAoZWwpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke2VsfS9yZWN0YCwgJ0dFVCcpO1xufTtcblxuY29tbWFuZHMuZ2V0TG9jYXRpb24gPSBhc3luYyBmdW5jdGlvbiBnZXRMb2NhdGlvbiAoZWwpIHtcbiAgZWwgPSB1dGlsLnVud3JhcEVsZW1lbnQoZWwpO1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGNvbnN0IGF0b21zRWxlbWVudCA9IGF3YWl0IHRoaXMudXNlQXRvbXNFbGVtZW50KGVsKTtcbiAgICBsZXQgbG9jID0gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3RvcF9sZWZ0X2Nvb3JkaW5hdGVzJywgW2F0b21zRWxlbWVudF0pO1xuICAgIGlmICh0aGlzLm9wdHMuYWJzb2x1dGVXZWJMb2NhdGlvbnMpIHtcbiAgICAgIGNvbnN0IHNjcmlwdCA9ICdyZXR1cm4gW2RvY3VtZW50LmJvZHkuc2Nyb2xsTGVmdCwgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3BdOyc7XG4gICAgICBjb25zdCBbeE9mZnNldCwgeU9mZnNldF0gPSBhd2FpdCB0aGlzLmV4ZWN1dGUoc2NyaXB0KTtcbiAgICAgIGxvYy54ICs9IHhPZmZzZXQ7XG4gICAgICBsb2MueSArPSB5T2Zmc2V0O1xuICAgIH1cbiAgICByZXR1cm4gbG9jO1xuICB9XG5cbiAgY29uc3QgcmVjdCA9IGF3YWl0IHRoaXMuZ2V0RWxlbWVudFJlY3QoZWwpO1xuICByZXR1cm4ge3g6IHJlY3QueCwgeTogcmVjdC55fTtcbn07XG5cbmNvbW1hbmRzLmdldExvY2F0aW9uSW5WaWV3ID0gYXN5bmMgZnVuY3Rpb24gZ2V0TG9jYXRpb25JblZpZXcgKGVsKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLmdldExvY2F0aW9uKGVsKTtcbn07XG5cbmNvbW1hbmRzLmdldFNpemUgPSBhc3luYyBmdW5jdGlvbiBnZXRTaXplIChlbCkge1xuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgbGV0IGF0b21zRWxlbWVudCA9IHRoaXMuZ2V0QXRvbXNFbGVtZW50KGVsKTtcbiAgICBpZiAoYXRvbXNFbGVtZW50ID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgRXJyb3IgY29udmVydGluZyBlbGVtZW50IElEIGZvciB1c2luZyBpbiBXRCBhdG9tczogJyR7ZWx9J2ApO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3NpemUnLCBbYXRvbXNFbGVtZW50XSk7XG4gIH1cblxuICBjb25zdCByZWN0ID0gYXdhaXQgdGhpcy5nZXRFbGVtZW50UmVjdChlbCk7XG4gIHJldHVybiB7d2lkdGg6IHJlY3Qud2lkdGgsIGhlaWdodDogcmVjdC5oZWlnaHR9O1xufTtcblxuZnVuY3Rpb24gaGFzU3BlY2lhbEtleXMgKGtleXMpIHtcbiAgZm9yIChsZXQgY2hhciBvZiBrZXlzKSB7XG4gICAgaWYgKGlzU3BlY2lhbEtleShjaGFyKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gaXNTcGVjaWFsS2V5IChrKSB7XG4gIGlmIChrID09PSAnXFx1RTAwMycgfHwgayA9PT0gJ1xcdWUwMTcnKSB7IC8vIEJBQ0tTUEFDRSBvciBERUxFVEVcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBlbHNlIGlmIChrID09PSAnXFx1RTAwNicgfHwgayA9PT0gJ1xcdUUwMDcnKSB7IC8vIFJFVFVSTiBvciBFTlRFUlxuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gdHJhbnNsYXRlS2V5IChrKSB7XG4gIGlmIChrID09PSAnXFx1RTAwNicgfHwgayA9PT0gJ1xcdUUwMDcnKSB7IC8vIFJFVFVSTiBvciBFTlRFUlxuICAgIHJldHVybiAnXFxuJztcbiAgfSBlbHNlIGlmIChrID09PSAnXFx1RTAwMycgfHwgayA9PT0gJ1xcdWUwMTcnKSB7IC8vIEJBQ0tTUEFDRSBvciBERUxFVEVcbiAgICByZXR1cm4gJ1xcYic7XG4gIH1cbiAgcmV0dXJuIGs7XG59XG5cbmV4dGVuc2lvbnMuYnJpbmdVcEtleWJvYXJkID0gYXN5bmMgZnVuY3Rpb24gYnJpbmdVcEtleWJvYXJkIChlbGVtZW50KSB7XG4gIC8vIHNvbWV0aW1lcyBpbnB1dCBpcyBhdHRlbXB0ZWQgYmVmb3JlIHdlIGhhdmUgYSBrZXlib2FyZC4gVHJ5IHRvIGJyaW5nIG9uZSB1cFxuICAvLyBidXQgd2Ugd2FudCB0byBoYW5kbGUgdGhlIHJldHJpZXMgb24gZmluZFxuICBsZXQgaW1wbGljaXRXYWl0TXMgPSB0aGlzLmltcGxpY2l0V2FpdE1zO1xuICBhd2FpdCB0aGlzLnNldEltcGxpY2l0V2FpdCgwKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCByZXRyeUludGVydmFsKDEwLCAxMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2NsYXNzIG5hbWUnLCAnWENVSUVsZW1lbnRUeXBlS2V5Ym9hcmQnLCBmYWxzZSk7XG4gICAgICAgIGxvZy5kZWJ1ZygnS2V5Ym9hcmQgZm91bmQuIENvbnRpbnVpbmcgd2l0aCB0ZXh0IGlucHV0LicpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIC8vIG5vIGtleWJvYXJkIGZvdW5kXG4gICAgICAgIGxvZy5kZWJ1ZygnTm8ga2V5Ym9hcmQgZm91bmQuIENsaWNraW5nIGVsZW1lbnQgdG8gb3BlbiBpdC4nKTtcbiAgICAgICAgYXdhaXQgdGhpcy5uYXRpdmVDbGljayhlbGVtZW50KTtcblxuICAgICAgICBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnY2xhc3MgbmFtZScsICdYQ1VJRWxlbWVudFR5cGVLZXlib2FyZCcsIGZhbHNlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSBmaW5hbGx5IHtcbiAgICAvLyBubyBtYXR0ZXIgd2hhdCB3ZSBkbywgbWFrZSBzdXJlIHdlIGhhdmUgdGhlIGltcGxpY2l0IHdhaXQgc2V0IHVwIGNvcnJlY3RseVxuICAgIGF3YWl0IHRoaXMuc2V0SW1wbGljaXRXYWl0KGltcGxpY2l0V2FpdE1zKTtcbiAgfVxufTtcblxuY29tbWFuZHMuc2V0VmFsdWVJbW1lZGlhdGUgPSBhc3luYyBmdW5jdGlvbiBzZXRWYWx1ZUltbWVkaWF0ZSAodmFsdWUsIGVsKSB7XG4gIC8vIFdEQSBkb2VzIG5vdCBwcm92aWRlIG5vIHdheSB0byBzZXQgdGhlIHZhbHVlIGRpcmVjdGx5XG4gIGxvZy5pbmZvKCdUaGVyZSBpcyBjdXJyZW50bHkgbm8gd2F5IHRvIGJ5cGFzcyB0eXBpbmcgdXNpbmcgWENVSVRlc3QuIFNldHRpbmcgdmFsdWUgdGhyb3VnaCBrZXlib2FyZCcpO1xuICBhd2FpdCB0aGlzLnNldFZhbHVlKHZhbHVlLCBlbCk7XG59O1xuXG5jb21tYW5kcy5zZXRWYWx1ZSA9IGFzeW5jIGZ1bmN0aW9uIHNldFZhbHVlICh2YWx1ZSwgZWwpIHtcbiAgZWwgPSB1dGlsLnVud3JhcEVsZW1lbnQoZWwpO1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBhdG9tc0VsZW1lbnQgPSB0aGlzLnVzZUF0b21zRWxlbWVudChlbCk7XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnY2xpY2snLCBbYXRvbXNFbGVtZW50XSk7XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgndHlwZScsIFthdG9tc0VsZW1lbnQsIHZhbHVlXSk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgc2V0Rm9ybWF0dGVkVmFsdWUgPSBhc3luYyAoaW5wdXQsIGlzS2V5Ym9hcmRQcmVzZW5jZUNoZWNrRW5hYmxlZCkgPT4ge1xuICAgICAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gJ3N0cmluZycgJiYgIShpbnB1dCBpbnN0YW5jZW9mIEFycmF5KSkge1xuICAgICAgICBpbnB1dCA9IGlucHV0LnRvU3RyaW5nKCkuc3BsaXQoJycpO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7ZWx9L3ZhbHVlYCwgJ1BPU1QnLCB7dmFsdWU6IGlucHV0fSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLy8gbWFrZSBzdXJlIHRoZXJlIGlzIGEga2V5Ym9hcmQgaWYgdGhpcyBpcyBhIHRleHQgZmllbGRcbiAgICAgICAgaWYgKGlzS2V5Ym9hcmRQcmVzZW5jZUNoZWNrRW5hYmxlZCAmJiBhd2FpdCB0aGlzLmdldEF0dHJpYnV0ZSgndHlwZScsIGVsKSA9PT0gJ1hDVUlFbGVtZW50VHlwZVRleHRGaWVsZCcpIHtcbiAgICAgICAgICBsb2cuaW5mbyhgQ2Fubm90IHR5cGUgaW4gdGhlIHRleHQgZmllbGQgYmVjYXVzZSBvZiAke2Vycn0uXFxuVHJ5aW5nIHRvIGFwcGx5IGEgd29ya2Fyb3VuZC4uLmApO1xuICAgICAgICAgIGF3YWl0IHRoaXMuYnJpbmdVcEtleWJvYXJkKGVsKTtcbiAgICAgICAgICBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChgL2VsZW1lbnQvJHtlbH0vdmFsdWVgLCAnUE9TVCcsIHt2YWx1ZTogaW5wdXR9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgLy8gcG9zc2libGUgdmFsdWVzIG9mIGB2YWx1ZWA6XG4gICAgLy8gICBbJ3NvbWUgdGV4dCddXG4gICAgLy8gICBbJ3MnLCAnbycsICdtJywgJ2UnLCAnICcsICd0JywgJ2UnLCAneCcsICd0J11cbiAgICAvLyAgICdzb21lIHRleHQnXG4gICAgaWYgKF8uaXNOdWxsKHZhbHVlKSB8fCBfLmlzVW5kZWZpbmVkKHZhbHVlKSB8fCBfLmlzUGxhaW5PYmplY3QodmFsdWUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE9ubHkgc3RyaW5ncyBhbmQgYXJyYXlzIG9mIHN0cmluZ3MgYXJlIHN1cHBvcnRlZCBhcyBpbnB1dCBhcmd1bWVudHMuIFJlY2VpdmVkOiAnJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9J2ApO1xuICAgIH1cbiAgICBpZiAoXy5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgLy8gbWFrZSBzdXJlIHRoYXQgYWxsIHRoZSBzdHJpbmdzIGluc2lkZSBhcmUgYSBzaW5nbGUgY2hhcmFjdGVyIGxvbmdcbiAgICAgIHZhbHVlID0gXy5mbGF0TWFwKHZhbHVlLCAodikgPT4gKF8uaXNTdHJpbmcodikgPyB2IDogSlNPTi5zdHJpbmdpZnkodikpLnNwbGl0KCcnKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIG1ha2UgaXQgaW50byBhbiBhcnJheSBvZiBjaGFyYWN0ZXJzXG4gICAgICB2YWx1ZSA9ICh2YWx1ZSB8fCAnJykudG9TdHJpbmcoKS5zcGxpdCgnJyk7XG4gICAgfVxuXG4gICAgaWYgKCFoYXNTcGVjaWFsS2V5cyh2YWx1ZSkpIHtcbiAgICAgIC8vIG5vdGhpbmcgc3BlY2lhbCwgc28ganVzdCBzZW5kIGl0IGluXG4gICAgICBhd2FpdCBzZXRGb3JtYXR0ZWRWYWx1ZSh2YWx1ZSwgdHJ1ZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gaWYgdGhlcmUgYXJlIHNwZWNpYWwgY2hhcmFjdGVycywgZ28gdGhyb3VnaCB0aGUgdmFsdWUgdW50aWwgd2UgZ2V0IHRvIG9uZSxcbiAgICAvLyBhbmQgdGhlbiBwcmludCBpdCBpbmRpdmlkdWFsbHlcbiAgICAvLyBjdXJyZW50bHkgb25seSBzdXBwb3J0aW5nIHJldHVybiwgZW50ZXIsIGJhY2tzcGFjZSwgYW5kIGRlbGV0ZVxuICAgIGxldCBidWZmZXIgPSBbXTtcbiAgICBsZXQgaXNGaXJzdENoYXIgPSB0cnVlO1xuICAgIGZvciAobGV0IGsgb2YgdmFsdWUpIHtcbiAgICAgIGxldCBjaGFyID0gdHJhbnNsYXRlS2V5KGspO1xuXG4gICAgICBpZiAoY2hhciA9PT0gaykge1xuICAgICAgICBidWZmZXIucHVzaChjaGFyKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIC8vIHdyaXRlIGFuZCBjbGVhciB0aGUgYnVmZmVyXG4gICAgICBhd2FpdCBzZXRGb3JtYXR0ZWRWYWx1ZShidWZmZXIsIGlzRmlyc3RDaGFyKTtcbiAgICAgIGlzRmlyc3RDaGFyID0gZmFsc2U7XG4gICAgICBidWZmZXIgPSBbXTtcblxuICAgICAgLy8gd3JpdGUgdGhlIGNoYXJhY3RlclxuICAgICAgYXdhaXQgc2V0Rm9ybWF0dGVkVmFsdWUoW2NoYXJdLCBpc0ZpcnN0Q2hhcik7XG4gICAgfVxuICAgIC8vIGZpbmFsbHksIHNlbmQgYW55dGhpbmcgdGhhdCBtaWdodCBiZSBsZWZ0XG4gICAgaWYgKGJ1ZmZlci5sZW5ndGgpIHtcbiAgICAgIGF3YWl0IHNldEZvcm1hdHRlZFZhbHVlKGJ1ZmZlciwgZmFsc2UpO1xuICAgIH1cbiAgfVxufTtcblxuY29tbWFuZHMua2V5cyA9IGFzeW5jIGZ1bmN0aW9uIGtleXMgKHZhbHVlKSB7XG4gIGlmIChfLmlzQXJyYXkodmFsdWUpKSB7XG4gICAgLy8gY29uY2F0ZW5hdGUgYW55IGluZGl2aWR1YWwgc3RyaW5nc1xuICAgIHZhbHVlID0gdmFsdWUuam9pbignJyk7XG4gIH1cbiAgaWYgKF8uaXNTdHJpbmcodmFsdWUpKSB7XG4gICAgLy8gc3BsaXQgaW50byBjb21wb25lbnQgY2hhcmFjdGVyc1xuICAgIHZhbHVlID0gdmFsdWUuc3BsaXQoJycpO1xuICB9XG5cbiAgbGV0IGJ1ZmZlciA9IFtdO1xuICBmb3IgKGxldCBrIG9mIHZhbHVlKSB7XG4gICAgbGV0IGNoYXIgPSB0cmFuc2xhdGVLZXkoayk7XG5cbiAgICBidWZmZXIucHVzaChjaGFyKTtcbiAgfVxuICBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS9rZXlzJywgJ1BPU1QnLCB7dmFsdWU6IGJ1ZmZlcn0pO1xufTtcblxuY29tbWFuZHMuY2xlYXIgPSBhc3luYyBmdW5jdGlvbiBjbGVhciAoZWwpIHtcbiAgZWwgPSB1dGlsLnVud3JhcEVsZW1lbnQoZWwpO1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBhdG9tc0VsZW1lbnQgPSB0aGlzLnVzZUF0b21zRWxlbWVudChlbCk7XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnY2xlYXInLCBbYXRvbXNFbGVtZW50XSk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGF3YWl0IHJldHJ5KDUsIHRoaXMucHJveHlDb21tYW5kLmJpbmQodGhpcyksIGAvZWxlbWVudC8ke2VsfS9jbGVhcmAsICdQT1NUJyk7XG59O1xuXG5jb21tYW5kcy5nZXRDb250ZW50U2l6ZSA9IGFzeW5jIGZ1bmN0aW9uIGdldENvbnRlbnRTaXplIChlbCkge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcignU3VwcG9ydCBmb3IgZ2V0Q29udGVudFNpemUgZm9yIHdlYiBjb250ZXh0IGlzIG5vdCB5ZXQgaW1wbGVtZW50ZWQuIFBsZWFzZSBjb250YWN0IGFuIEFwcGl1bSBkZXYnKTtcbiAgfVxuXG4gIGNvbnN0IHR5cGUgPSBhd2FpdCB0aGlzLmdldEF0dHJpYnV0ZSgndHlwZScsIGVsKTtcblxuICBpZiAodHlwZSAhPT0gJ1hDVUlFbGVtZW50VHlwZVRhYmxlJyAmJlxuICAgICAgdHlwZSAhPT0gJ1hDVUlFbGVtZW50VHlwZUNvbGxlY3Rpb25WaWV3Jykge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2FuJ3QgZ2V0IGNvbnRlbnQgc2l6ZSBmb3IgdHlwZSAnJHt0eXBlfScsIG9ubHkgZm9yIGAgK1xuICAgICAgICAgICAgICAgICAgICBgdGFibGVzIGFuZCBjb2xsZWN0aW9uIHZpZXdzYCk7XG4gIH1cbiAgbGV0IGxvY2F0b3IgPSAnKic7XG4gIGlmICh0eXBlID09PSAnWENVSUVsZW1lbnRUeXBlVGFibGUnKSB7XG4gICAgLy8gb25seSBmaW5kIHRhYmxlIGNlbGxzLCBub3QganVzdCBhbnkgY2hpbGRyZW5cbiAgICBsb2NhdG9yID0gJ1hDVUlFbGVtZW50VHlwZUNlbGwnO1xuICB9XG5cbiAgbGV0IGNvbnRlbnRIZWlnaHQgPSAwO1xuICBjb25zdCBjaGlsZHJlbiA9IGF3YWl0IHRoaXMuZmluZEVsT3JFbHMoYGNsYXNzIGNoYWluYCwgbG9jYXRvciwgdHJ1ZSwgZWwpO1xuICBpZiAoY2hpbGRyZW4ubGVuZ3RoID09PSAxKSB7XG4gICAgLy8gaWYgd2Uga25vdyB0aGVyZSdzIG9ubHkgb25lIGVsZW1lbnQsIHdlIGNhbiBvcHRpbWl6ZSB0byBtYWtlIGp1c3Qgb25lXG4gICAgLy8gY2FsbCB0byBXREFcbiAgICBjb25zdCByZWN0ID0gYXdhaXQgdGhpcy5nZXRFbGVtZW50UmVjdChfLmhlYWQoY2hpbGRyZW4pKTtcbiAgICBjb250ZW50SGVpZ2h0ID0gcmVjdC5oZWlnaHQ7XG4gIH0gZWxzZSBpZiAoY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgLy8gb3RoZXJ3aXNlIGlmIHdlIGhhdmUgbXVsdGlwbGUgZWxlbWVudHMsIGxvZ2ljIGRpZmZlcnMgYmFzZWQgb24gZWxlbWVudFxuICAgIC8vIHR5cGVcbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgJ1hDVUlFbGVtZW50VHlwZVRhYmxlJzoge1xuICAgICAgICBjb25zdCBmaXJzdFJlY3QgPSBhd2FpdCB0aGlzLmdldEVsZW1lbnRSZWN0KF8uaGVhZChjaGlsZHJlbikpO1xuICAgICAgICBjb25zdCBsYXN0UmVjdCA9IGF3YWl0IHRoaXMuZ2V0RWxlbWVudFJlY3QoXy5sYXN0KGNoaWxkcmVuKSk7XG4gICAgICAgIGNvbnRlbnRIZWlnaHQgPSBsYXN0UmVjdC55ICsgbGFzdFJlY3QuaGVpZ2h0IC0gZmlyc3RSZWN0Lnk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSAnWENVSUVsZW1lbnRUeXBlQ29sbGVjdGlvblZpZXcnOiB7XG4gICAgICAgIGxldCBlbHNJblJvdyA9IDE7IC8vIHdlIGtub3cgdGhlcmUgbXVzdCBiZSBhdCBsZWFzdCBvbmUgZWxlbWVudCBpbiB0aGUgcm93XG4gICAgICAgIGxldCBmaXJzdFJlY3QgPSBhd2FpdCB0aGlzLmdldEVsZW1lbnRSZWN0KF8uaGVhZChjaGlsZHJlbikpO1xuICAgICAgICBsZXQgaW5pdGlhbFJlY3RzID0gW2ZpcnN0UmVjdF07XG4gICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBjb25zdCByZWN0ID0gYXdhaXQgdGhpcy5nZXRFbGVtZW50UmVjdChjaGlsZHJlbltpXSk7XG4gICAgICAgICAgaW5pdGlhbFJlY3RzLnB1c2gocmVjdCk7XG4gICAgICAgICAgaWYgKHJlY3QueSAhPT0gZmlyc3RSZWN0LnkpIHtcbiAgICAgICAgICAgIGVsc0luUm93ID0gaTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzcGFjZUJldHdlZW5FbHMgPSBpbml0aWFsUmVjdHNbZWxzSW5Sb3ddLnkgLSBpbml0aWFsUmVjdHNbZWxzSW5Sb3cgLSAxXS55IC0gaW5pdGlhbFJlY3RzW2Vsc0luUm93IC0gMV0uaGVpZ2h0O1xuICAgICAgICBjb25zdCBudW1Sb3dzID0gTWF0aC5jZWlsKGNoaWxkcmVuLmxlbmd0aCAvIGVsc0luUm93KTtcblxuICAgICAgICAvLyBhc3N1bWUgYWxsIGNlbGxzIGFyZSB0aGUgc2FtZSBoZWlnaHRcbiAgICAgICAgY29udGVudEhlaWdodCA9IChudW1Sb3dzICogZmlyc3RSZWN0LmhlaWdodCkgKyAoc3BhY2VCZXR3ZWVuRWxzICogKG51bVJvd3MgLSAxKSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgZGVmYXVsdDogdGhyb3cgbmV3IEVycm9yKGBQcm9ncmFtbWluZyBlcnJvcjogdHlwZSAnJHt0eXBlfScgd2FzIG5vdCBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgdmFsaWQgYnV0IHNob3VsZCBoYXZlIGFscmVhZHkgYmVlbiByZWplY3RlZGApO1xuICAgIH1cbiAgfVxuICBjb25zdCBzaXplID0gYXdhaXQgdGhpcy5nZXRTaXplKGVsKTtcbiAgY29uc3Qgb3JpZ2luID0gYXdhaXQgdGhpcy5nZXRMb2NhdGlvbkluVmlldyhlbCk7XG4gIC8vIGF0dHJpYnV0ZXMgaGF2ZSB0byBiZSBzdHJpbmdzLCBzbyBzdHJpbmdpZnkgdGhpcyB1cFxuICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoe1xuICAgIHdpZHRoOiBzaXplLndpZHRoLFxuICAgIGhlaWdodDogc2l6ZS5oZWlnaHQsXG4gICAgdG9wOiBvcmlnaW4ueSxcbiAgICBsZWZ0OiBvcmlnaW4ueCxcbiAgICBzY3JvbGxhYmxlT2Zmc2V0OiBjb250ZW50SGVpZ2h0XG4gIH0pO1xufTtcblxuY29tbWFuZHMuaXNLZXlib2FyZFNob3duID0gYXN5bmMgZnVuY3Rpb24gaXNLZXlib2FyZFNob3duICgpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnY2xhc3MgbmFtZScsICdYQ1VJRWxlbWVudFR5cGVLZXlib2FyZCcsIGZhbHNlKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBjYXRjaCAoaWduKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzKTtcbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvZWxlbWVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getAvailableBundleIds = getAvailableBundleIds;
exports.parseContainerPath = parseContainerPath;
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _appiumIosDriver = require("appium-ios-driver");

var _logger = _interopRequireDefault(require("../logger"));

var _teen_process = require("teen_process");

var _nodeSimctl = require("node-simctl");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumIosDevice = require("appium-ios-device");

const CONTAINER_PATH_MARKER = '@';
const CONTAINER_PATH_PATTERN = new RegExp(`^${CONTAINER_PATH_MARKER}([^/]+)/(.*)`);
const CONTAINER_TYPE_SEPARATOR = ':';
const IFUSE_CONTAINER_DOCUMENTS = 'documents';
const CONTAINER_DOCUMENTS_PATH = 'Documents';
const IO_TIMEOUT = 30000;
const OBJECT_NOT_FOUND_ERROR_MESSAGE = 'OBJECT_NOT_FOUND';
let commands = _appiumIosDriver.iosCommands.file;
exports.commands = commands;

function verifyIsSubPath(originalPath, root) {
  const normalizedRoot = _path.default.normalize(root);

  const normalizedPath = _path.default.normalize(_path.default.dirname(originalPath));

  if (normalizedRoot !== originalPath && !normalizedPath.startsWith(normalizedRoot)) {
    _logger.default.errorAndThrow(`'${normalizedPath}' is expected to be a subpath of '${normalizedRoot}'`);
  }
}

async function createAfcClient(udid, bundleId, containerType) {
  if (!bundleId) {
    return await _appiumIosDevice.services.startAfcService(udid);
  }

  const service = await _appiumIosDevice.services.startHouseArrestService(udid);

  if (isDocuments(containerType)) {
    return await service.vendDocuments(bundleId);
  } else {
    return await service.vendContainer(bundleId);
  }
}

function isDocuments(containerType) {
  return _lodash.default.toLower(containerType) === IFUSE_CONTAINER_DOCUMENTS;
}

async function mkdirpDevice(service, dir) {
  if (dir === '.' || dir === '/') {
    return;
  }

  try {
    await service.listDirectory(dir);
    return;
  } catch (e) {
    await mkdirpDevice(service, _path.default.dirname(dir));
  }

  await service.createDirectory(dir);
}

async function createService(udid, remotePath) {
  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const {
      bundleId,
      pathInContainer,
      containerType
    } = await parseContainerPath(remotePath);
    const service = await createAfcClient(udid, bundleId, containerType);
    const relativePath = isDocuments(containerType) ? _path.default.join(CONTAINER_DOCUMENTS_PATH, pathInContainer) : pathInContainer;
    return {
      service,
      relativePath
    };
  } else {
    const service = await createAfcClient(udid);
    const relativePath = remotePath;
    return {
      service,
      relativePath
    };
  }
}

async function pullFileFromRealDevice(service, relativePath) {
  const stream = await service.createReadStream(relativePath, {
    autoDestroy: true
  });
  const closeEvent = new _bluebird.default(resolve => stream.on('close', resolve)).timeout(IO_TIMEOUT);
  const buffer = [];
  stream.on('data', data => buffer.push(data));

  try {
    await closeEvent;
  } catch (e) {
    throw new Error(`Couldn't pull the file '${relativePath}' within the given timeout ${IO_TIMEOUT}ms`);
  }

  return Buffer.concat(buffer).toString('base64');
}

async function pullFolderFromRealDevice(service, relativePath) {
  const tmpFolder = await _appiumSupport.tempDir.openDir();

  try {
    const folderPath = _path.default.join(tmpFolder, relativePath);

    await (0, _appiumSupport.mkdirp)(folderPath);
    const promises = [];
    await service.walkDir(relativePath, true, async (itemPath, isDir) => {
      const pathOnServer = _path.default.join(tmpFolder, itemPath);

      if (isDir) {
        await _appiumSupport.fs.mkdir(pathOnServer);
      } else {
        const readStream = await service.createReadStream(itemPath, {
          autoDestroy: true
        });

        const writeStream = _appiumSupport.fs.createWriteStream(pathOnServer, {
          autoClose: true
        });

        promises.push(new _bluebird.default(resolve => writeStream.on('close', resolve)));
        readStream.pipe(writeStream);
      }
    });

    try {
      await _bluebird.default.all(promises).timeout(IO_TIMEOUT);
    } catch (e) {
      throw new Error(`Couldn't pull all items in the folder '${relativePath}' within the given timeout ${IO_TIMEOUT}ms`);
    }

    return Buffer.from((await _appiumSupport.zip.toInMemoryZip(folderPath))).toString('base64');
  } finally {
    await _appiumSupport.fs.rimraf(tmpFolder);
  }
}

async function parseContainerPath(remotePath, containerRootSupplier) {
  const match = CONTAINER_PATH_PATTERN.exec(remotePath);

  if (!match) {
    _logger.default.errorAndThrow(`It is expected that package identifier ` + `starts with '${CONTAINER_PATH_MARKER}' and is separated from the ` + `relative path with a single slash. '${remotePath}' is given instead`);
  }

  let [, bundleId, relativePath] = match;
  let containerType = null;
  const typeSeparatorPos = bundleId.indexOf(CONTAINER_TYPE_SEPARATOR);

  if (typeSeparatorPos > 0 && typeSeparatorPos < bundleId.length - 1) {
    containerType = bundleId.substring(typeSeparatorPos + 1);

    _logger.default.debug(`Parsed container type: ${containerType}`);

    bundleId = bundleId.substring(0, typeSeparatorPos);
  }

  if (_lodash.default.isNil(containerRootSupplier)) {
    const pathInContainer = relativePath;
    return {
      bundleId,
      pathInContainer,
      containerType
    };
  }

  const containerRoot = _lodash.default.isFunction(containerRootSupplier) ? await containerRootSupplier(bundleId, containerType) : containerRootSupplier;

  const pathInContainer = _path.default.posix.resolve(containerRoot, relativePath);

  verifyIsSubPath(pathInContainer, containerRoot);
  return {
    bundleId,
    pathInContainer,
    containerType
  };
}

async function pushFileToSimulator(device, remotePath, base64Data) {
  const buffer = Buffer.from(base64Data, 'base64');

  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const {
      bundleId,
      pathInContainer: dstPath
    } = await parseContainerPath(remotePath, async (appBundle, containerType) => await (0, _nodeSimctl.getAppContainer)(device.udid, appBundle, null, containerType));

    _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will put the data into '${dstPath}'`);

    if (!(await _appiumSupport.fs.exists(_path.default.dirname(dstPath)))) {
      _logger.default.debug(`The destination folder '${_path.default.dirname(dstPath)}' does not exist. Creating...`);

      await (0, _appiumSupport.mkdirp)(_path.default.dirname(dstPath));
    }

    await _appiumSupport.fs.writeFile(dstPath, buffer);
    return;
  }

  const dstFolder = await _appiumSupport.tempDir.openDir();

  const dstPath = _path.default.resolve(dstFolder, _path.default.basename(remotePath));

  try {
    await _appiumSupport.fs.writeFile(dstPath, buffer);
    await (0, _nodeSimctl.addMedia)(device.udid, dstPath);
  } finally {
    await _appiumSupport.fs.rimraf(dstFolder);
  }
}

async function pushFileToRealDevice(device, remotePath, base64Data) {
  const {
    service,
    relativePath
  } = await createService(device.udid, remotePath);

  try {
    await mkdirpDevice(service, _path.default.dirname(relativePath));
    const stream = await service.createWriteStream(relativePath, {
      autoClose: true
    });
    stream.write(Buffer.from(base64Data, 'base64'));
    const closeEvent = new _bluebird.default(resolve => stream.on('close', resolve)).timeout(IO_TIMEOUT);
    stream.destroy();

    try {
      await closeEvent;
    } catch (e) {
      throw new Error(`Couldnt push the file within the given timeout ${IO_TIMEOUT}ms`);
    }
  } finally {
    service.close();
  }
}

async function pullFromSimulator(device, remotePath, isFile) {
  let pathOnServer;

  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const {
      bundleId,
      pathInContainer: dstPath
    } = await parseContainerPath(remotePath, async (appBundle, containerType) => await (0, _nodeSimctl.getAppContainer)(device.udid, appBundle, null, containerType));

    _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will get the data from '${dstPath}'`);

    pathOnServer = dstPath;
  } else {
    const simRoot = device.getDir();
    pathOnServer = _path.default.posix.join(simRoot, remotePath);
    verifyIsSubPath(pathOnServer, simRoot);

    _logger.default.info(`Got the full item path: ${pathOnServer}`);
  }

  if (!(await _appiumSupport.fs.exists(pathOnServer))) {
    _logger.default.errorAndThrow(`The remote ${isFile ? 'file' : 'folder'} at '${pathOnServer}' does not exist`);
  }

  const buffer = isFile ? await _appiumSupport.fs.readFile(pathOnServer) : await _appiumSupport.zip.toInMemoryZip(pathOnServer);
  return Buffer.from(buffer).toString('base64');
}

async function pullFromRealDevice(device, remotePath, isFile) {
  const {
    service,
    relativePath
  } = await createService(device.udid, remotePath);

  try {
    const fileInfo = await service.getFileInfo(relativePath);

    if (isFile && fileInfo.isDirectory()) {
      throw new Error(`The requested path is not a file. Path: ${remotePath}`);
    }

    if (!isFile && !fileInfo.isDirectory()) {
      throw new Error(`The requested path is not a folder. Path: ${remotePath}`);
    }

    if (fileInfo.isFile()) {
      return await pullFileFromRealDevice(service, relativePath);
    } else {
      return await pullFolderFromRealDevice(service, relativePath);
    }
  } catch (e) {
    if (e.message.includes(OBJECT_NOT_FOUND_ERROR_MESSAGE)) {
      throw new Error(`Path '${remotePath}' doesn't exists on the device`);
    }

    throw e;
  } finally {
    service.close();
  }
}

async function getAvailableBundleIds(udid) {
  const service = await _appiumIosDevice.services.startInstallationProxyService(udid);

  try {
    const applications = await service.listApplications({
      applicationType: 'User'
    });
    const bundleIds = [];

    for (const [key, value] of Object.entries(applications)) {
      if (!value.UIFileSharingEnabled) {
        continue;
      }

      bundleIds.push(key);
    }

    return bundleIds;
  } finally {
    service.close();
  }
}

commands.pushFile = async function pushFile(remotePath, base64Data) {
  if (remotePath.endsWith('/')) {
    _logger.default.errorAndThrow(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }

  if (_lodash.default.isArray(base64Data)) {
    base64Data = Buffer.from(base64Data).toString('utf8');
  }

  return this.isSimulator() ? await pushFileToSimulator(this.opts.device, remotePath, base64Data) : await pushFileToRealDevice(this.opts.device, remotePath, base64Data);
};

commands.pullFile = async function pullFile(remotePath) {
  if (remotePath.endsWith('/')) {
    _logger.default.errorAndThrow(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }

  return this.isSimulator() ? await pullFromSimulator(this.opts.device, remotePath, true) : await pullFromRealDevice(this.opts.device, remotePath, true);
};

commands.getSimFileFullPath = async function getSimFileFullPath(remotePath) {
  let basePath = this.opts.device.getDir();
  let appName = null;

  if (this.opts.app) {
    let appNameRegex = new RegExp(`\\${_path.default.sep}([\\w-]+\\.app)`);
    let appNameMatches = appNameRegex.exec(this.opts.app);

    if (appNameMatches) {
      appName = appNameMatches[1];
    }
  }

  if (_appiumSupport.system.isWindows()) {
    if (remotePath.indexof('://') === 1) {
      remotePath = remotePath.slice(4);
    }
  } else {
    if (remotePath.indexOf('/') === 0) {
      remotePath = remotePath.slice(1);
    }
  }

  if (remotePath.startsWith(appName)) {
    let findPath = basePath;

    if (!this.opts.platformVersion || _appiumSupport.util.compareVersions(this.opts.platformVersion, '>=', '8.0')) {
      findPath = _path.default.resolve(basePath, 'Containers', 'Bundle');
    }

    findPath = findPath.replace(/\s/g, '\\ ');
    let {
      stdout
    } = await (0, _teen_process.exec)('find', [findPath, '-name', appName]);
    let appRoot = stdout.replace(/\n$/, '');
    let subPath = remotePath.substring(appName.length + 1);

    let fullPath = _path.default.resolve(appRoot, subPath);

    _logger.default.debug(`Finding app-relative file: '${fullPath}'`);

    return fullPath;
  }

  let fullPath = _path.default.resolve(basePath, remotePath);

  _logger.default.debug(`Finding sim-relative file: ${fullPath}`);

  return fullPath;
};

commands.pullFolder = async function pullFolder(remotePath) {
  if (!remotePath.endsWith('/')) {
    remotePath = `${remotePath}/`;
  }

  return this.isSimulator() ? await pullFromSimulator(this.opts.device, remotePath, false) : await pullFromRealDevice(this.opts.device, remotePath, false);
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maWxlLW1vdmVtZW50LmpzIl0sIm5hbWVzIjpbIkNPTlRBSU5FUl9QQVRIX01BUktFUiIsIkNPTlRBSU5FUl9QQVRIX1BBVFRFUk4iLCJSZWdFeHAiLCJDT05UQUlORVJfVFlQRV9TRVBBUkFUT1IiLCJJRlVTRV9DT05UQUlORVJfRE9DVU1FTlRTIiwiQ09OVEFJTkVSX0RPQ1VNRU5UU19QQVRIIiwiSU9fVElNRU9VVCIsIk9CSkVDVF9OT1RfRk9VTkRfRVJST1JfTUVTU0FHRSIsImNvbW1hbmRzIiwiaW9zQ29tbWFuZHMiLCJmaWxlIiwidmVyaWZ5SXNTdWJQYXRoIiwib3JpZ2luYWxQYXRoIiwicm9vdCIsIm5vcm1hbGl6ZWRSb290IiwicGF0aCIsIm5vcm1hbGl6ZSIsIm5vcm1hbGl6ZWRQYXRoIiwiZGlybmFtZSIsInN0YXJ0c1dpdGgiLCJsb2ciLCJlcnJvckFuZFRocm93IiwiY3JlYXRlQWZjQ2xpZW50IiwidWRpZCIsImJ1bmRsZUlkIiwiY29udGFpbmVyVHlwZSIsInNlcnZpY2VzIiwic3RhcnRBZmNTZXJ2aWNlIiwic2VydmljZSIsInN0YXJ0SG91c2VBcnJlc3RTZXJ2aWNlIiwiaXNEb2N1bWVudHMiLCJ2ZW5kRG9jdW1lbnRzIiwidmVuZENvbnRhaW5lciIsIl8iLCJ0b0xvd2VyIiwibWtkaXJwRGV2aWNlIiwiZGlyIiwibGlzdERpcmVjdG9yeSIsImUiLCJjcmVhdGVEaXJlY3RvcnkiLCJjcmVhdGVTZXJ2aWNlIiwicmVtb3RlUGF0aCIsInRlc3QiLCJwYXRoSW5Db250YWluZXIiLCJwYXJzZUNvbnRhaW5lclBhdGgiLCJyZWxhdGl2ZVBhdGgiLCJqb2luIiwicHVsbEZpbGVGcm9tUmVhbERldmljZSIsInN0cmVhbSIsImNyZWF0ZVJlYWRTdHJlYW0iLCJhdXRvRGVzdHJveSIsImNsb3NlRXZlbnQiLCJCIiwicmVzb2x2ZSIsIm9uIiwidGltZW91dCIsImJ1ZmZlciIsImRhdGEiLCJwdXNoIiwiRXJyb3IiLCJCdWZmZXIiLCJjb25jYXQiLCJ0b1N0cmluZyIsInB1bGxGb2xkZXJGcm9tUmVhbERldmljZSIsInRtcEZvbGRlciIsInRlbXBEaXIiLCJvcGVuRGlyIiwiZm9sZGVyUGF0aCIsInByb21pc2VzIiwid2Fsa0RpciIsIml0ZW1QYXRoIiwiaXNEaXIiLCJwYXRoT25TZXJ2ZXIiLCJmcyIsIm1rZGlyIiwicmVhZFN0cmVhbSIsIndyaXRlU3RyZWFtIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJhdXRvQ2xvc2UiLCJwaXBlIiwiYWxsIiwiZnJvbSIsInppcCIsInRvSW5NZW1vcnlaaXAiLCJyaW1yYWYiLCJjb250YWluZXJSb290U3VwcGxpZXIiLCJtYXRjaCIsImV4ZWMiLCJ0eXBlU2VwYXJhdG9yUG9zIiwiaW5kZXhPZiIsImxlbmd0aCIsInN1YnN0cmluZyIsImRlYnVnIiwiaXNOaWwiLCJjb250YWluZXJSb290IiwiaXNGdW5jdGlvbiIsInBvc2l4IiwicHVzaEZpbGVUb1NpbXVsYXRvciIsImRldmljZSIsImJhc2U2NERhdGEiLCJkc3RQYXRoIiwiYXBwQnVuZGxlIiwiaW5mbyIsImV4aXN0cyIsIndyaXRlRmlsZSIsImRzdEZvbGRlciIsImJhc2VuYW1lIiwicHVzaEZpbGVUb1JlYWxEZXZpY2UiLCJ3cml0ZSIsImRlc3Ryb3kiLCJjbG9zZSIsInB1bGxGcm9tU2ltdWxhdG9yIiwiaXNGaWxlIiwic2ltUm9vdCIsImdldERpciIsInJlYWRGaWxlIiwicHVsbEZyb21SZWFsRGV2aWNlIiwiZmlsZUluZm8iLCJnZXRGaWxlSW5mbyIsImlzRGlyZWN0b3J5IiwibWVzc2FnZSIsImluY2x1ZGVzIiwiZ2V0QXZhaWxhYmxlQnVuZGxlSWRzIiwic3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UiLCJhcHBsaWNhdGlvbnMiLCJsaXN0QXBwbGljYXRpb25zIiwiYXBwbGljYXRpb25UeXBlIiwiYnVuZGxlSWRzIiwia2V5IiwidmFsdWUiLCJPYmplY3QiLCJlbnRyaWVzIiwiVUlGaWxlU2hhcmluZ0VuYWJsZWQiLCJwdXNoRmlsZSIsImVuZHNXaXRoIiwiaXNBcnJheSIsImlzU2ltdWxhdG9yIiwib3B0cyIsInB1bGxGaWxlIiwiZ2V0U2ltRmlsZUZ1bGxQYXRoIiwiYmFzZVBhdGgiLCJhcHBOYW1lIiwiYXBwIiwiYXBwTmFtZVJlZ2V4Iiwic2VwIiwiYXBwTmFtZU1hdGNoZXMiLCJzeXN0ZW0iLCJpc1dpbmRvd3MiLCJpbmRleG9mIiwic2xpY2UiLCJmaW5kUGF0aCIsInBsYXRmb3JtVmVyc2lvbiIsInV0aWwiLCJjb21wYXJlVmVyc2lvbnMiLCJyZXBsYWNlIiwic3Rkb3V0IiwiYXBwUm9vdCIsInN1YlBhdGgiLCJmdWxsUGF0aCIsInB1bGxGb2xkZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxxQkFBcUIsR0FBRyxHQUE5QjtBQUVBLE1BQU1DLHNCQUFzQixHQUFHLElBQUlDLE1BQUosQ0FBWSxJQUFHRixxQkFBc0IsY0FBckMsQ0FBL0I7QUFDQSxNQUFNRyx3QkFBd0IsR0FBRyxHQUFqQztBQUNBLE1BQU1DLHlCQUF5QixHQUFHLFdBQWxDO0FBQ0EsTUFBTUMsd0JBQXdCLEdBQUcsV0FBakM7QUFDQSxNQUFNQyxVQUFVLEdBQUcsS0FBbkI7QUFDQSxNQUFNQyw4QkFBOEIsR0FBRyxrQkFBdkM7QUFFQSxJQUFJQyxRQUFRLEdBQUdDLDZCQUFZQyxJQUEzQjs7O0FBRUEsU0FBU0MsZUFBVCxDQUEwQkMsWUFBMUIsRUFBd0NDLElBQXhDLEVBQThDO0FBQzVDLFFBQU1DLGNBQWMsR0FBR0MsY0FBS0MsU0FBTCxDQUFlSCxJQUFmLENBQXZCOztBQUNBLFFBQU1JLGNBQWMsR0FBR0YsY0FBS0MsU0FBTCxDQUFlRCxjQUFLRyxPQUFMLENBQWFOLFlBQWIsQ0FBZixDQUF2Qjs7QUFFQSxNQUFJRSxjQUFjLEtBQUtGLFlBQW5CLElBQW1DLENBQUNLLGNBQWMsQ0FBQ0UsVUFBZixDQUEwQkwsY0FBMUIs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QWQ7QUFDQSxRQUFJRyxPQUFPLEdBQUdwSCxVQUFVLENBQUNrRCxTQUFYLENBQXFCa0QsT0FBTyxDQUFDbkQsTUFBUixHQUFpQixDQUF0QyxDQUFkOztBQUNBLFFBQUlvRSxRQUFRLEdBQUcvSSxjQUFLc0MsT0FBTCxDQUFhdUcsT0FBYixFQUFzQkMsT0FBdEIsQ0FBZjs7QUFDQXpJLG9CQUFJd0UsS0FBSixDQUFXLCtCQUE4QmtFLFFBQVMsR0FBbEQ7O0FBQ0EsV0FBT0EsUUFBUDtBQUNEOztBQUVELE1BQUlBLFFBQVEsR0FBRy9JLGNBQUtzQyxPQUFMLENBQWF1RixRQUFiLEVBQXVCbkcsVUFBdkIsQ0FBZjs7QUFDQXJCLGtCQUFJd0UsS0FBSixDQUFXLDhCQUE2QmtFLFFBQVMsRUFBakQ7O0FBQ0EsU0FBT0EsUUFBUDtBQUNELENBekNEOztBQTJDQXRKLFFBQVEsQ0FBQ3VKLFVBQVQsR0FBc0IsZUFBZUEsVUFBZixDQUEyQnRILFVBQTNCLEVBQXVDO0FBQzNELE1BQUksQ0FBQ0EsVUFBVSxDQUFDNkYsUUFBWCxDQUFvQixHQUFwQixDQUFMLEVBQStCO0FBQzdCN0YsSUFBQUEsVUFBVSxHQUFJLEdBQUVBLFVBQVcsR0FBM0I7QUFDRDs7QUFDRCxTQUFPLEtBQUsrRixXQUFMLEtBQ0gsTUFBTXpCLGlCQUFpQixDQUFDLEtBQUswQixJQUFMLENBQVV2QyxNQUFYLEVBQW1CekQsVUFBbkIsRUFBK0IsS0FBL0IsQ0FEcEIsR0FFSCxNQUFNMkUsa0JBQWtCLENBQUMsS0FBS3FCLElBQUwsQ0FBVXZDLE1BQVgsRUFBbUJ6RCxVQUFuQixFQUErQixLQUEvQixDQUY1QjtBQUdELENBUEQ7O2VBV2VqQyxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHN5c3RlbSwgZnMsIHRlbXBEaXIsIG1rZGlycCwgemlwLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBpb3NDb21tYW5kcyB9IGZyb20gJ2FwcGl1bS1pb3MtZHJpdmVyJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgYWRkTWVkaWEsIGdldEFwcENvbnRhaW5lciB9IGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IHNlcnZpY2VzIH0gZnJvbSAnYXBwaXVtLWlvcy1kZXZpY2UnO1xuXG5jb25zdCBDT05UQUlORVJfUEFUSF9NQVJLRVIgPSAnQCc7XG4vLyBodHRwczovL3JlZ2V4MTAxLmNvbS9yL1BMZEIwRy8yXG5jb25zdCBDT05UQUlORVJfUEFUSF9QQVRURVJOID0gbmV3IFJlZ0V4cChgXiR7Q09OVEFJTkVSX1BBVEhfTUFSS0VSfShbXi9dKykvKC4qKWApO1xuY29uc3QgQ09OVEFJTkVSX1RZUEVfU0VQQVJBVE9SID0gJzonO1xuY29uc3QgSUZVU0VfQ09OVEFJTkVSX0RPQ1VNRU5UUyA9ICdkb2N1bWVudHMnO1xuY29uc3QgQ09OVEFJTkVSX0RPQ1VNRU5UU19QQVRIID0gJ0RvY3VtZW50cyc7XG5jb25zdCBJT19USU1FT1VUID0gMzAwMDA7XG5jb25zdCBPQkpFQ1RfTk9UX0ZPVU5EX0VSUk9SX01FU1NBR0UgPSAnT0JKRUNUX05PVF9GT1VORCc7XG5cbmxldCBjb21tYW5kcyA9IGlvc0NvbW1hbmRzLmZpbGU7XG5cbmZ1bmN0aW9uIHZlcmlmeUlzU3ViUGF0aCAob3JpZ2luYWxQYXRoLCByb290KSB7XG4gIGNvbnN0IG5vcm1hbGl6ZWRSb290ID0gcGF0aC5ub3JtYWxpemUocm9vdCk7XG4gIGNvbnN0IG5vcm1hbGl6ZWRQYXRoID0gcGF0aC5ub3JtYWxpemUocGF0aC5kaXJuYW1lKG9yaWdpbmFsUGF0aCkpO1xuICAvLyBJZiBvcmlnaW5hbFBhdGggaXMgcm9vdCwgYC9gLCBvcmlnaW5hbFBhdGggc2hvdWxkIGVxdWFsIHRvIG5vcm1hbGl6ZWRSb290XG4gIGlmIChub3JtYWxpemVkUm9vdCAhPT0gb3JpZ2luYWxQYXRoICYmICFub3JtYWxpemVkUGF0aC5zdGFydHNXaXRoKG5vcm1hbGl6ZWRSb290KSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGAnJHtub3JtYWxpemVkUGF0aH0nIGlzIGV4cGVjdGVkIHRvIGJlIGEgc3VicGF0aCBvZiAnJHtub3JtYWxpemVkUm9vdH0nYCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlQWZjQ2xpZW50ICh1ZGlkLCBidW5kbGVJZCwgY29udGFpbmVyVHlwZSkge1xuICBpZiAoIWJ1bmRsZUlkKSB7XG4gICAgcmV0dXJuIGF3YWl0IHNlcnZpY2VzLnN0YXJ0QWZjU2VydmljZSh1ZGlkKTtcbiAgfVxuICBjb25zdCBzZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRIb3VzZUFycmVzdFNlcnZpY2UodWRpZCk7XG4gIGlmIChpc0RvY3VtZW50cyhjb250YWluZXJUeXBlKSkge1xuICAgIHJldHVybiBhd2FpdCBzZXJ2aWNlLnZlbmREb2N1bWVudHMoYnVuZGxlSWQpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCBzZXJ2aWNlLnZlbmRDb250YWluZXIoYnVuZGxlSWQpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzRG9jdW1lbnRzIChjb250YWluZXJUeXBlKSB7XG4gIHJldHVybiBfLnRvTG93ZXIoY29udGFpbmVyVHlwZSkgPT09IElGVVNFX0NPTlRBSU5FUl9ET0NVTUVOVFM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIG1rZGlycERldmljZSAoc2VydmljZSwgZGlyKSB7XG4gIGlmIChkaXIgPT09ICcuJyB8fCBkaXIgPT09ICcvJykge1xuICAgIHJldHVybjtcbiAgfVxuICB0cnkge1xuICAgIGF3YWl0IHNlcnZpY2UubGlzdERpcmVjdG9yeShkaXIpO1xuICAgIHJldHVybjtcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIFRoaXMgbWVhbnMgdGhhdCB0aGUgZGlyZWN0b3J5IGlzIG1pc3NpbmcgYW5kIHdlIGdvdCBhbiBvYmplY3Qgbm90IGZvdW5kIGVycm9yLiBUaGVyZWZvcmUsIHdlIGFyZSBnb2luZyB0byB0aGUgcGFyZW50XG4gICAgYXdhaXQgbWtkaXJwRGV2aWNlKHNlcnZpY2UsIHBhdGguZGlybmFtZShkaXIpKTtcbiAgfVxuICBhd2FpdCBzZXJ2aWNlLmNyZWF0ZURpcmVjdG9yeShkaXIpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVTZXJ2aWNlICh1ZGlkLCByZW1vdGVQYXRoKSB7XG4gIGlmIChDT05UQUlORVJfUEFUSF9QQVRURVJOLnRlc3QocmVtb3RlUGF0aCkpIHtcbiAgICBjb25zdCB7IGJ1bmRsZUlkLCBwYXRoSW5Db250YWluZXIsIGNvbnRhaW5lclR5cGUgfSA9IGF3YWl0IHBhcnNlQ29udGFpbmVyUGF0aChyZW1vdGVQYXRoKTtcbiAgICBjb25zdCBzZXJ2aWNlID0gYXdhaXQgY3JlYXRlQWZjQ2xpZW50KHVkaWQsIGJ1bmRsZUlkLCBjb250YWluZXJUeXBlKTtcbiAgICBjb25zdCByZWxhdGl2ZVBhdGggPSBpc0RvY3VtZW50cyhjb250YWluZXJUeXBlKSA/IHBhdGguam9pbihDT05UQUlORVJfRE9DVU1FTlRTX1BBVEgsIHBhdGhJbkNvbnRhaW5lcikgOiBwYXRoSW5Db250YWluZXI7XG4gICAgcmV0dXJuIHtzZXJ2aWNlLCByZWxhdGl2ZVBhdGh9O1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBjcmVhdGVBZmNDbGllbnQodWRpZCk7XG4gICAgY29uc3QgcmVsYXRpdmVQYXRoID0gcmVtb3RlUGF0aDtcbiAgICByZXR1cm4ge3NlcnZpY2UsIHJlbGF0aXZlUGF0aH07XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcHVsbEZpbGVGcm9tUmVhbERldmljZSAoc2VydmljZSwgcmVsYXRpdmVQYXRoKSB7XG4gIGNvbnN0IHN0cmVhbSA9IGF3YWl0IHNlcnZpY2UuY3JlYXRlUmVhZFN0cmVhbShyZWxhdGl2ZVBhdGgsIHsgYXV0b0Rlc3Ryb3k6IHRydWUgfSk7XG4gIGNvbnN0IGNsb3NlRXZlbnQgPSBuZXcgQigocmVzb2x2ZSkgPT4gc3RyZWFtLm9uKCdjbG9zZScsIHJlc29sdmUpKS50aW1lb3V0KElPX1RJTUVPVVQpO1xuICBjb25zdCBidWZmZXIgPSBbXTtcbiAgc3RyZWFtLm9uKCdkYXRhJywgKGRhdGEpID0+IGJ1ZmZlci5wdXNoKGRhdGEpKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBjbG9zZUV2ZW50O1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZG4ndCBwdWxsIHRoZSBmaWxlICcke3JlbGF0aXZlUGF0aH0nIHdpdGhpbiB0aGUgZ2l2ZW4gdGltZW91dCAke0lPX1RJTUVPVVR9bXNgKTtcbiAgfVxuICByZXR1cm4gQnVmZmVyLmNvbmNhdChidWZmZXIpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcHVsbEZvbGRlckZyb21SZWFsRGV2aWNlIChzZXJ2aWNlLCByZWxhdGl2ZVBhdGgpIHtcbiAgY29uc3QgdG1wRm9sZGVyID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gIHRyeSB7XG4gICAgY29uc3QgZm9sZGVyUGF0aCA9IHBhdGguam9pbih0bXBGb2xkZXIsIHJlbGF0aXZlUGF0aCk7XG4gICAgYXdhaXQgbWtkaXJwKGZvbGRlclBhdGgpO1xuICAgIGNvbnN0IHByb21pc2VzID0gW107XG4gICAgYXdhaXQgc2VydmljZS53YWxrRGlyKHJlbGF0aXZlUGF0aCwgdHJ1ZSwgYXN5bmMgKGl0ZW1QYXRoLCBpc0RpcikgPT4ge1xuICAgICAgY29uc3QgcGF0aE9uU2VydmVyID0gcGF0aC5qb2luKHRtcEZvbGRlciwgaXRlbVBhdGgpO1xuICAgICAgaWYgKGlzRGlyKSB7XG4gICAgICAgIGF3YWl0IGZzLm1rZGlyKHBhdGhPblNlcnZlcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCByZWFkU3RyZWFtID0gYXdhaXQgc2VydmljZS5jcmVhdGVSZWFkU3RyZWFtKGl0ZW1QYXRoLCB7YXV0b0Rlc3Ryb3k6IHRydWUgfSk7XG4gICAgICAgIGNvbnN0IHdyaXRlU3RyZWFtID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0ocGF0aE9uU2VydmVyLCB7YXV0b0Nsb3NlOiB0cnVlfSk7XG4gICAgICAgIHByb21pc2VzLnB1c2gobmV3IEIoKHJlc29sdmUpID0+IHdyaXRlU3RyZWFtLm9uKCdjbG9zZScsIHJlc29sdmUpKSk7XG4gICAgICAgIHJlYWRTdHJlYW0ucGlwZSh3cml0ZVN0cmVhbSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IEIuYWxsKHByb21pc2VzKS50aW1lb3V0KElPX1RJTUVPVVQpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGRuJ3QgcHVsbCBhbGwgaXRlbXMgaW4gdGhlIGZvbGRlciAnJHtyZWxhdGl2ZVBhdGh9JyB3aXRoaW4gdGhlIGdpdmVuIHRpbWVvdXQgJHtJT19USU1FT1VUfW1zYCk7XG4gICAgfVxuICAgIHJldHVybiBCdWZmZXIuZnJvbShhd2FpdCB6aXAudG9Jbk1lbW9yeVppcChmb2xkZXJQYXRoKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IGZzLnJpbXJhZih0bXBGb2xkZXIpO1xuICB9XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQ29udGFpbmVyT2JqZWN0XG4gKlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGJ1bmRsZUlkIC0gVGhlIHBhcnNlZCBidW5kbGUgaWRlbnRpZmllclxuICogQHByb3BlcnR5IHtzdHJpbmd9IHBhdGhJbkNvbnRhaW5lciAtIFRoZSBhYnNvbHV0ZSBmdWxsIHBhdGggb2YgdGhlIGl0ZW0gb24gdGhlIGxvY2FsIGZpbGUgc3lzdGVtXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IGNvbnRhaW5lclR5cGUgLSBUaGUgY29udGFpbmVyIHR5cGVcbiAqL1xuXG4vKipcbiAqIFBhcnNlcyB0aGUgYWN0dWFsIHBhdGggYW5kIHRoZSBidW5kbGUgaWRlbnRpZmllciBmcm9tIHRoZSBnaXZlbiBwYXRoIHN0cmluZ1xuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIGdpdmVuIHBhdGggc3RyaW5nLiBUaGUgc3RyaW5nIHNob3VsZFxuICogbWF0Y2ggYENPTlRBSU5FUl9QQVRIX1BBVFRFUk5gIHJlZ2V4cCwgb3RoZXJ3aXNlIGFuIGVycm9yIGlzIGdvaW5nXG4gKiB0byBiZSB0aHJvd24uIEEgdmFsaWQgc3RyaW5nIGV4YW1wbGU6IGBAYnVuZGxlLmlkZW50aWZpZXI6Y29udGFpbmVyX3R5cGUvcmVsYXRpdmVfcGF0aF9pbl9jb250YWluZXJgXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufHN0cmluZ30gY29udGFpbmVyUm9vdFN1cHBsaWVyIC0gRWl0aGVyIGEgc3RyaW5nLCB0aGF0IGNvbnRhaW5zXG4gKiBmdWxsIHBhdGggdG8gdGhlIG1vdW50IHJvb3QgZm9yIHJlYWwgZGV2aWNlcyBvciBhIGZ1bmN0aW9uLCB3aGljaCBhY2NlcHRzIHR3byBwYXJhbWV0ZXJzXG4gKiAoYnVuZGxlIGlkZW50aWZpZXIgYW5kIG9wdGlvbmFsIGNvbnRhaW5lciB0eXBlKSBhbmQgcmV0dXJucyBmdWxsIHBhdGggdG8gY29udGFpbmVyXG4gKiByb290IGZvbGRlciBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0sIGZvciBTaW11bGF0b3JcbiAqIEByZXR1cm5zIHtDb250YWluZXJPYmplY3R9XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHBhcnNlQ29udGFpbmVyUGF0aCAocmVtb3RlUGF0aCwgY29udGFpbmVyUm9vdFN1cHBsaWVyKSB7XG4gIGNvbnN0IG1hdGNoID0gQ09OVEFJTkVSX1BBVEhfUEFUVEVSTi5leGVjKHJlbW90ZVBhdGgpO1xuICBpZiAoIW1hdGNoKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEl0IGlzIGV4cGVjdGVkIHRoYXQgcGFja2FnZSBpZGVudGlmaWVyIGAgK1xuICAgICAgYHN0YXJ0cyB3aXRoICcke0NPTlRBSU5FUl9QQVRIX01BUktFUn0nIGFuZCBpcyBzZXBhcmF0ZWQgZnJvbSB0aGUgYCArXG4gICAgICBgcmVsYXRpdmUgcGF0aCB3aXRoIGEgc2luZ2xlIHNsYXNoLiAnJHtyZW1vdGVQYXRofScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICB9XG4gIGxldCBbLCBidW5kbGVJZCwgcmVsYXRpdmVQYXRoXSA9IG1hdGNoO1xuICBsZXQgY29udGFpbmVyVHlwZSA9IG51bGw7XG4gIGNvbnN0IHR5cGVTZXBhcmF0b3JQb3MgPSBidW5kbGVJZC5pbmRleE9mKENPTlRBSU5FUl9UWVBFX1NFUEFSQVRPUik7XG4gIC8vIFdlIG9ubHkgY29uc2lkZXIgY29udGFpbmVyIHR5cGUgZXhpc3RzIGlmIGl0cyBsZW5ndGggaXMgZ3JlYXRlciB0aGFuIHplcm9cbiAgLy8gbm90IGNvdW50aW5nIHRoZSBjb2xvblxuICBpZiAodHlwZVNlcGFyYXRvclBvcyA+IDAgJiYgdHlwZVNlcGFyYXRvclBvcyA8IGJ1bmRsZUlkLmxlbmd0aCAtIDEpIHtcbiAgICBjb250YWluZXJUeXBlID0gYnVuZGxlSWQuc3Vic3RyaW5nKHR5cGVTZXBhcmF0b3JQb3MgKyAxKTtcbiAgICBsb2cuZGVidWcoYFBhcnNlZCBjb250YWluZXIgdHlwZTogJHtjb250YWluZXJUeXBlfWApO1xuICAgIGJ1bmRsZUlkID0gYnVuZGxlSWQuc3Vic3RyaW5nKDAsIHR5cGVTZXBhcmF0b3JQb3MpO1xuICB9XG4gIGlmIChfLmlzTmlsKGNvbnRhaW5lclJvb3RTdXBwbGllcikpIHtcbiAgICBjb25zdCBwYXRoSW5Db250YWluZXIgPSByZWxhdGl2ZVBhdGg7XG4gICAgcmV0dXJuIHsgYnVuZGxlSWQsIHBhdGhJbkNvbnRhaW5lciwgY29udGFpbmVyVHlwZSB9O1xuICB9XG4gIGNvbnN0IGNvbnRhaW5lclJvb3QgPSBfLmlzRnVuY3Rpb24oY29udGFpbmVyUm9vdFN1cHBsaWVyKVxuICAgID8gYXdhaXQgY29udGFpbmVyUm9vdFN1cHBsaWVyKGJ1bmRsZUlkLCBjb250YWluZXJUeXBlKVxuICAgIDogY29udGFpbmVyUm9vdFN1cHBsaWVyO1xuICBjb25zdCBwYXRoSW5Db250YWluZXIgPSBwYXRoLnBvc2l4LnJlc29sdmUoY29udGFpbmVyUm9vdCwgcmVsYXRpdmVQYXRoKTtcbiAgdmVyaWZ5SXNTdWJQYXRoKHBhdGhJbkNvbnRhaW5lciwgY29udGFpbmVyUm9vdCk7XG4gIHJldHVybiB7YnVuZGxlSWQsIHBhdGhJbkNvbnRhaW5lciwgY29udGFpbmVyVHlwZX07XG59XG5cbi8qKlxuICogU2F2ZSB0aGUgZ2l2ZW4gYmFzZTY0IGRhdGEgY2h1bmsgYXMgYSBiaW5hcnkgZmlsZSBvbiB0aGUgU2ltdWxhdG9yIHVuZGVyIHRlc3QuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGRldmljZSAtIFRoZSBkZXZpY2Ugb2JqZWN0LCB3aGljaCByZXByZXNlbnRzIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9iamVjdCBpcyBleHBlY3RlZCB0byBoYXZlIHRoZSBgdWRpZGAgcHJvcGVydHkgY29udGFpbmluZyB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZCBkZXZpY2UgSUQuXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSByZW1vdGUgcGF0aCBvbiB0aGUgZGV2aWNlLiBUaGlzIHZhcmlhYmxlIGNhbiBiZSBwcmVmaXhlZCB3aXRoXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1bmRsZSBpZCwgc28gdGhlbiB0aGUgZmlsZSB3aWxsIGJlIHVwbG9hZGVkIHRvIHRoZSBjb3JyZXNwb25kaW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uIGNvbnRhaW5lciBpbnN0ZWFkIG9mIHRoZSBkZWZhdWx0IG1lZGlhIGZvbGRlciwgZm9yIGV4YW1wbGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0Bjb20ubXlhcHAuYmxhOmRhdGEvUmVsYXRpdmVQYXRoSW5Db250YWluZXIvMTExLnBuZycuIFRoZSAnQCcgY2hhcmFjdGVyIGF0IHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWdpbm5pbmcgb2YgdGhlIGFyZ3VtZW50IGlzIG1hbmRhdG9yeSBpbiBzdWNoIGNhc2UuIFRoZSBjb2xvbiBhdCB0aGUgZW5kIG9mIGJ1bmRsZSBpZGVudGlmaWVyXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzIG9wdGlvbmFsIGFuZCBpcyB1c2VkIHRvIGRpc3Rpbmd1aXNoIHRoZSBjb250YWluZXIgdHlwZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUG9zc2libGUgdmFsdWVzIHRoZXJlIGFyZSAnYXBwJywgJ2RhdGEnLCAnZ3JvdXBzJywgJzxBIHNwZWNpZmljIEFwcCBHcm91cCBjb250YWluZXI+Jy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGRlZmF1bHQgdmFsdWUgaXMgJ2FwcCcuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSByZWxhdGl2ZSBmb2xkZXIgcGF0aCBpcyBpZ25vcmVkIGlmIHRoZSBmaWxlIGlzIGdvaW5nIHRvIGJlIHVwbG9hZGVkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIHRoZSBkZWZhdWx0IG1lZGlhIGZvbGRlciBhbmQgb25seSB0aGUgZmlsZSBuYW1lIGlzIGNvbnNpZGVyZWQgaW1wb3J0YW50LlxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2U2NERhdGEgLSBCYXNlLTY0IGVuY29kZWQgY29udGVudCBvZiB0aGUgZmlsZSB0byBiZSB1cGxvYWRlZC5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gcHVzaEZpbGVUb1NpbXVsYXRvciAoZGV2aWNlLCByZW1vdGVQYXRoLCBiYXNlNjREYXRhKSB7XG4gIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5mcm9tKGJhc2U2NERhdGEsICdiYXNlNjQnKTtcbiAgaWYgKENPTlRBSU5FUl9QQVRIX1BBVFRFUk4udGVzdChyZW1vdGVQYXRoKSkge1xuICAgIGNvbnN0IHsgYnVuZGxlSWQsIHBhdGhJbkNvbnRhaW5lcjogZHN0UGF0aCB9ID0gYXdhaXQgcGFyc2VDb250YWluZXJQYXRoKHJlbW90ZVBhdGgsXG4gICAgICBhc3luYyAoYXBwQnVuZGxlLCBjb250YWluZXJUeXBlKSA9PiBhd2FpdCBnZXRBcHBDb250YWluZXIoZGV2aWNlLnVkaWQsIGFwcEJ1bmRsZSwgbnVsbCwgY29udGFpbmVyVHlwZSkpO1xuICAgIGxvZy5pbmZvKGBQYXJzZWQgYnVuZGxlIGlkZW50aWZpZXIgJyR7YnVuZGxlSWR9JyBmcm9tICcke3JlbW90ZVBhdGh9Jy4gYCArXG4gICAgICBgV2lsbCBwdXQgdGhlIGRhdGEgaW50byAnJHtkc3RQYXRofSdgKTtcbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhwYXRoLmRpcm5hbWUoZHN0UGF0aCkpKSB7XG4gICAgICBsb2cuZGVidWcoYFRoZSBkZXN0aW5hdGlvbiBmb2xkZXIgJyR7cGF0aC5kaXJuYW1lKGRzdFBhdGgpfScgZG9lcyBub3QgZXhpc3QuIENyZWF0aW5nLi4uYCk7XG4gICAgICBhd2FpdCBta2RpcnAocGF0aC5kaXJuYW1lKGRzdFBhdGgpKTtcbiAgICB9XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKGRzdFBhdGgsIGJ1ZmZlcik7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IGRzdEZvbGRlciA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICBjb25zdCBkc3RQYXRoID0gcGF0aC5yZXNvbHZlKGRzdEZvbGRlciwgcGF0aC5iYXNlbmFtZShyZW1vdGVQYXRoKSk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKGRzdFBhdGgsIGJ1ZmZlcik7XG4gICAgYXdhaXQgYWRkTWVkaWEoZGV2aWNlLnVkaWQsIGRzdFBhdGgpO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IGZzLnJpbXJhZihkc3RGb2xkZXIpO1xuICB9XG59XG5cbi8qKlxuICogU2F2ZSB0aGUgZ2l2ZW4gYmFzZTY0IGRhdGEgY2h1bmsgYXMgYSBiaW5hcnkgZmlsZSBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGRldmljZSAtIFRoZSBkZXZpY2Ugb2JqZWN0LCB3aGljaCByZXByZXNlbnRzIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9iamVjdCBpcyBleHBlY3RlZCB0byBoYXZlIHRoZSBgdWRpZGAgcHJvcGVydHkgY29udGFpbmluZyB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZCBkZXZpY2UgSUQuXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSByZW1vdGUgcGF0aCBvbiB0aGUgZGV2aWNlLiBUaGlzIHZhcmlhYmxlIGNhbiBiZSBwcmVmaXhlZCB3aXRoXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1bmRsZSBpZCwgc28gdGhlbiB0aGUgZmlsZSB3aWxsIGJlIHVwbG9hZGVkIHRvIHRoZSBjb3JyZXNwb25kaW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uIGNvbnRhaW5lciBpbnN0ZWFkIG9mIHRoZSBkZWZhdWx0IG1lZGlhIGZvbGRlci4gVXNlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEA8YXBwX2J1bmRsZV9pZD46PG9wdGlvbmFsX2NvbnRhaW5lcl90eXBlPi88cGF0aF90b190aGVfZmlsZV9vcl9mb2xkZXJfaW5zaWRlX2NvbnRhaW5lcj5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0IHRvIHB1bGwgYSBmaWxlIG9yIGEgZm9sZGVyIGZyb20gYW4gYXBwbGljYXRpb24gY29udGFpbmVyIG9mIHRoZSBnaXZlbiB0eXBlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgb25seSBzdXBwb3J0ZWQgY29udGFpbmVyIHR5cGUgaXMgJ2RvY3VtZW50cycuIElmIHRoZSBjb250YWluZXIgdHlwZSBpcyBub3Qgc2V0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGxpY2l0bHkgZm9yIGEgYnVuZGxlIGlkLCB0aGVuIHRoZSBkZWZhdWx0IGFwcGxpY2F0aW9uIGNvbnRhaW5lciBpcyBnb2luZyB0byBiZSBtb3VudGVkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChha2EgLS1jb250YWluZXIgaWZ1c2UgYXJndW1lbnQpXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUuZy4gSWYgYEBjb20ubXlhcHAuYmxhOmRvY3VtZW50cy8xMTEucG5nYCBpcyBwcm92aWRlZCxcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgT24gTXkgaVBob25lLzxhcHAgbmFtZT5gIGluIEZpbGVzIGFwcCB3aWxsIGJlIG1vdW50ZWQgaW4gdGhlIGhvc3QgbWFjaGluZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBCYXNlNjQgZW5jb2RlZCBgMTExLnBuZ2Agd2lsbCBiZSBwdXNoZWQgaW50byBgT24gTXkgaVBob25lLzxhcHAgbmFtZT4vMTExLnBuZ2BcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcyBiYXNlNjQgZGVjb2RlZCBkYXRhLlxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2U2NERhdGEgLSBCYXNlLTY0IGVuY29kZWQgY29udGVudCBvZiB0aGUgZmlsZSB0byBiZSB1cGxvYWRlZC5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gcHVzaEZpbGVUb1JlYWxEZXZpY2UgKGRldmljZSwgcmVtb3RlUGF0aCwgYmFzZTY0RGF0YSkge1xuICBjb25zdCB7IHNlcnZpY2UsIHJlbGF0aXZlUGF0aCB9ID0gYXdhaXQgY3JlYXRlU2VydmljZShkZXZpY2UudWRpZCwgcmVtb3RlUGF0aCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgbWtkaXJwRGV2aWNlKHNlcnZpY2UsIHBhdGguZGlybmFtZShyZWxhdGl2ZVBhdGgpKTtcbiAgICBjb25zdCBzdHJlYW0gPSBhd2FpdCBzZXJ2aWNlLmNyZWF0ZVdyaXRlU3RyZWFtKHJlbGF0aXZlUGF0aCwgeyBhdXRvQ2xvc2U6IHRydWUgfSk7XG4gICAgc3RyZWFtLndyaXRlKEJ1ZmZlci5mcm9tKGJhc2U2NERhdGEsICdiYXNlNjQnKSk7XG4gICAgY29uc3QgY2xvc2VFdmVudCA9IG5ldyBCKChyZXNvbHZlKSA9PiBzdHJlYW0ub24oJ2Nsb3NlJywgcmVzb2x2ZSkpLnRpbWVvdXQoSU9fVElNRU9VVCk7XG4gICAgc3RyZWFtLmRlc3Ryb3koKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgY2xvc2VFdmVudDtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkbnQgcHVzaCB0aGUgZmlsZSB3aXRoaW4gdGhlIGdpdmVuIHRpbWVvdXQgJHtJT19USU1FT1VUfW1zYCk7XG4gICAgfVxuICB9IGZpbmFsbHkge1xuICAgIHNlcnZpY2UuY2xvc2UoKTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCB0aGUgY29udGVudCBvZiBnaXZlbiBmaWxlIG9yIGZvbGRlciBmcm9tIGlPUyBTaW11bGF0b3IgYW5kIHJldHVybiBpdCBhcyBiYXNlLTY0IGVuY29kZWQgc3RyaW5nLlxuICogRm9sZGVyIGNvbnRlbnQgaXMgcmVjdXJzaXZlbHkgcGFja2VkIGludG8gYSB6aXAgYXJjaGl2ZS5cbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gZGV2aWNlIC0gVGhlIGRldmljZSBvYmplY3QsIHdoaWNoIHJlcHJlc2VudHMgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb2JqZWN0IGlzIGV4cGVjdGVkIHRvIGhhdmUgdGhlIGB1ZGlkYCBwcm9wZXJ0eSBjb250YWluaW5nIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkIGRldmljZSBJRC5cbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gYSBmaWxlIG9yIGEgZm9sZGVyLCB3aGljaCBleGlzdHMgaW4gdGhlIGNvcnJlc3BvbmRpbmcgYXBwbGljYXRpb25cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyIG9uIFNpbXVsYXRvci4gVXNlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEA8YXBwX2J1bmRsZV9pZD46PG9wdGlvbmFsX2NvbnRhaW5lcl90eXBlPi88cGF0aF90b190aGVfZmlsZV9vcl9mb2xkZXJfaW5zaWRlX2NvbnRhaW5lcj5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0IHRvIHB1bGwgYSBmaWxlIG9yIGEgZm9sZGVyIGZyb20gYW4gYXBwbGljYXRpb24gY29udGFpbmVyIG9mIHRoZSBnaXZlbiB0eXBlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQb3NzaWJsZSBjb250YWluZXIgdHlwZXMgYXJlICdhcHAnLCAnZGF0YScsICdncm91cHMnLCAnPEEgc3BlY2lmaWMgQXBwIEdyb3VwIGNvbnRhaW5lcj4nLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZGVmYXVsdCB0eXBlIGlzICdhcHAnLlxuICogQHBhcmFtIHtib29sZWFufSBpc0ZpbGUgLSBXaGV0aGVyIHRoZSBkZXN0aW5hdGlvbiBpdGVtIGlzIGEgZmlsZSBvciBhIGZvbGRlclxuICogQHJldHVybnMge3N0cmluZ30gQmFzZS02NCBlbmNvZGVkIGNvbnRlbnQgb2YgdGhlIGZpbGUuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHB1bGxGcm9tU2ltdWxhdG9yIChkZXZpY2UsIHJlbW90ZVBhdGgsIGlzRmlsZSkge1xuICBsZXQgcGF0aE9uU2VydmVyO1xuICBpZiAoQ09OVEFJTkVSX1BBVEhfUEFUVEVSTi50ZXN0KHJlbW90ZVBhdGgpKSB7XG4gICAgY29uc3QgeyBidW5kbGVJZCwgcGF0aEluQ29udGFpbmVyOiBkc3RQYXRoIH0gPSBhd2FpdCBwYXJzZUNvbnRhaW5lclBhdGgocmVtb3RlUGF0aCxcbiAgICAgIGFzeW5jIChhcHBCdW5kbGUsIGNvbnRhaW5lclR5cGUpID0+IGF3YWl0IGdldEFwcENvbnRhaW5lcihkZXZpY2UudWRpZCwgYXBwQnVuZGxlLCBudWxsLCBjb250YWluZXJUeXBlKSk7XG4gICAgbG9nLmluZm8oYFBhcnNlZCBidW5kbGUgaWRlbnRpZmllciAnJHtidW5kbGVJZH0nIGZyb20gJyR7cmVtb3RlUGF0aH0nLiBgICtcbiAgICAgIGBXaWxsIGdldCB0aGUgZGF0YSBmcm9tICcke2RzdFBhdGh9J2ApO1xuICAgIHBhdGhPblNlcnZlciA9IGRzdFBhdGg7XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgc2ltUm9vdCA9IGRldmljZS5nZXREaXIoKTtcbiAgICBwYXRoT25TZXJ2ZXIgPSBwYXRoLnBvc2l4LmpvaW4oc2ltUm9vdCwgcmVtb3RlUGF0aCk7XG4gICAgdmVyaWZ5SXNTdWJQYXRoKHBhdGhPblNlcnZlciwgc2ltUm9vdCk7XG4gICAgbG9nLmluZm8oYEdvdCB0aGUgZnVsbCBpdGVtIHBhdGg6ICR7cGF0aE9uU2VydmVyfWApO1xuICB9XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKHBhdGhPblNlcnZlcikpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVGhlIHJlbW90ZSAke2lzRmlsZSA/ICdmaWxlJyA6ICdmb2xkZXInfSBhdCAnJHtwYXRoT25TZXJ2ZXJ9JyBkb2VzIG5vdCBleGlzdGApO1xuICB9XG4gIGNvbnN0IGJ1ZmZlciA9IGlzRmlsZVxuICAgID8gYXdhaXQgZnMucmVhZEZpbGUocGF0aE9uU2VydmVyKVxuICAgIDogYXdhaXQgemlwLnRvSW5NZW1vcnlaaXAocGF0aE9uU2VydmVyKTtcbiAgcmV0dXJuIEJ1ZmZlci5mcm9tKGJ1ZmZlcikudG9TdHJpbmcoJ2Jhc2U2NCcpO1xufVxuXG4vKipcbiAqIEdldCB0aGUgY29udGVudCBvZiBnaXZlbiBmaWxlIG9yIGZvbGRlciBmcm9tIHRoZSByZWFsIGRldmljZSB1bmRlciB0ZXN0IGFuZCByZXR1cm4gaXQgYXMgYmFzZS02NCBlbmNvZGVkIHN0cmluZy5cbiAqIEZvbGRlciBjb250ZW50IGlzIHJlY3Vyc2l2ZWx5IHBhY2tlZCBpbnRvIGEgemlwIGFyY2hpdmUuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGRldmljZSAtIFRoZSBkZXZpY2Ugb2JqZWN0LCB3aGljaCByZXByZXNlbnRzIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9iamVjdCBpcyBleHBlY3RlZCB0byBoYXZlIHRoZSBgdWRpZGAgcHJvcGVydHkgY29udGFpbmluZyB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZCBkZXZpY2UgSUQuXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIGFuIGV4aXN0aW5nIHJlbW90ZSBmaWxlIG9uIHRoZSBkZXZpY2UuIFRoaXMgdmFyaWFibGUgY2FuIGJlIHByZWZpeGVkIHdpdGhcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVuZGxlIGlkLCBzbyB0aGVuIHRoZSBmaWxlIHdpbGwgYmUgZG93bmxvYWRlZCBmcm9tIHRoZSBjb3JyZXNwb25kaW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uIGNvbnRhaW5lciBpbnN0ZWFkIG9mIHRoZSBkZWZhdWx0IG1lZGlhIGZvbGRlci4gVXNlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEA8YXBwX2J1bmRsZV9pZD46PG9wdGlvbmFsX2NvbnRhaW5lcl90eXBlPi88cGF0aF90b190aGVfZmlsZV9vcl9mb2xkZXJfaW5zaWRlX2NvbnRhaW5lcj5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0IHRvIHB1bGwgYSBmaWxlIG9yIGEgZm9sZGVyIGZyb20gYW4gYXBwbGljYXRpb24gY29udGFpbmVyIG9mIHRoZSBnaXZlbiB0eXBlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgb25seSBzdXBwb3J0ZWQgY29udGFpbmVyIHR5cGUgaXMgJ2RvY3VtZW50cycuIElmIHRoZSBjb250YWluZXIgdHlwZSBpcyBub3Qgc2V0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGxpY2l0bHkgZm9yIGEgYnVuZGxlIGlkLCB0aGVuIHRoZSBkZWZhdWx0IGFwcGxpY2F0aW9uIGNvbnRhaW5lciBpcyBnb2luZyB0byBiZSBtb3VudGVkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChha2EgLS1jb250YWluZXIgaWZ1c2UgYXJndW1lbnQpXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUuZy4gSWYgYEBjb20ubXlhcHAuYmxhOmRvY3VtZW50cy8xMTEucG5nYCBpcyBwcm92aWRlZCxcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgT24gTXkgaVBob25lLzxhcHAgbmFtZT5gIGluIEZpbGVzIGFwcCB3aWxsIGJlIG1vdW50ZWQgaW4gdGhlIGhvc3QgbWFjaGluZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgT24gTXkgaVBob25lLzxhcHAgbmFtZT4vMTExLnBuZ2Agd2lsIGJlIHB1bGxlZCBpbnRvIHRoZSBtb3VudGVkIGhvc3QgbWFjaGluZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBBcHBpdW0gcmV0dXJucyB0aGUgZGF0YSBhcyBiYXNlNjQtZW5jb2RlZCBzdHJpbmcgdG8gY2xpZW50LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBAY29tLm15YXBwLmJsYTpkb2N1bWVudHMvYCBtZWFucyBgT24gTXkgaVBob25lLzxhcHAgbmFtZT5gLlxuICogQHBhcmFtIHtib29sZWFufSBpc0ZpbGUgLSBXaGV0aGVyIHRoZSBkZXN0aW5hdGlvbiBpdGVtIGlzIGEgZmlsZSBvciBhIGZvbGRlclxuICogQHJldHVybiB7c3RyaW5nfSBCYXNlLTY0IGVuY29kZWQgY29udGVudCBvZiB0aGUgcmVtb3RlIGZpbGVcbiAqL1xuYXN5bmMgZnVuY3Rpb24gcHVsbEZyb21SZWFsRGV2aWNlIChkZXZpY2UsIHJlbW90ZVBhdGgsIGlzRmlsZSkge1xuICBjb25zdCB7IHNlcnZpY2UsIHJlbGF0aXZlUGF0aCB9ID0gYXdhaXQgY3JlYXRlU2VydmljZShkZXZpY2UudWRpZCwgcmVtb3RlUGF0aCk7XG4gIHRyeSB7XG4gICAgY29uc3QgZmlsZUluZm8gPSBhd2FpdCBzZXJ2aWNlLmdldEZpbGVJbmZvKHJlbGF0aXZlUGF0aCk7XG4gICAgaWYgKGlzRmlsZSAmJiBmaWxlSW5mby5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSByZXF1ZXN0ZWQgcGF0aCBpcyBub3QgYSBmaWxlLiBQYXRoOiAke3JlbW90ZVBhdGh9YCk7XG4gICAgfVxuICAgIGlmICghaXNGaWxlICYmICFmaWxlSW5mby5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSByZXF1ZXN0ZWQgcGF0aCBpcyBub3QgYSBmb2xkZXIuIFBhdGg6ICR7cmVtb3RlUGF0aH1gKTtcbiAgICB9XG5cbiAgICBpZiAoZmlsZUluZm8uaXNGaWxlKCkpIHtcbiAgICAgIHJldHVybiBhd2FpdCBwdWxsRmlsZUZyb21SZWFsRGV2aWNlKHNlcnZpY2UsIHJlbGF0aXZlUGF0aCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBhd2FpdCBwdWxsRm9sZGVyRnJvbVJlYWxEZXZpY2Uoc2VydmljZSwgcmVsYXRpdmVQYXRoKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZS5tZXNzYWdlLmluY2x1ZGVzKE9CSkVDVF9OT1RfRk9VTkRfRVJST1JfTUVTU0FHRSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUGF0aCAnJHtyZW1vdGVQYXRofScgZG9lc24ndCBleGlzdHMgb24gdGhlIGRldmljZWApO1xuICAgIH1cbiAgICB0aHJvdyBlO1xuICB9IGZpbmFsbHkge1xuICAgIHNlcnZpY2UuY2xvc2UoKTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCBidW5kbGVJZHMgd2hpY2ggY2FuIG1vdW50IGJ5IGAtLWRvY3VtZW50c2AgZmxhZ1xuICpcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gdWRpZCAtIFRoZSB1ZGlkIG9mIHRoZSB0YXJnZXQgZGV2aWNlXG4gKiBAcmV0dXJucyB7QXJyYXk8c3RyaW5nPn0gQSBsaXN0IG9mIFVzZXIgbGV2ZWwgYXBwcycgYnVuZGxlIGlkcyB3aGljaCBoYXNcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAnVUlGaWxlU2hhcmluZ0VuYWJsZWQnIGF0dHJpYnV0ZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBPbmx5IHVzZXIgYXBwcyBtaWdodCBoYXZlIGl0LlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRBdmFpbGFibGVCdW5kbGVJZHMgKHVkaWQpIHtcbiAgY29uc3Qgc2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0SW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlKHVkaWQpO1xuICB0cnkge1xuICAgIGNvbnN0IGFwcGxpY2F0aW9ucyA9IGF3YWl0IHNlcnZpY2UubGlzdEFwcGxpY2F0aW9ucyh7YXBwbGljYXRpb25UeXBlOiAnVXNlcid9KTtcbiAgICBjb25zdCBidW5kbGVJZHMgPSBbXTtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhhcHBsaWNhdGlvbnMpKSB7XG4gICAgICBpZiAoIXZhbHVlLlVJRmlsZVNoYXJpbmdFbmFibGVkKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgYnVuZGxlSWRzLnB1c2goa2V5KTtcbiAgICB9XG4gICAgcmV0dXJuIGJ1bmRsZUlkcztcbiAgfSBmaW5hbGx5IHtcbiAgICBzZXJ2aWNlLmNsb3NlKCk7XG4gIH1cbn1cblxuXG5jb21tYW5kcy5wdXNoRmlsZSA9IGFzeW5jIGZ1bmN0aW9uIHB1c2hGaWxlIChyZW1vdGVQYXRoLCBiYXNlNjREYXRhKSB7XG4gIGlmIChyZW1vdGVQYXRoLmVuZHNXaXRoKCcvJykpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgSXQgaXMgZXhwZWN0ZWQgdGhhdCByZW1vdGUgcGF0aCBwb2ludHMgdG8gYSBmaWxlIGFuZCBub3QgdG8gYSBmb2xkZXIuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGAnJHtyZW1vdGVQYXRofScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICB9XG4gIGlmIChfLmlzQXJyYXkoYmFzZTY0RGF0YSkpIHtcbiAgICAvLyBzb21lIGNsaWVudHMgKGFoZW0pIGphdmEsIHNlbmQgYSBieXRlIGFycmF5IGVuY29kaW5nIHV0ZjggY2hhcmFjdGVyc1xuICAgIC8vIGluc3RlYWQgb2YgYSBzdHJpbmcsIHdoaWNoIHdvdWxkIGJlIGluZmluaXRlbHkgYmV0dGVyIVxuICAgIGJhc2U2NERhdGEgPSBCdWZmZXIuZnJvbShiYXNlNjREYXRhKS50b1N0cmluZygndXRmOCcpO1xuICB9XG4gIHJldHVybiB0aGlzLmlzU2ltdWxhdG9yKClcbiAgICA/IGF3YWl0IHB1c2hGaWxlVG9TaW11bGF0b3IodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgYmFzZTY0RGF0YSlcbiAgICA6IGF3YWl0IHB1c2hGaWxlVG9SZWFsRGV2aWNlKHRoaXMub3B0cy5kZXZpY2UsIHJlbW90ZVBhdGgsIGJhc2U2NERhdGEpO1xufTtcblxuY29tbWFuZHMucHVsbEZpbGUgPSBhc3luYyBmdW5jdGlvbiBwdWxsRmlsZSAocmVtb3RlUGF0aCkge1xuICBpZiAocmVtb3RlUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEl0IGlzIGV4cGVjdGVkIHRoYXQgcmVtb3RlIHBhdGggcG9pbnRzIHRvIGEgZmlsZSBhbmQgbm90IHRvIGEgZm9sZGVyLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgJyR7cmVtb3RlUGF0aH0nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgfVxuICByZXR1cm4gdGhpcy5pc1NpbXVsYXRvcigpXG4gICAgPyBhd2FpdCBwdWxsRnJvbVNpbXVsYXRvcih0aGlzLm9wdHMuZGV2aWNlLCByZW1vdGVQYXRoLCB0cnVlKVxuICAgIDogYXdhaXQgcHVsbEZyb21SZWFsRGV2aWNlKHRoaXMub3B0cy5kZXZpY2UsIHJlbW90ZVBhdGgsIHRydWUpO1xufTtcblxuY29tbWFuZHMuZ2V0U2ltRmlsZUZ1bGxQYXRoID0gYXN5bmMgZnVuY3Rpb24gZ2V0U2ltRmlsZUZ1bGxQYXRoIChyZW1vdGVQYXRoKSB7XG4gIGxldCBiYXNlUGF0aCA9IHRoaXMub3B0cy5kZXZpY2UuZ2V0RGlyKCk7XG4gIGxldCBhcHBOYW1lID0gbnVsbDtcblxuICBpZiAodGhpcy5vcHRzLmFwcCkge1xuICAgIGxldCBhcHBOYW1lUmVnZXggPSBuZXcgUmVnRXhwKGBcXFxcJHtwYXRoLnNlcH0oW1xcXFx3LV0rXFxcXC5hcHApYCk7XG4gICAgbGV0IGFwcE5hbWVNYXRjaGVzID0gYXBwTmFtZVJlZ2V4LmV4ZWModGhpcy5vcHRzLmFwcCk7XG4gICAgaWYgKGFwcE5hbWVNYXRjaGVzKSB7XG4gICAgICBhcHBOYW1lID0gYXBwTmFtZU1hdGNoZXNbMV07XG4gICAgfVxuICB9XG4gIC8vIGRlLWFic29sdXRpemUgdGhlIHBhdGhcbiAgaWYgKHN5c3RlbS5pc1dpbmRvd3MoKSkge1xuICAgIGlmIChyZW1vdGVQYXRoLmluZGV4b2YoJzovLycpID09PSAxKSB7XG4gICAgICByZW1vdGVQYXRoID0gcmVtb3RlUGF0aC5zbGljZSg0KTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaWYgKHJlbW90ZVBhdGguaW5kZXhPZignLycpID09PSAwKSB7XG4gICAgICByZW1vdGVQYXRoID0gcmVtb3RlUGF0aC5zbGljZSgxKTtcbiAgICB9XG4gIH1cblxuICBpZiAocmVtb3RlUGF0aC5zdGFydHNXaXRoKGFwcE5hbWUpKSB7XG4gICAgbGV0IGZpbmRQYXRoID0gYmFzZVBhdGg7XG4gICAgaWYgKCF0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uIHx8IHV0aWwuY29tcGFyZVZlcnNpb25zKHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24sICc+PScsICc4LjAnKSkge1xuICAgICAgLy8gdGhlIC5hcHAgZmlsZSBhcHBlYXJzIGluIC9Db250YWluZXJzL0RhdGEgYW5kIC9Db250YWluZXJzL0J1bmRsZSBib3RoLiBXZSBvbmx5IHdhbnQgL0J1bmRsZVxuICAgICAgZmluZFBhdGggPSBwYXRoLnJlc29sdmUoYmFzZVBhdGgsICdDb250YWluZXJzJywgJ0J1bmRsZScpO1xuICAgIH1cbiAgICBmaW5kUGF0aCA9IGZpbmRQYXRoLnJlcGxhY2UoL1xccy9nLCAnXFxcXCAnKTtcblxuICAgIGxldCB7IHN0ZG91dCB9ID0gYXdhaXQgZXhlYygnZmluZCcsIFtmaW5kUGF0aCwgJy1uYW1lJywgYXBwTmFtZV0pO1xuICAgIGxldCBhcHBSb290ID0gc3Rkb3V0LnJlcGxhY2UoL1xcbiQvLCAnJyk7XG4gICAgbGV0IHN1YlBhdGggPSByZW1vdGVQYXRoLnN1YnN0cmluZyhhcHBOYW1lLmxlbmd0aCArIDEpO1xuICAgIGxldCBmdWxsUGF0aCA9IHBhdGgucmVzb2x2ZShhcHBSb290LCBzdWJQYXRoKTtcbiAgICBsb2cuZGVidWcoYEZpbmRpbmcgYXBwLXJlbGF0aXZlIGZpbGU6ICcke2Z1bGxQYXRofSdgKTtcbiAgICByZXR1cm4gZnVsbFBhdGg7XG4gIH1cblxuICBsZXQgZnVsbFBhdGggPSBwYXRoLnJlc29sdmUoYmFzZVBhdGgsIHJlbW90ZVBhdGgpO1xuICBsb2cuZGVidWcoYEZpbmRpbmcgc2ltLXJlbGF0aXZlIGZpbGU6ICR7ZnVsbFBhdGh9YCk7XG4gIHJldHVybiBmdWxsUGF0aDtcbn07XG5cbmNvbW1hbmRzLnB1bGxGb2xkZXIgPSBhc3luYyBmdW5jdGlvbiBwdWxsRm9sZGVyIChyZW1vdGVQYXRoKSB7XG4gIGlmICghcmVtb3RlUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgcmVtb3RlUGF0aCA9IGAke3JlbW90ZVBhdGh9L2A7XG4gIH1cbiAgcmV0dXJuIHRoaXMuaXNTaW11bGF0b3IoKVxuICAgID8gYXdhaXQgcHVsbEZyb21TaW11bGF0b3IodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgZmFsc2UpXG4gICAgOiBhd2FpdCBwdWxsRnJvbVJlYWxEZXZpY2UodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgZmFsc2UpO1xufTtcblxuZXhwb3J0IHsgY29tbWFuZHMsIC8qIGZvciB0ZXN0aW5nICovIGdldEF2YWlsYWJsZUJ1bmRsZUlkcyxcbiAgLyogZm9yIHRlc3RpbmcgKi8gcGFyc2VDb250YWluZXJQYXRoIH07XG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2ZpbGUtbW92ZW1lbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

commands.getAlertText = async function getAlertText() {
  try {
    return await this.proxyCommand('/alert/text', 'GET');
  } catch (err) {
    if (this.isWebContext()) {
      const alert = await this.getAlert();
      return await alert.getText();
    }

    throw err;
  }
};

commands.setAlertText = async function setAlertText(value) {
  if (_lodash.default.isString(value)) {
    value = value.split('');
  }

  try {
    return await this.proxyCommand('/alert/text', 'POST', {
      value
    });
  } catch (err) {
    if (this.isWebContext()) {
      const alert = await this.getAlert();
      return await alert.setText(value);
    }

    throw err;
  }
};

commands.postAcceptAlert = async function postAcceptAlert(opts = {}) {
  try {
    let params = {};

    if (opts.buttonLabel) {
      params.name = opts.buttonLabel;
    }

    return await this.proxyCommand('/alert/accept', 'POST', params);
  } catch (err) {
    if (!this.isWebContext()) {
      throw new _appiumBaseDriver.errors.NoAlertOpenError();
    }

    let alert = await this.getAlert();

    if (alert.close) {
      return await alert.close();
    }

    await alert.ok();
  }
};

commands.postDismissAlert = async function postDismissAlert(opts = {}) {
  try {
    let params = {};

    if (opts.buttonLabel) {
      params.name = opts.buttonLabel;
    }

    return await this.proxyCommand('/alert/dismiss', 'POST', params);
  } catch (err) {
    if (!this.isWebContext()) {
      throw new _appiumBaseDriver.errors.NoAlertOpenError();
    }

    let alert = await this.getAlert();

    if (alert.close) {
      return await alert.close();
    }

    await alert.cancel();
  }
};

commands.getAlertButtons = async function getAlertButtons() {
  try {
    return await this.proxyCommand('/wda/alert/buttons', 'GET');
  } catch (err) {
    throw new _appiumBaseDriver.errors.NoAlertOpenError();
  }
};

commands.mobileHandleAlert = async function mobileHandleAlert(opts = {}) {
  switch (opts.action) {
    case 'accept':
      return await this.postAcceptAlert(opts);

    case 'dismiss':
      return await this.postDismissAlert(opts);

    case 'getButtons':
      return await this.getAlertButtons();

    default:
      throw new Error(`The 'action' value should be either 'accept', 'dismiss' or 'getButtons'. ` + `'${opts.action}' is provided instead.`);
  }
};

helpers.getAlert = async function getAlert() {
  let possibleAlert = await this.findNativeElementOrElements('class name', 'XCUIElementTypeScrollView', true);

  if (possibleAlert.length !== 1) {
    throw new _appiumBaseDriver.errors.NoAlertOpenError();
  }

  let possibleAlertButtons = await this.findNativeElementOrElements('class name', 'XCUIElementTypeButton', true, _appiumSupport.util.unwrapElement(possibleAlert[0]));

  if (possibleAlertButtons.length < 1 || possibleAlertButtons.length > 2) {
    throw new _appiumBaseDriver.errors.NoAlertOpenError();
  }

  let assertButtonName = async (button, expectedName) => {
    button = _appiumSupport.util.unwrapElement(button);
    let name = await this.proxyCommand(`/element/${button}/attribute/name`, 'GET');

    if (name.toLowerCase() !== expectedName) {
      throw new _appiumBaseDriver.errors.NoAlertOpenError();
    }
  };

  let alert = possibleAlert[0];

  if (possibleAlertButtons.length === 1) {
    let closeButton = possibleAlertButtons[0];
    await assertButtonName(closeButton, 'close');

    alert.close = async () => {
      await this.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(closeButton)}/click`, 'POST');
    };
  } else {
    let cancelButton = possibleAlertButtons[0];
    await assertButtonName(cancelButton, 'cancel');
    let okButton = possibleAlertButtons[1];
    await assertButtonName(okButton, 'ok');

    alert.cancel = async () => {
      await this.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(cancelButton)}/click`, 'POST');
    };

    alert.ok = async () => {
      await this.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(okButton)}/click`, 'POST');
    };
  }

  alert.getText = async () => {
    let textView = await this.findNativeElementOrElements('class name', 'XCUIElementTypeTextView', false, _appiumSupport.util.unwrapElement(alert));
    return await this.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(textView)}/attribute/value`, 'GET');
  };

  alert.setText = async value => {
    try {
      let textView = await this.findNativeElementOrElements('class name', 'XCUIElementTypeTextField', false, _appiumSupport.util.unwrapElement(alert));
      await this.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(textView)}/value `, 'POST', {
        value
      });
    } catch (err) {
      if ((0, _appiumBaseDriver.isErrorType)(err, _appiumBaseDriver.errors.NoSuchElementError)) {
        throw new Error('Tried to set text of an alert that was not a prompt');
      }

      throw err;
    }
  };

  return alert;
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9hbGVydC5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImhlbHBlcnMiLCJleHRlbnNpb25zIiwiZ2V0QWxlcnRUZXh0IiwicHJveHlDb21tYW5kIiwiZXJyIiwiaXNXZWJDb250ZXh0IiwiYWxlcnQiLCJnZXRBbGVydCIsImdldFRleHQiLCJzZXRBbGVydFRleHQiLCJ2YWx1ZSIsIl8iLCJpc1N0cmluZyIsInNwbGl0Iiwic2V0VGV4dCIsInBvc3RBY2NlcHRBbGVydCIsIm9wdHMiLCJwYXJhbXMiLCJidXR0b25MYWJlbCIsIm5hbWUiLCJlcnJvcnMiLCJOb0FsZXJ0T3BlbkVycm9yIiwiY2xvc2UiLCJvayIsInBvc3REaXNtaXNzQWxlcnQiLCJjYW5jZWwiLCJnZXRBbGVydEJ1dHRvbnMiLCJtb2JpbGVIYW5kbGVBbGVydCIsImFjdGlvbiIsIkVycm9yIiwicG9zc2libGVBbGVydCIsImZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyIsImxlbmd0aCIsInBvc3NpYmxlQWxlcnRCdXR0b25zIiwidXRpbCIsInVud3JhcEVsZW1lbnQiLCJhc3NlcnRCdXR0b25OYW1lIiwiYnV0dG9uIiwiZXhwZWN0ZWROYW1lIiwidG9Mb3dlckNhc2UiLCJjbG9zZUJ1dHRvbiIsImNhbmNlbEJ1dHRvbiIsIm9rQnV0dG9uIiwidGV4dFZpZXciLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJPYmplY3QiLCJhc3NpZ24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsUUFBUSxHQUFHLEVBQWY7QUFBQSxJQUFtQkMsT0FBTyxHQUFHLEVBQTdCO0FBQUEsSUFBaUNDLFVBQVUsR0FBRyxFQUE5Qzs7OztBQUVBRixRQUFRLENBQUNHLFlBQVQsR0FBd0IsZUFBZUEsWUFBZixHQUErQjtBQUNyRCxNQUFJO0FBQ0YsV0FBTyxNQUFNLEtBQUtDLFlBQUwsQ0FBa0IsYUFBbEIsRUFBaUMsS0FBakMsQ0FBYjtBQUNELEdBRkQsQ0FFRSxPQUFPQyxHQUFQLEVBQVk7QUFDWixRQUFJLEtBQUtDLFlBQUwsRUFBSixFQUF5QjtBQUN2QixZQUFNQyxLQUFLLEdBQUcsTUFBTSxLQUFLQyxRQUFMLEVBQXBCO0FBQ0EsYUFBTyxNQUFNRCxLQUFLLENBQUNFLE9BQU4sRUFBYjtBQUNEOztBQUNELFVBQU1KLEdBQU47QUFDRDtBQUNGLENBVkQ7O0FBWUFMLFFBQVEsQ0FBQ1UsWUFBVCxHQUF3QixlQUFlQSxZQUFmLENBQTZCQyxLQUE3QixFQUFvQztBQUMxRCxNQUFJQyxnQkFBRUMsUUFBRixDQUFXRixLQUFYLENBQUosRUFBdUI7QUFDckJBLElBQUFBLEtBQUssR0FBR0EsS0FBSyxDQUFDRyxLQUFOLENBQVksRUFBWixDQUFSO0FBQ0Q7O0FBQ0QsTUFBSTtBQUNGLFdBQU8sTUFBTSxLQUFLVixZQUFMLENBQWtCLGFBQWxCLEVBQWlDLE1BQWpDLEVBQXlDO0FBQUNPLE1BQUFBO0FBQUQsS0FBekMsQ0FBYjtBQUNELEdBRkQsQ0FFRSxPQUFPTixHQUFQLEVBQVk7QUFDWixRQUFJLEtBQUtDLFlBQUwsRUFBSixFQUF5QjtBQUN2QixZQUFNQyxLQUFLLEdBQUcsTUFBTSxLQUFLQyxRQUFMLEVBQXBCO0FBQ0EsYUFBTyxNQUFNRCxLQUFLLENBQUNRLE9BQU4sQ0FBY0osS0FBZCxDQUFiO0FBQ0Q7O0FBQ0QsVUFBTU4sR0FBTjtBQUNEO0FBQ0YsQ0FiRDs7QUFlQUwsUUFBUSxDQUFDZ0IsZUFBVCxHQUEyQixlQUFlQSxlQUFmLENBQWdDQyxJQUFJLEdBQUcsRUFBdkMsRUFBMkM7QUFDcEUsTUFBSTtBQUNGLFFBQUlDLE1BQU0sR0FBRyxFQUFiOztBQUNBLFFBQUlELElBQUksQ0FBQ0UsV0FBVCxFQUFzQjtBQUNwQkQsTUFBQUEsTUFBTSxDQUFDRSxJQUFQLEdBQWNILElBQUksQ0FBQ0UsV0FBbkI7QUFDRDs7QUFDRCxXQUFPLE1BQU0sS0FBS2YsWUFBTCxDQUFrQixlQUFsQixFQUFtQyxNQUFuQyxFQUEyQ2MsTUFBM0MsQ0FBYjtBQUNELEdBTkQsQ0FNRSxPQUFPYixHQUFQLEVBQVk7QUFDWixRQUFJLENBQUMsS0FBS0MsWUFBTCxFQUFMLEVBQTBCO0FBQ3hCLFlBQU0sSUFBSWUseUJBQU9DLGdCQUFYLEVBQU47QUFDRDs7QUFFRCxRQUFJZixLQUFLLEdBQUcsTUFBTSxLQUFLQyxRQUFMLEVBQWxCOztBQUNBLFFBQUlELEtBQUssQ0FBQ2dCLEtBQVYsRUFBaUI7QUFDZixhQUFPLE1BQU1oQixLQUFLLENBQUNnQixLQUFOLEVBQWI7QUFDRDs7QUFDRCxVQUFNaEIsS0FBSyxDQUFDaUIsRUFBTixFQUFOO0FBQ0Q7QUFDRixDQWxCRDs7QUFvQkF4QixRQUFRLENBQUN5QixnQkFBVCxHQUE0QixlQUFlQSxnQkFBZixDQUFpQ1IsSUFBSSxHQUFHLEVBQXhDLEVBQTRDO0FBQ3RFLE1BQUk7QUFDRixRQUFJQyxNQUFNLEdBQUcsRUFBYjs7QUFDQSxRQUFJRCxJQUFJLENBQUNFLFdBQVQsRUFBc0I7QUFDcEJELE1BQUFBLE1BQU0sQ0FBQ0UsSUFBUCxHQUFjSCxJQUFJLENBQUNFLFdBQW5CO0FBQ0Q7O0FBQ0QsV0FBTyxNQUFNLEtBQUtmLFlBQUwsQ0FBa0IsZ0JBQWxCLEVBQW9DLE1BQXBDLEVBQTRDYyxNQUE1QyxDQUFiO0FBQ0QsR0FORCxDQU1FLE9BQU9iLEdBQVAsRUFBWTtBQUNaLFFBQUksQ0FBQyxLQUFLQyxZQUFMLEVBQUwsRUFBMEI7QUFDeEIsWUFBTSxJQUFJZSx5QkFBT0MsZ0JBQVgsRUFBTjtBQUNEOztBQUVELFFBQUlmLEtBQUssR0FBRyxNQUFNLEtBQUtDLFFBQUwsRUFBbEI7O0FBQ0EsUUFBSUQsS0FBSyxDQUFDZ0IsS0FBVixFQUFpQjtBQUNmLGFBQU8sTUFBTWhCLEtBQUssQ0FBQ2dCLEtBQU4sRUFBYjtBQUNEOztBQUNELFVBQU1oQixLQUFLLENBQUNtQixNQUFOLEVBQU47QUFDRDtBQUNGLENBbEJEOztBQW9CQTFCLFFBQVEsQ0FBQzJCLGVBQVQsR0FBMkIsZUFBZUEsZUFBZixHQUFrQztBQUMzRCxNQUFJO0FBQ0YsV0FBTyxNQUFNLEtBQUt2QixZQUFMLENBQWtCLG9CQUFsQixFQUF3QyxLQUF4QyxDQUFiO0FBQ0QsR0FGRCxDQUVFLE9BQU9DLEdBQVAsRUFBWTtBQUNaLFVBQU0sSUFBSWdCLHlCQUFPQyxnQkFBWCxFQUFOO0FBQ0Q7QUFDRixDQU5EOztBQVFBdEIsUUFBUSxDQUFDNEIsaUJBQVQsR0FBNkIsZUFBZUEsaUJBQWYsQ0FBa0NYLElBQUksR0FBRyxFQUF6QyxFQUE2QztBQUN4RSxVQUFRQSxJQUFJLENBQUNZLE1BQWI7QUFDRSxTQUFLLFFBQUw7QUFDRSxhQUFPLE1BQU0sS0FBS2IsZUFBTCxDQUFxQkMsSUFBckIsQ0FBYjs7QUFDRixTQUFLLFNBQUw7QUFDRSxhQUFPLE1BQU0sS0FBS1EsZ0JBQUwsQ0FBc0JSLElBQXRCLENBQWI7O0FBQ0YsU0FBSyxZQUFMO0FBQ0UsYUFBTyxNQUFNLEtBQUtVLGVBQUwsRUFBYjs7QUFDRjtBQUNFLFlBQU0sSUFBSUcsS0FBSixDQUFXLDJFQUFELEdBQ0MsSUFBR2IsSUFBSSxDQUFDWSxNQUFPLHdCQUQxQixDQUFOO0FBUko7QUFXRCxDQVpEOztBQWNBNUIsT0FBTyxDQUFDTyxRQUFSLEdBQW1CLGVBQWVBLFFBQWYsR0FBMkI7QUFDNUMsTUFBSXVCLGFBQWEsR0FBRyxNQUFNLEtBQUtDLDJCQUFMLENBQWlDLFlBQWpDLEVBQStDLDJCQUEvQyxFQUE0RSxJQUE1RSxDQUExQjs7QUFDQSxNQUFJRCxhQUFhLENBQUNFLE1BQWQsS0FBeUIsQ0FBN0IsRUFBZ0M7QUFDOUIsVUFBTSxJQUFJWix5QkFBT0MsZ0JBQVgsRUFBTjtBQUNEOztBQUVELE1BQUlZLG9CQUFvQixHQUFHLE1BQU0sS0FBS0YsMkJBQUwsQ0FBaUMsWUFBakMsRUFBK0MsdUJBQS9DLEVBQXdFLElBQXhFLEVBQThFRyxvQkFBS0MsYUFBTCxDQUFtQkwsYUFBYSxDQUFDLENBQUQsQ0FBaEMsQ0FBOUUsQ0FBakM7O0FBQ0EsTUFBSUcsb0JBQW9CLENBQUNELE1BQXJCLEdBQThCLENBQTlCLElBQW1DQyxvQkFBb0IsQ0FBQ0QsTUFBckIsR0FBOEIsQ0FBckUsRUFBd0U7QUFDdEUsVUFBTSxJQUFJWix5QkFBT0MsZ0JBQVgsRUFBTjtBQUNEOztBQUVELE1BQUllLGdCQUFnQixHQUFHLE9BQU9DLE1BQVAsRUFBZUMsWUFBZixLQUFnQztBQUNyREQsSUFBQUEsTUFBTSxHQUFHSCxvQkFBS0MsYUFBTCxDQUFtQkUsTUFBbkIsQ0FBVDtBQUNBLFFBQUlsQixJQUFJLEdBQUcsTUFBTSxLQUFLaEIsWUFBTCxDQUFtQixZQUFXa0MsTUFBTyxpQkFBckMsRUFBdUQsS0FBdkQsQ0FBakI7O0FBQ0EsUUFBSWxCLElBQUksQ0FBQ29CLFdBQUwsT0FBdUJELFlBQTNCLEVBQXlDO0FBQ3ZDLFlBQU0sSUFBSWxCLHlCQUFPQyxnQkFBWCxFQUFOO0FBQ0Q7QUFDRixHQU5EOztBQVFBLE1BQUlmLEtBQUssR0FBR3dCLGFBQWEsQ0FBQyxDQUFELENBQXpCOztBQUNBLE1BQUlHLG9CQUFvQixDQUFDRCxNQUFyQixLQUFnQyxDQUFwQyxFQUF1QztBQUVyQyxRQUFJUSxXQUFXLEdBQUdQLG9CQUFvQixDQUFDLENBQUQsQ0FBdEM7QUFDQSxVQUFNRyxnQkFBZ0IsQ0FBQ0ksV0FBRCxFQUFjLE9BQWQsQ0FBdEI7O0FBRUFsQyxJQUFBQSxLQUFLLENBQUNnQixLQUFOLEdBQWMsWUFBWTtBQUN4QixZQUFNLEtBQUtuQixZQUFMLENBQW1CLFlBQVcrQixvQkFBS0MsYUFBTCxDQUFtQkssV0FBbkIsQ0FBZ0MsUUFBOUQsRUFBdUUsTUFBdkUsQ0FBTjtBQUNELEtBRkQ7QUFHRCxHQVJELE1BUU87QUFFTCxRQUFJQyxZQUFZLEdBQUdSLG9CQUFvQixDQUFDLENBQUQsQ0FBdkM7QUFDQSxVQUFNRyxnQkFBZ0IsQ0FBQ0ssWUFBRCxFQUFlLFFBQWYsQ0FBdEI7QUFDQSxRQUFJQyxRQUFRLEdBQUdULG9CQUFvQixDQUFDLENBQUQsQ0FBbkM7QUFDQSxVQUFNRyxnQkFBZ0IsQ0FBQ00sUUFBRCxFQUFXLElBQVgsQ0FBdEI7O0FBRUFwQyxJQUFBQSxLQUFLLENBQUNtQixNQUFOLEdBQWUsWUFBWTtBQUN6QixZQUFNLEtBQUt0QixZQUFMLENBQW1CLFlBQVcrQixvQkFBS0MsYUFBTCxDQUFtQk0sWUFBbkIsQ0FBaUMsUUFBL0QsRUFBd0UsTUFBeEUsQ0FBTjtBQUNELEtBRkQ7O0FBR0FuQyxJQUFBQSxLQUFLLENBQUNpQixFQUFOLEdBQVcsWUFBWTtBQUNyQixZQUFNLEtBQUtwQixZQUFMLENBQW1CLFlBQVcrQixvQkFBS0MsYUFBTCxDQUFtQk8sUUFBbkIsQ0FBNkIsUUFBM0QsRUFBb0UsTUFBcEUsQ0FBTjtBQUNELEtBRkQ7QUFHRDs7QUFFRHBDLEVBQUFBLEtBQUssQ0FBQ0UsT0FBTixHQUFnQixZQUFZO0FBQzFCLFFBQUltQyxRQUFRLEdBQUcsTUFBTSxLQUFLWiwyQkFBTCxDQUFpQyxZQUFqQyxFQUErQyx5QkFBL0MsRUFBMEUsS0FBMUUsRUFBaUZHLG9CQUFLQyxhQUFMLENBQW1CN0IsS0FBbkIsQ0FBakYsQ0FBckI7QUFDQSxXQUFPLE1BQU0sS0FBS0gsWUFBTCxDQUFtQixZQUFXK0Isb0JBQUtDLGFBQUwsQ0FBbUJRLFFBQW5CLENBQTZCLGtCQUEzRCxFQUE4RSxLQUE5RSxDQUFiO0FBQ0QsR0FIRDs7QUFJQXJDLEVBQUFBLEtBQUssQ0FBQ1EsT0FBTixHQUFnQixNQUFPSixLQUFQLElBQWlCO0FBQy9CLFFBQUk7QUFDRixVQUFJaUMsUUFBUSxHQUFHLE1BQU0sS0FBS1osMkJBQUwsQ0FBaUMsWUFBakMsRUFBK0MsMEJBQS9DLEVBQTJFLEtBQTNFLEVBQWtGRyxvQkFBS0MsYUFBTCxDQUFtQjdCLEtBQW5CLENBQWxGLENBQXJCO0FBQ0EsWUFBTSxLQUFLSCxZQUFMLENBQW1CLFlBQVcrQixvQkFBS0MsYUFBTCxDQUFtQlEsUUFBbkIsQ0FBNkIsU0FBM0QsRUFBcUUsTUFBckUsRUFBNkU7QUFBQ2pDLFFBQUFBO0FBQUQsT0FBN0UsQ0FBTjtBQUNELEtBSEQsQ0FHRSxPQUFPTixHQUFQLEVBQVk7QUFDWixVQUFJLG1DQUFZQSxHQUFaLEVBQWlCZ0IseUJBQU93QixrQkFBeEIsQ0FBSixFQUFpRDtBQUMvQyxjQUFNLElBQUlmLEtBQUosQ0FBVSxxREFBVixDQUFOO0FBQ0Q7O0FBQ0QsWUFBTXpCLEdBQU47QUFDRDtBQUNGLEdBVkQ7O0FBWUEsU0FBT0UsS0FBUDtBQUNELENBNUREOztBQStEQXVDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjN0MsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcnJvcnMsIGlzRXJyb3JUeXBlIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbW1hbmRzLmdldEFsZXJ0VGV4dCA9IGFzeW5jIGZ1bmN0aW9uIGdldEFsZXJ0VGV4dCAoKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvYWxlcnQvdGV4dCcsICdHRVQnKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICAgIGNvbnN0IGFsZXJ0ID0gYXdhaXQgdGhpcy5nZXRBbGVydCgpO1xuICAgICAgcmV0dXJuIGF3YWl0IGFsZXJ0LmdldFRleHQoKTtcbiAgICB9XG4gICAgdGhyb3cgZXJyO1xuICB9XG59O1xuXG5jb21tYW5kcy5zZXRBbGVydFRleHQgPSBhc3luYyBmdW5jdGlvbiBzZXRBbGVydFRleHQgKHZhbHVlKSB7XG4gIGlmIChfLmlzU3RyaW5nKHZhbHVlKSkge1xuICAgIHZhbHVlID0gdmFsdWUuc3BsaXQoJycpO1xuICB9XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvYWxlcnQvdGV4dCcsICdQT1NUJywge3ZhbHVlfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgICBjb25zdCBhbGVydCA9IGF3YWl0IHRoaXMuZ2V0QWxlcnQoKTtcbiAgICAgIHJldHVybiBhd2FpdCBhbGVydC5zZXRUZXh0KHZhbHVlKTtcbiAgICB9XG4gICAgdGhyb3cgZXJyO1xuICB9XG59O1xuXG5jb21tYW5kcy5wb3N0QWNjZXB0QWxlcnQgPSBhc3luYyBmdW5jdGlvbiBwb3N0QWNjZXB0QWxlcnQgKG9wdHMgPSB7fSkge1xuICB0cnkge1xuICAgIGxldCBwYXJhbXMgPSB7fTtcbiAgICBpZiAob3B0cy5idXR0b25MYWJlbCkge1xuICAgICAgcGFyYW1zLm5hbWUgPSBvcHRzLmJ1dHRvbkxhYmVsO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9hbGVydC9hY2NlcHQnLCAnUE9TVCcsIHBhcmFtcyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob0FsZXJ0T3BlbkVycm9yKCk7XG4gICAgfVxuXG4gICAgbGV0IGFsZXJ0ID0gYXdhaXQgdGhpcy5nZXRBbGVydCgpO1xuICAgIGlmIChhbGVydC5jbG9zZSkge1xuICAgICAgcmV0dXJuIGF3YWl0IGFsZXJ0LmNsb3NlKCk7XG4gICAgfVxuICAgIGF3YWl0IGFsZXJ0Lm9rKCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnBvc3REaXNtaXNzQWxlcnQgPSBhc3luYyBmdW5jdGlvbiBwb3N0RGlzbWlzc0FsZXJ0IChvcHRzID0ge30pIHtcbiAgdHJ5IHtcbiAgICBsZXQgcGFyYW1zID0ge307XG4gICAgaWYgKG9wdHMuYnV0dG9uTGFiZWwpIHtcbiAgICAgIHBhcmFtcy5uYW1lID0gb3B0cy5idXR0b25MYWJlbDtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvYWxlcnQvZGlzbWlzcycsICdQT1NUJywgcGFyYW1zKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vQWxlcnRPcGVuRXJyb3IoKTtcbiAgICB9XG5cbiAgICBsZXQgYWxlcnQgPSBhd2FpdCB0aGlzLmdldEFsZXJ0KCk7XG4gICAgaWYgKGFsZXJ0LmNsb3NlKSB7XG4gICAgICByZXR1cm4gYXdhaXQgYWxlcnQuY2xvc2UoKTtcbiAgICB9XG4gICAgYXdhaXQgYWxlcnQuY2FuY2VsKCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldEFsZXJ0QnV0dG9ucyA9IGFzeW5jIGZ1bmN0aW9uIGdldEFsZXJ0QnV0dG9ucyAoKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvd2RhL2FsZXJ0L2J1dHRvbnMnLCAnR0VUJyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9BbGVydE9wZW5FcnJvcigpO1xuICB9XG59O1xuXG5jb21tYW5kcy5tb2JpbGVIYW5kbGVBbGVydCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZUhhbmRsZUFsZXJ0IChvcHRzID0ge30pIHtcbiAgc3dpdGNoIChvcHRzLmFjdGlvbikge1xuICAgIGNhc2UgJ2FjY2VwdCc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wb3N0QWNjZXB0QWxlcnQob3B0cyk7XG4gICAgY2FzZSAnZGlzbWlzcyc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wb3N0RGlzbWlzc0FsZXJ0KG9wdHMpO1xuICAgIGNhc2UgJ2dldEJ1dHRvbnMnOlxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0QWxlcnRCdXR0b25zKCk7XG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlICdhY3Rpb24nIHZhbHVlIHNob3VsZCBiZSBlaXRoZXIgJ2FjY2VwdCcsICdkaXNtaXNzJyBvciAnZ2V0QnV0dG9ucycuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGAnJHtvcHRzLmFjdGlvbn0nIGlzIHByb3ZpZGVkIGluc3RlYWQuYCk7XG4gIH1cbn07XG5cbmhlbHBlcnMuZ2V0QWxlcnQgPSBhc3luYyBmdW5jdGlvbiBnZXRBbGVydCAoKSB7XG4gIGxldCBwb3NzaWJsZUFsZXJ0ID0gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2NsYXNzIG5hbWUnLCAnWENVSUVsZW1lbnRUeXBlU2Nyb2xsVmlldycsIHRydWUpO1xuICBpZiAocG9zc2libGVBbGVydC5sZW5ndGggIT09IDEpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vQWxlcnRPcGVuRXJyb3IoKTtcbiAgfVxuXG4gIGxldCBwb3NzaWJsZUFsZXJ0QnV0dG9ucyA9IGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1hDVUlFbGVtZW50VHlwZUJ1dHRvbicsIHRydWUsIHV0aWwudW53cmFwRWxlbWVudChwb3NzaWJsZUFsZXJ0WzBdKSk7XG4gIGlmIChwb3NzaWJsZUFsZXJ0QnV0dG9ucy5sZW5ndGggPCAxIHx8IHBvc3NpYmxlQWxlcnRCdXR0b25zLmxlbmd0aCA+IDIpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vQWxlcnRPcGVuRXJyb3IoKTtcbiAgfVxuXG4gIGxldCBhc3NlcnRCdXR0b25OYW1lID0gYXN5bmMgKGJ1dHRvbiwgZXhwZWN0ZWROYW1lKSA9PiB7XG4gICAgYnV0dG9uID0gdXRpbC51bndyYXBFbGVtZW50KGJ1dHRvbik7XG4gICAgbGV0IG5hbWUgPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChgL2VsZW1lbnQvJHtidXR0b259L2F0dHJpYnV0ZS9uYW1lYCwgJ0dFVCcpO1xuICAgIGlmIChuYW1lLnRvTG93ZXJDYXNlKCkgIT09IGV4cGVjdGVkTmFtZSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob0FsZXJ0T3BlbkVycm9yKCk7XG4gICAgfVxuICB9O1xuXG4gIGxldCBhbGVydCA9IHBvc3NpYmxlQWxlcnRbMF07XG4gIGlmIChwb3NzaWJsZUFsZXJ0QnV0dG9ucy5sZW5ndGggPT09IDEpIHtcbiAgICAvLyBtYWtlIHN1cmUgdGhlIGJ1dHRvbiBpcyAnQ2xvc2UnXG4gICAgbGV0IGNsb3NlQnV0dG9uID0gcG9zc2libGVBbGVydEJ1dHRvbnNbMF07XG4gICAgYXdhaXQgYXNzZXJ0QnV0dG9uTmFtZShjbG9zZUJ1dHRvbiwgJ2Nsb3NlJyk7XG5cbiAgICBhbGVydC5jbG9zZSA9IGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke3V0aWwudW53cmFwRWxlbWVudChjbG9zZUJ1dHRvbil9L2NsaWNrYCwgJ1BPU1QnKTtcbiAgICB9O1xuICB9IGVsc2Uge1xuICAgIC8vIGVuc3VyZSB0aGUgYnV0dG9ucyBhcmUgJ0NhbmNlbCcgYW5kICdPSydcbiAgICBsZXQgY2FuY2VsQnV0dG9uID0gcG9zc2libGVBbGVydEJ1dHRvbnNbMF07XG4gICAgYXdhaXQgYXNzZXJ0QnV0dG9uTmFtZShjYW5jZWxCdXR0b24sICdjYW5jZWwnKTtcbiAgICBsZXQgb2tCdXR0b24gPSBwb3NzaWJsZUFsZXJ0QnV0dG9uc1sxXTtcbiAgICBhd2FpdCBhc3NlcnRCdXR0b25OYW1lKG9rQnV0dG9uLCAnb2snKTtcblxuICAgIGFsZXJ0LmNhbmNlbCA9IGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke3V0aWwudW53cmFwRWxlbWVudChjYW5jZWxCdXR0b24pfS9jbGlja2AsICdQT1NUJyk7XG4gICAgfTtcbiAgICBhbGVydC5vayA9IGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke3V0aWwudW53cmFwRWxlbWVudChva0J1dHRvbil9L2NsaWNrYCwgJ1BPU1QnKTtcbiAgICB9O1xuICB9XG5cbiAgYWxlcnQuZ2V0VGV4dCA9IGFzeW5jICgpID0+IHtcbiAgICBsZXQgdGV4dFZpZXcgPSBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnY2xhc3MgbmFtZScsICdYQ1VJRWxlbWVudFR5cGVUZXh0VmlldycsIGZhbHNlLCB1dGlsLnVud3JhcEVsZW1lbnQoYWxlcnQpKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7dXRpbC51bndyYXBFbGVtZW50KHRleHRWaWV3KX0vYXR0cmlidXRlL3ZhbHVlYCwgJ0dFVCcpO1xuICB9O1xuICBhbGVydC5zZXRUZXh0ID0gYXN5bmMgKHZhbHVlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCB0ZXh0VmlldyA9IGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1hDVUlFbGVtZW50VHlwZVRleHRGaWVsZCcsIGZhbHNlLCB1dGlsLnVud3JhcEVsZW1lbnQoYWxlcnQpKTtcbiAgICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke3V0aWwudW53cmFwRWxlbWVudCh0ZXh0Vmlldyl9L3ZhbHVlIGAsICdQT1NUJywge3ZhbHVlfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoaXNFcnJvclR5cGUoZXJyLCBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyaWVkIHRvIHNldCB0ZXh0IG9mIGFuIGFsZXJ0IHRoYXQgd2FzIG5vdCBhIHByb21wdCcpO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfTtcblxuICByZXR1cm4gYWxlcnQ7XG59O1xuXG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9hbGVydC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9

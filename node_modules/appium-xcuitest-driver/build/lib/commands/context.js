"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumIosDriver = require("appium-ios-driver");

var _appiumRemoteDebugger = require("appium-remote-debugger");

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

const WEBVIEW_BASE = `${_appiumIosDriver.WEBVIEW_WIN}_`;
let commands = {},
    helpers = {},
    extensions = {};
Object.assign(extensions, _appiumIosDriver.iosCommands.context);

extensions.closeAlertBeforeTest = async function closeAlertBeforeTest() {
  return true;
};

extensions.navToInitialWebview = async function navToInitialWebview() {
  if (this.useNewSafari()) {
    await this.typeAndNavToUrl();
  } else if (!this.isRealDevice() && this.opts.safari) {
    await this.navToViewThroughFavorites();
  } else {
    await this.navToViewWithTitle(/.*/);
  }
};

extensions.getLatestWebviewContextForTitle = async function getLatestWebviewContextForTitle(regExp) {
  const currentUrl = this.getCurrentUrl();

  const contexts = _lodash.default.filter((await this.getContextsAndViews()), 'view');

  if (currentUrl) {
    for (const ctx of contexts) {
      if ((ctx.view.url || '') === this.getCurrentUrl()) {
        return ctx.id;
      }
    }
  }

  for (const ctx of contexts) {
    if (ctx.view.title && regExp.test(ctx.view.title) || ctx.view.url && regExp.test(ctx.view.url)) {
      return ctx.id;
    }
  }
};

extensions.isWebContext = function isWebContext() {
  return !!this.curContext && this.curContext !== _appiumIosDriver.iosCommands.context.NATIVE_WIN;
};

extensions.isWebview = function isWebview() {
  return this.isWebContext();
};

extensions.getNewRemoteDebugger = async function getNewRemoteDebugger() {
  let socketPath;

  if (!this.isRealDevice()) {
    socketPath = await this.opts.device.getWebInspectorSocket();
  }

  return (0, _appiumRemoteDebugger.createRemoteDebugger)({
    bundleId: this.opts.bundleId,
    isSafari: this.isSafari(),
    includeSafari: this.opts.includeSafariInWebviews,
    useNewSafari: this.useNewSafari(),
    pageLoadMs: this.pageLoadMs,
    platformVersion: this.opts.platformVersion,
    socketPath,
    remoteDebugProxy: this.opts.remoteDebugProxy,
    garbageCollectOnExecute: _appiumSupport.util.hasValue(this.opts.safariGarbageCollect) ? !!this.opts.safariGarbageCollect : false,
    udid: this.opts.udid
  }, this.isRealDevice());
};

commands.setContext = async function setContext(name, callback, skipReadyCheck) {
  function alreadyInContext(desired, current) {
    return desired === current || desired === null && current === _appiumIosDriver.NATIVE_WIN || desired === _appiumIosDriver.NATIVE_WIN && current === null;
  }

  function isNativeContext(context) {
    return context === _appiumIosDriver.NATIVE_WIN || context === null;
  }

  _logger.default.debug(`Attempting to set context to '${name}'`);

  if (alreadyInContext(name, this.curContext)) {
    return;
  }

  if (isNativeContext(name)) {
    this.curContext = null;
    return;
  }

  if (_lodash.default.isUndefined(this.contexts)) {
    await this.getContexts();
  }

  let contextId = name.replace(WEBVIEW_BASE, '');

  if (contextId === '') {
    contextId = this.contexts[1];
  }

  if (!_lodash.default.includes(this.contexts, contextId)) {
    throw new _appiumBaseDriver.errors.NoSuchContextError();
  }

  const [appIdKey, pageIdKey] = _lodash.default.map(contextId.split('.'), id => parseInt(id, 10));

  await this.remote.selectPage(appIdKey, pageIdKey, skipReadyCheck);
  this.curContext = contextId;

  if (this.opts.enablePerformanceLogging && this.remote) {
    _logger.default.debug(`Starting performance log on '${this.curContext}'`);

    this.logs.performance = new _appiumIosDriver.IOSPerformanceLog(this.remote);
    await this.logs.performance.startCapture();
  }

  if (name && name !== _appiumIosDriver.NATIVE_WIN && this.logs) {
    if (this.logs.safariConsole) {
      await this.remote.startConsole(this.logs.safariConsole.addLogLine.bind(this.logs.safariConsole));
    }

    if (this.logs.safariNetwork) {
      await this.remote.startNetwork(this.logs.safariNetwork.addLogLine.bind(this.logs.safariNetwork));
    }
  }
};

extensions.listWebFrames = async function listWebFrames(useUrl = true) {
  if (!this.opts.bundleId) {
    _logger.default.errorAndThrow('Cannot enter web frame without a bundle ID');
  }

  useUrl = useUrl && !this.isRealDevice() && !!this.getCurrentUrl();

  _logger.default.debug(`Selecting by url: ${useUrl} ${useUrl ? `(expected url: '${this.getCurrentUrl()}')` : ''}`);

  const currentUrl = useUrl ? this.getCurrentUrl() : undefined;
  let pageArray = [];

  const getWebviewPages = async () => {
    try {
      return await this.remote.selectApp(currentUrl, this.opts.webviewConnectRetries, this.opts.ignoreAboutBlankUrl);
    } catch (err) {
      _logger.default.debug(`No available web pages: ${err.message}`);

      return [];
    }
  };

  if (this.remote && this.remote.appIdKey) {
    pageArray = await getWebviewPages();
  } else {
    this.remote = await this.getNewRemoteDebugger();
    let appInfo = await this.remote.connect();

    if (!appInfo) {
      _logger.default.debug('Unable to connect to the remote debugger.');

      return [];
    }

    pageArray = await getWebviewPages();
    this.remote.on(_appiumRemoteDebugger.RemoteDebugger.EVENT_PAGE_CHANGE, this.onPageChange.bind(this));
    this.remote.on(_appiumRemoteDebugger.RemoteDebugger.EVENT_FRAMES_DETACHED, () => {
      if (!_lodash.default.isEmpty(this.curWebFrames)) {
        _logger.default.debug(`Clearing ${this.curWebFrames.length} frames: ${this.curWebFrames.join(', ')}`);
      }

      this.curWebFrames = [];
    });
    const alertErrorMsg = 'Close alert failed. Retry.';

    try {
      await (0, _asyncbox.retryInterval)(6, 1000, async () => {
        if (!(await this.closeAlertBeforeTest())) {
          throw new Error(alertErrorMsg);
        }
      });
    } catch (err) {
      if (err.message !== alertErrorMsg) {
        _logger.default.errorAndThrow(err);
      }
    }
  }

  if (pageArray.length === 0) {
    _logger.default.debug('No web frames found.');
  }

  return pageArray;
};

extensions.mobileGetContexts = async function mobileGetContexts() {
  const curOpt = this.opts.fullContextList;

  try {
    this.opts.fullContextList = true;
    return await this.getContexts();
  } finally {
    this.opts.fullContextList = curOpt;
  }
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIl0sIm5hbWVzIjpbIldFQlZJRVdfQkFTRSIsIldFQlZJRVdfV0lOIiwiY29tbWFuZHMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsIk9iamVjdCIsImFzc2lnbiIsImlvc0NvbW1hbmRzIiwiY29udGV4dCIsImNsb3NlQWxlcnRCZWZvcmVUZXN0IiwibmF2VG9Jbml0aWFsV2VidmlldyIsInVzZU5ld1NhZmFyaSIsInR5cGVBbmROYXZUb1VybCIsImlzUmVhbERldmljZSIsIm9wdHMiLCJzYWZhcmkiLCJuYXZUb1ZpZXdUaHJvdWdoRmF2b3JpdGVzIiwibmF2VG9WaWV3V2l0aFRpdGxlIiwiZ2V0TGF0ZXN0V2Vidmlld0NvbnRleHRGb3JUaXRsZSIsInJlZ0V4cCIsImN1cnJlbnRVcmwiLCJnZXRDdXJyZW50VXJsIiwiY29udGV4dHMiLCJfIiwiZmlsdGVyIiwiZ2V0Q29udGV4dHNBbmRWaWV3cyIsImN0eCIsInZpZXciLCJ1cmwiLCJpZCIsInRpdGxlIiwidGVzdCIsImlzV2ViQ29udGV4dCIsImN1ckNvbnRleHQiLCJOQVRJVkVfV0lOIiwiaXNXZWJ2aWV3IiwiZ2V0TmV3UmVtb3RlRGVidWdnZXIiLCJzb2NrZXRQYXRoIiwiZGV2aWNlIiwiZ2V0V2ViSW5zcGVjdG9yU29ja2V0IiwiYnVuZGxlSWQiLCJpc1NhZmFyaSIsImluY2x1ZGVTYWZhcmkiLCJpbmNsdWRlU2FmYXJpSW5XZWJ2aWV3cyIsInBhZ2VMb2FkTXMiLCJwbGF0Zm9ybVZlcnNpb24iLCJyZW1vdGVEZWJ1Z1Byb3h5IiwiZ2FyYmFnZUNvbGxlY3RPbkV4ZWN1dGUiLCJ1dGlsIiwiaGFzVmFsdWUiLCJzYWZhcmlHYXJiYWdlQ29sbGVjdCIsInVkaWQiLCJzZXRDb250ZXh0IiwibmFtZSIsImNhbGxiYWNrIiwic2tpcFJlYWR5Q2hlY2siLCJhbHJlYWR5SW5Db250ZXh0IiwiZGVzaXJlZCIsImN1cnJlbnQiLCJpc05hdGl2ZUNvbnRleHQiLCJsb2ciLCJkZWJ1ZyIsImlzVW5kZWZpbmVkIiwiZ2V0Q29udGV4dHMiLCJjb250ZXh0SWQiLCJyZXBsYWNlIiwiaW5jbHVkZXMiLCJlcnJvcnMiLCJOb1N1Y2hDb250ZXh0RXJyb3IiLCJhcHBJZEtleSIsInBhZ2VJZEtleSIsIm1hcCIsInNwbGl0IiwicGFyc2VJbnQiLCJyZW1vdGUiLCJzZWxlY3RQYWdlIiwiZW5hYmxlUGVyZm9ybWFuY2VMb2dnaW5nIiwibG9ncyIsInBlcmZvcm1hbmNlIiwiSU9TUGVyZm9ybWFuY2VMb2ciLCJzdGFydENhcHR1cmUiLCJzYWZhcmlDb25zb2xlIiwic3RhcnRDb25zb2xlIiwiYWRkTG9nTGluZSIsImJpbmQiLCJzYWZhcmlOZXR3b3JrIiwic3RhcnROZXR3b3JrIiwibGlzdFdlYkZyYW1lcyIsInVzZVVybCIsImVycm9yQW5kVGhyb3ciLCJ1bmRlZmluZWQiLCJwYWdlQXJyYXkiLCJnZXRXZWJ2aWV3UGFnZXMiLCJzZWxlY3RBcHAiLCJ3ZWJ2aWV3Q29ubmVjdFJldHJpZXMiLCJpZ25vcmVBYm91dEJsYW5rVXJsIiwiZXJyIiwibWVzc2FnZSIsImFwcEluZm8iLCJjb25uZWN0Iiwib24iLCJSZW1vdGVEZWJ1Z2dlciIsIkVWRU5UX1BBR0VfQ0hBTkdFIiwib25QYWdlQ2hhbmdlIiwiRVZFTlRfRlJBTUVTX0RFVEFDSEVEIiwiaXNFbXB0eSIsImN1cldlYkZyYW1lcyIsImxlbmd0aCIsImpvaW4iLCJhbGVydEVycm9yTXNnIiwiRXJyb3IiLCJtb2JpbGVHZXRDb250ZXh0cyIsImN1ck9wdCIsImZ1bGxDb250ZXh0TGlzdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxZQUFZLEdBQUksR0FBRUMsNEJBQVksR0FBcEM7QUFFQSxJQUFJQyxRQUFRLEdBQUcsRUFBZjtBQUFBLElBQW1CQyxPQUFPLEdBQUcsRUFBN0I7QUFBQSxJQUFpQ0MsVUFBVSxHQUFHLEVBQTlDO0FBRUFDLE1B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LG9CQUFMLEVBQVAsQ0FBSixFQUF3QztBQUN0QyxnQkFBTSxJQUFJcUcsS0FBSixDQUFVRCxhQUFWLENBQU47QUFDRDtBQUNGLE9BSkssQ0FBTjtBQUtELEtBTkQsQ0FNRSxPQUFPYixHQUFQLEVBQVk7QUFHWixVQUFJQSxHQUFHLENBQUNDLE9BQUosS0FBZ0JZLGFBQXBCLEVBQW1DO0FBQ2pDakQsd0JBQUk2QixhQUFKLENBQWtCTyxHQUFsQjtBQUNEO0FBQ0Y7QUFDRjs7QUFFRCxNQUFJTCxTQUFTLENBQUNnQixNQUFWLEtBQXFCLENBQXpCLEVBQTRCO0FBRTFCL0Msb0JBQUlDLEtBQUosQ0FBVSxzQkFBVjtBQUNEOztBQUNELFNBQU84QixTQUFQO0FBQ0QsQ0E3REQ7O0FBOEVBdkYsVUFBVSxDQUFDMkcsaUJBQVgsR0FBK0IsZUFBZUEsaUJBQWYsR0FBb0M7QUFDakUsUUFBTUMsTUFBTSxHQUFHLEtBQUtsRyxJQUFMLENBQVVtRyxlQUF6Qjs7QUFDQSxNQUFJO0FBR0YsU0FBS25HLElBQUwsQ0FBVW1HLGVBQVYsR0FBNEIsSUFBNUI7QUFDQSxXQUFPLE1BQU0sS0FBS2xELFdBQUwsRUFBYjtBQUNELEdBTEQsU0FLVTtBQUVSLFNBQUtqRCxJQUFMLENBQVVtRyxlQUFWLEdBQTRCRCxNQUE1QjtBQUNEO0FBQ0YsQ0FYRDs7QUFjQTNHLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjRixVQUFkLEVBQTBCRixRQUExQixFQUFvQ0MsT0FBcEM7ZUFDZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlvc0NvbW1hbmRzLCBJT1NQZXJmb3JtYW5jZUxvZywgTkFUSVZFX1dJTiwgV0VCVklFV19XSU4gfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgeyBjcmVhdGVSZW1vdGVEZWJ1Z2dlciwgUmVtb3RlRGVidWdnZXIgfSBmcm9tICdhcHBpdW0tcmVtb3RlLWRlYnVnZ2VyJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cblxuY29uc3QgV0VCVklFV19CQVNFID0gYCR7V0VCVklFV19XSU59X2A7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBpb3NDb21tYW5kcy5jb250ZXh0KTtcblxuLy8gb3ZlcnJpZGUsIGFzIGFwcGl1bS1pb3MtZHJpdmVyJ3MgdmVyc2lvbiB1c2VzIFVJIEF1dG9tYXRpb24gdG8gY2xvc2VcbmV4dGVuc2lvbnMuY2xvc2VBbGVydEJlZm9yZVRlc3QgPSBhc3luYyBmdW5jdGlvbiBjbG9zZUFsZXJ0QmVmb3JlVGVzdCAoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICByZXR1cm4gdHJ1ZTtcbn07XG5cbi8vIHRoZSBhcHBpdW0taW9zLWRyaXZlciB2ZXJzaW9uIGhhcyBhIHdhaXQgb24gcmVhbCBkZXZpY2VzLCB3aGljaCBpcyBubyBsb25nZXJcbi8vIG5lY2Vzc2FyeVxuZXh0ZW5zaW9ucy5uYXZUb0luaXRpYWxXZWJ2aWV3ID0gYXN5bmMgZnVuY3Rpb24gbmF2VG9Jbml0aWFsV2VidmlldyAoKSB7XG4gIGlmICh0aGlzLnVzZU5ld1NhZmFyaSgpKSB7XG4gICAgYXdhaXQgdGhpcy50eXBlQW5kTmF2VG9VcmwoKTtcbiAgfSBlbHNlIGlmICghdGhpcy5pc1JlYWxEZXZpY2UoKSAmJiB0aGlzLm9wdHMuc2FmYXJpKSB7XG4gICAgYXdhaXQgdGhpcy5uYXZUb1ZpZXdUaHJvdWdoRmF2b3JpdGVzKCk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgdGhpcy5uYXZUb1ZpZXdXaXRoVGl0bGUoLy4qLyk7XG4gIH1cbn07XG5cbi8vIHRoZSBhcHBpdW0taW9zLWRyaXZlciB2ZXJzaW9uIG9mIHRoaXMgZnVuY3Rpb24gZmFpbHMgaW4gQ0ksXG4vLyBhbmQgdGhlIHdyb25nIHdlYnZpZXcgaXMgYWxtb3N0IGFsd2F5cyByZXRyaWV2ZWRcbi8vIGFsc28gb3ZlcnJpZGUgc28gdGhhdCB0aGUgY2FzZSB3aGVyZSB0aGUgU0RLIHZlcnNpb24gaXMgbm90IHNldCBkb2VzIG5vdCBmYWlsXG5leHRlbnNpb25zLmdldExhdGVzdFdlYnZpZXdDb250ZXh0Rm9yVGl0bGUgPSBhc3luYyBmdW5jdGlvbiBnZXRMYXRlc3RXZWJ2aWV3Q29udGV4dEZvclRpdGxlIChyZWdFeHApIHtcbiAgY29uc3QgY3VycmVudFVybCA9IHRoaXMuZ2V0Q3VycmVudFVybCgpO1xuXG4gIGNvbnN0IGNvbnRleHRzID0gXy5maWx0ZXIoYXdhaXQgdGhpcy5nZXRDb250ZXh0c0FuZFZpZXdzKCksICd2aWV3Jyk7XG5cbiAgaWYgKGN1cnJlbnRVcmwpIHtcbiAgICAvLyBmaXJzdCB0cnkgdG8gbWF0Y2ggYnkgY3VycmVudCB1cmxcbiAgICBmb3IgKGNvbnN0IGN0eCBvZiBjb250ZXh0cykge1xuICAgICAgaWYgKChjdHgudmlldy51cmwgfHwgJycpID09PSB0aGlzLmdldEN1cnJlbnRVcmwoKSkge1xuICAgICAgICByZXR1cm4gY3R4LmlkO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIGlmIG5vdCwgdHJ5IHRvIG1hdGNoIGJ5IHJlZ3VsYXIgZXhwcmVzc2lvblxuICBmb3IgKGNvbnN0IGN0eCBvZiBjb250ZXh0cykge1xuICAgIGlmICgoY3R4LnZpZXcudGl0bGUgJiYgcmVnRXhwLnRlc3QoY3R4LnZpZXcudGl0bGUpKSB8fCAoY3R4LnZpZXcudXJsICYmIHJlZ0V4cC50ZXN0KGN0eC52aWV3LnVybCkpKSB7XG4gICAgICByZXR1cm4gY3R4LmlkO1xuICAgIH1cbiAgfVxufTtcblxuZXh0ZW5zaW9ucy5pc1dlYkNvbnRleHQgPSBmdW5jdGlvbiBpc1dlYkNvbnRleHQgKCkge1xuICByZXR1cm4gISF0aGlzLmN1ckNvbnRleHQgJiYgdGhpcy5jdXJDb250ZXh0ICE9PSBpb3NDb21tYW5kcy5jb250ZXh0Lk5BVElWRV9XSU47XG59O1xuXG5leHRlbnNpb25zLmlzV2VidmlldyA9IGZ1bmN0aW9uIGlzV2VidmlldyAoKSB7XG4gIHJldHVybiB0aGlzLmlzV2ViQ29udGV4dCgpO1xufTtcblxuZXh0ZW5zaW9ucy5nZXROZXdSZW1vdGVEZWJ1Z2dlciA9IGFzeW5jIGZ1bmN0aW9uIGdldE5ld1JlbW90ZURlYnVnZ2VyICgpIHtcbiAgbGV0IHNvY2tldFBhdGg7XG4gIGlmICghdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIHNvY2tldFBhdGggPSBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLmdldFdlYkluc3BlY3RvclNvY2tldCgpO1xuICB9XG4gIHJldHVybiBjcmVhdGVSZW1vdGVEZWJ1Z2dlcih7XG4gICAgYnVuZGxlSWQ6IHRoaXMub3B0cy5idW5kbGVJZCxcbiAgICBpc1NhZmFyaTogdGhpcy5pc1NhZmFyaSgpLFxuICAgIGluY2x1ZGVTYWZhcmk6IHRoaXMub3B0cy5pbmNsdWRlU2FmYXJpSW5XZWJ2aWV3cyxcbiAgICB1c2VOZXdTYWZhcmk6IHRoaXMudXNlTmV3U2FmYXJpKCksXG4gICAgcGFnZUxvYWRNczogdGhpcy5wYWdlTG9hZE1zLFxuICAgIHBsYXRmb3JtVmVyc2lvbjogdGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbixcbiAgICBzb2NrZXRQYXRoLFxuICAgIHJlbW90ZURlYnVnUHJveHk6IHRoaXMub3B0cy5yZW1vdGVEZWJ1Z1Byb3h5LFxuICAgIGdhcmJhZ2VDb2xsZWN0T25FeGVjdXRlOiB1dGlsLmhhc1ZhbHVlKHRoaXMub3B0cy5zYWZhcmlHYXJiYWdlQ29sbGVjdClcbiAgICAgID8gISF0aGlzLm9wdHMuc2FmYXJpR2FyYmFnZUNvbGxlY3RcbiAgICAgIDogZmFsc2UsXG4gICAgdWRpZDogdGhpcy5vcHRzLnVkaWQsXG4gIH0sIHRoaXMuaXNSZWFsRGV2aWNlKCkpO1xufTtcblxuY29tbWFuZHMuc2V0Q29udGV4dCA9IGFzeW5jIGZ1bmN0aW9uIHNldENvbnRleHQgKG5hbWUsIGNhbGxiYWNrLCBza2lwUmVhZHlDaGVjaykge1xuICBmdW5jdGlvbiBhbHJlYWR5SW5Db250ZXh0IChkZXNpcmVkLCBjdXJyZW50KSB7XG4gICAgcmV0dXJuIChkZXNpcmVkID09PSBjdXJyZW50IHx8XG4gICAgICAgICAgIChkZXNpcmVkID09PSBudWxsICYmIGN1cnJlbnQgPT09IE5BVElWRV9XSU4pIHx8XG4gICAgICAgICAgIChkZXNpcmVkID09PSBOQVRJVkVfV0lOICYmIGN1cnJlbnQgPT09IG51bGwpKTtcbiAgfVxuICBmdW5jdGlvbiBpc05hdGl2ZUNvbnRleHQgKGNvbnRleHQpIHtcbiAgICByZXR1cm4gY29udGV4dCA9PT0gTkFUSVZFX1dJTiB8fCBjb250ZXh0ID09PSBudWxsO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBBdHRlbXB0aW5nIHRvIHNldCBjb250ZXh0IHRvICcke25hbWV9J2ApO1xuICBpZiAoYWxyZWFkeUluQ29udGV4dChuYW1lLCB0aGlzLmN1ckNvbnRleHQpKSB7XG4gICAgLy8gYWxyZWFkeSBpbiB0aGUgbmFtZWQgY29udGV4dCwgbm8gbmVlZCB0byBkbyBhbnl0aGluZ1xuICAgIHJldHVybjtcbiAgfVxuICBpZiAoaXNOYXRpdmVDb250ZXh0KG5hbWUpKSB7XG4gICAgLy8gc3dpdGNoaW5nIGludG8gdGhlIG5hdGl2ZSBjb250ZXh0XG4gICAgdGhpcy5jdXJDb250ZXh0ID0gbnVsbDtcbiAgICByZXR1cm47XG4gIH1cblxuICAvLyBzd2l0Y2hpbmcgaW50byBhIHdlYnZpZXcgY29udGV4dFxuXG4gIC8vIGlmIGNvbnRleHRzIGhhdmUgbm90IGFscmVhZHkgYmVlbiByZXRyaWV2ZWQsIGdldCB0aGVtXG4gIGlmIChfLmlzVW5kZWZpbmVkKHRoaXMuY29udGV4dHMpKSB7XG4gICAgYXdhaXQgdGhpcy5nZXRDb250ZXh0cygpO1xuICB9XG5cbiAgbGV0IGNvbnRleHRJZCA9IG5hbWUucmVwbGFjZShXRUJWSUVXX0JBU0UsICcnKTtcbiAgaWYgKGNvbnRleHRJZCA9PT0gJycpIHtcbiAgICAvLyBhbGxvdyB1c2VyIHRvIHBhc3MgaW4gXCJXRUJWSUVXXCIgd2l0aG91dCBhbiBpbmRleFxuICAgIC8vIHRoZSBzZWNvbmQgY29udGV4dCB3aWxsIGJlIHRoZSBmaXJzdCB3ZWJ2aWV3IGFzXG4gICAgLy8gdGhlIGZpcnN0IGlzIGFsd2F5cyBOQVRJVkVfQVBQXG4gICAgY29udGV4dElkID0gdGhpcy5jb250ZXh0c1sxXTtcbiAgfVxuICBpZiAoIV8uaW5jbHVkZXModGhpcy5jb250ZXh0cywgY29udGV4dElkKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoQ29udGV4dEVycm9yKCk7XG4gIH1cblxuICAvLyBgY29udGV4dElkYCB3aWxsIGJlIGluIHRoZSBmb3JtIG9mIGBhcHBJZC5wYWdlSWRgIGluIHRoaXMgY2FzZVxuICBjb25zdCBbYXBwSWRLZXksIHBhZ2VJZEtleV0gPSBfLm1hcChjb250ZXh0SWQuc3BsaXQoJy4nKSwgKGlkKSA9PiBwYXJzZUludChpZCwgMTApKTtcbiAgYXdhaXQgdGhpcy5yZW1vdGUuc2VsZWN0UGFnZShhcHBJZEtleSwgcGFnZUlkS2V5LCBza2lwUmVhZHlDaGVjayk7XG4gIHRoaXMuY3VyQ29udGV4dCA9IGNvbnRleHRJZDtcblxuICAvLyBhdHRlbXB0IHRvIHN0YXJ0IHBlcmZvcm1hbmNlIGxvZ2dpbmcsIGlmIHJlcXVlc3RlZFxuICBpZiAodGhpcy5vcHRzLmVuYWJsZVBlcmZvcm1hbmNlTG9nZ2luZyAmJiB0aGlzLnJlbW90ZSkge1xuICAgIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgcGVyZm9ybWFuY2UgbG9nIG9uICcke3RoaXMuY3VyQ29udGV4dH0nYCk7XG4gICAgdGhpcy5sb2dzLnBlcmZvcm1hbmNlID0gbmV3IElPU1BlcmZvcm1hbmNlTG9nKHRoaXMucmVtb3RlKTtcbiAgICBhd2FpdCB0aGlzLmxvZ3MucGVyZm9ybWFuY2Uuc3RhcnRDYXB0dXJlKCk7XG4gIH1cblxuICAvLyBzdGFydCBzYWZhcmkgbG9nZ2luZyBpZiB0aGUgbG9ncyBoYW5kbGVycyBhcmUgYWN0aXZlXG4gIGlmIChuYW1lICYmIG5hbWUgIT09IE5BVElWRV9XSU4gJiYgdGhpcy5sb2dzKSB7XG4gICAgaWYgKHRoaXMubG9ncy5zYWZhcmlDb25zb2xlKSB7XG4gICAgICBhd2FpdCB0aGlzLnJlbW90ZS5zdGFydENvbnNvbGUodGhpcy5sb2dzLnNhZmFyaUNvbnNvbGUuYWRkTG9nTGluZS5iaW5kKHRoaXMubG9ncy5zYWZhcmlDb25zb2xlKSk7XG4gICAgfVxuICAgIGlmICh0aGlzLmxvZ3Muc2FmYXJpTmV0d29yaykge1xuICAgICAgYXdhaXQgdGhpcy5yZW1vdGUuc3RhcnROZXR3b3JrKHRoaXMubG9ncy5zYWZhcmlOZXR3b3JrLmFkZExvZ0xpbmUuYmluZCh0aGlzLmxvZ3Muc2FmYXJpTmV0d29yaykpO1xuICAgIH1cbiAgfVxufTtcblxuZXh0ZW5zaW9ucy5saXN0V2ViRnJhbWVzID0gYXN5bmMgZnVuY3Rpb24gbGlzdFdlYkZyYW1lcyAodXNlVXJsID0gdHJ1ZSkge1xuICBpZiAoIXRoaXMub3B0cy5idW5kbGVJZCkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdDYW5ub3QgZW50ZXIgd2ViIGZyYW1lIHdpdGhvdXQgYSBidW5kbGUgSUQnKTtcbiAgfVxuXG4gIHVzZVVybCA9IHVzZVVybCAmJiAhdGhpcy5pc1JlYWxEZXZpY2UoKSAmJiAhIXRoaXMuZ2V0Q3VycmVudFVybCgpO1xuICBsb2cuZGVidWcoYFNlbGVjdGluZyBieSB1cmw6ICR7dXNlVXJsfSAke3VzZVVybCA/IGAoZXhwZWN0ZWQgdXJsOiAnJHt0aGlzLmdldEN1cnJlbnRVcmwoKX0nKWAgOiAnJ31gKTtcblxuICBjb25zdCBjdXJyZW50VXJsID0gdXNlVXJsID8gdGhpcy5nZXRDdXJyZW50VXJsKCkgOiB1bmRlZmluZWQ7XG4gIGxldCBwYWdlQXJyYXkgPSBbXTtcbiAgY29uc3QgZ2V0V2Vidmlld1BhZ2VzID0gYXN5bmMgKCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5yZW1vdGUuc2VsZWN0QXBwKGN1cnJlbnRVcmwsIHRoaXMub3B0cy53ZWJ2aWV3Q29ubmVjdFJldHJpZXMsIHRoaXMub3B0cy5pZ25vcmVBYm91dEJsYW5rVXJsKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgTm8gYXZhaWxhYmxlIHdlYiBwYWdlczogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gIH07XG5cbiAgaWYgKHRoaXMucmVtb3RlICYmIHRoaXMucmVtb3RlLmFwcElkS2V5KSB7XG4gICAgLy8gYWxyZWFkeSBjb25uZWN0ZWRcbiAgICBwYWdlQXJyYXkgPSBhd2FpdCBnZXRXZWJ2aWV3UGFnZXMoKTtcbiAgfSBlbHNlIHtcbiAgICAvLyBub3QgY29ubmVjdGVkXG4gICAgdGhpcy5yZW1vdGUgPSBhd2FpdCB0aGlzLmdldE5ld1JlbW90ZURlYnVnZ2VyKCk7XG5cbiAgICBsZXQgYXBwSW5mbyA9IGF3YWl0IHRoaXMucmVtb3RlLmNvbm5lY3QoKTtcbiAgICBpZiAoIWFwcEluZm8pIHtcbiAgICAgIGxvZy5kZWJ1ZygnVW5hYmxlIHRvIGNvbm5lY3QgdG8gdGhlIHJlbW90ZSBkZWJ1Z2dlci4nKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgcGFnZUFycmF5ID0gYXdhaXQgZ2V0V2Vidmlld1BhZ2VzKCk7XG4gICAgdGhpcy5yZW1vdGUub24oUmVtb3RlRGVidWdnZXIuRVZFTlRfUEFHRV9DSEFOR0UsIHRoaXMub25QYWdlQ2hhbmdlLmJpbmQodGhpcykpO1xuICAgIHRoaXMucmVtb3RlLm9uKFJlbW90ZURlYnVnZ2VyLkVWRU5UX0ZSQU1FU19ERVRBQ0hFRCwgKCkgPT4ge1xuICAgICAgaWYgKCFfLmlzRW1wdHkodGhpcy5jdXJXZWJGcmFtZXMpKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgQ2xlYXJpbmcgJHt0aGlzLmN1cldlYkZyYW1lcy5sZW5ndGh9IGZyYW1lczogJHt0aGlzLmN1cldlYkZyYW1lcy5qb2luKCcsICcpfWApO1xuICAgICAgfVxuICAgICAgdGhpcy5jdXJXZWJGcmFtZXMgPSBbXTtcbiAgICB9KTtcblxuICAgIGNvbnN0IGFsZXJ0RXJyb3JNc2cgPSAnQ2xvc2UgYWxlcnQgZmFpbGVkLiBSZXRyeS4nO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCByZXRyeUludGVydmFsKDYsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgaWYgKCFhd2FpdCB0aGlzLmNsb3NlQWxlcnRCZWZvcmVUZXN0KCkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYWxlcnRFcnJvck1zZyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gaWYgdGhlIGxvb3AgdG8gY2xvc2UgYWxlcnRzIGZhaWxlZCB0byBkaXNtaXNzLCBpZ25vcmUsXG4gICAgICAvLyBvdGhlcndpc2UgbG9nIGFuZCB0aHJvdyB0aGUgZXJyb3JcbiAgICAgIGlmIChlcnIubWVzc2FnZSAhPT0gYWxlcnRFcnJvck1zZykge1xuICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhlcnIpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChwYWdlQXJyYXkubGVuZ3RoID09PSAwKSB7XG4gICAgLy8gd2UgaGF2ZSBubyB3ZWIgZnJhbWVzLCBidXQgY29udGludWUgYW55d2F5XG4gICAgbG9nLmRlYnVnKCdObyB3ZWIgZnJhbWVzIGZvdW5kLicpO1xuICB9XG4gIHJldHVybiBwYWdlQXJyYXk7XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IENvbnRleHRcbiAqXG4gKiBAcHJvcGVydHkge3N0cmluZ30gaWQgLSBUaGUgaWRlbnRpZmllciBvZiB0aGUgY29udGV4dC4gVGhlIG5hdGl2ZSBjb250ZXh0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgd2lsbCBiZSAnTkFUSVZFX0FQUCcgYW5kIHRoZSB3ZWJ2aWV3cyB3aWxsIGJlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgJ1dFQlZJRVdfeHh4J1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSB0aXRsZSAtIFRoZSB0aXRsZSBhc3NvY2lhdGVkIHdpdGggdGhlIHdlYnZpZXcgY29udGVudFxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB1cmwgLSBUaGUgdXJsIGFzc29jaWF0ZWQgd2l0aCB0aGUgd2VidmlldyBjb250ZW50XG4gKi9cblxuLyoqXG4gKiBHZXQgdGhlIGNvbnRleHRzIGF2YWlsYWJsZSwgd2l0aCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgdXJsIGFuZCB0aXRsZSBvZiBlYWNoXG4gKiB3ZWJ2aWV3XG4gKiBAcmV0dXJucyB7QXJyYXl9IExpc3Qgb2YgQ29udGV4dCBvYmplY3RzXG4gKi9cbmV4dGVuc2lvbnMubW9iaWxlR2V0Q29udGV4dHMgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVHZXRDb250ZXh0cyAoKSB7XG4gIGNvbnN0IGN1ck9wdCA9IHRoaXMub3B0cy5mdWxsQ29udGV4dExpc3Q7XG4gIHRyeSB7XG4gICAgLy8gYGFwcGl1bS1pb3MtZHJpdmVyI2dldENvbnRleHRzYCByZXR1cm5zIHRoZSBmdWxsIGxpc3Qgb2YgY29udGV4dHNcbiAgICAvLyBpZiB0aGlzIG9wdGlvbiBpcyBvblxuICAgIHRoaXMub3B0cy5mdWxsQ29udGV4dExpc3QgPSB0cnVlO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldENvbnRleHRzKCk7XG4gIH0gZmluYWxseSB7XG4gICAgLy8gcmVzZXQgdGhlIG9wdGlvbiBzbyB0aGVyZSBhcmUgbm8gc2lkZSBlZmZlY3RzXG4gICAgdGhpcy5vcHRzLmZ1bGxDb250ZXh0TGlzdCA9IGN1ck9wdDtcbiAgfVxufTtcblxuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=

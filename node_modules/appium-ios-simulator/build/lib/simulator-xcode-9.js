"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _simulatorXcode = _interopRequireDefault(require("./simulator-xcode-8"));

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _asyncLock = _interopRequireDefault(require("async-lock"));

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

var _utils = require("./utils.js");

const SIMULATOR_SHUTDOWN_TIMEOUT = 15 * 1000;
const startupLock = new _asyncLock.default();
const preferencesPlistGuard = new _asyncLock.default();
const ENROLLMENT_NOTIFICATION_RECEIVER = 'com.apple.BiometricKit.enrollmentChanged';

class SimulatorXcode9 extends _simulatorXcode.default {
  constructor(udid, xcodeVersion) {
    super(udid, xcodeVersion);
  }

  async run(opts = {}) {
    opts = _lodash.default.cloneDeep(opts);

    _lodash.default.defaultsDeep(opts, {
      devicePreferences: {},
      isHeadless: false,
      startupTimeout: this.startupTimeout
    });

    if (opts.scaleFactor) {
      opts.devicePreferences.SimulatorWindowLastScale = parseFloat(opts.scaleFactor);
    }

    const commonPreferences = {
      RotateWindowWhenSignaledByGuest: true
    };

    if (_lodash.default.isBoolean(opts.connectHardwareKeyboard)) {
      opts.devicePreferences.ConnectHardwareKeyboard = opts.connectHardwareKeyboard;
      commonPreferences.ConnectHardwareKeyboard = opts.connectHardwareKeyboard;
    }

    if (!_lodash.default.isEmpty(opts.devicePreferences) || !_lodash.default.isEmpty(commonPreferences)) {
      await this.updatePreferences(opts.devicePreferences, commonPreferences);
    }

    const timer = new _appiumSupport.timing.Timer().start();
    const shouldWaitForBoot = await startupLock.acquire(this.uiClientBundleId, async () => {
      const isServerRunning = await this.isRunning();
      const uiClientPid = await this.getUIClientPid();

      if (opts.isHeadless) {
        if (isServerRunning && !uiClientPid) {
          _logger.default.info(`Simulator with UDID '${this.udid}' is already booted in headless mode.`);

          return false;
        }

        if (await this.killUIClient({
          pid: uiClientPid
        })) {
          _logger.default.info(`Detected the Simulator UI client was running and killed it. Verifying the current Simulator state...`);
        }

        try {
          await (0, _asyncbox.waitForCondition)(async () => await this.isShutdown(), {
            waitMs: 5000,
            intervalMs: 100
          });
        } catch (e) {
          if (!(await this.isRunning())) {
            throw new Error(`Simulator with UDID '${this.udid}' cannot be transitioned to headless mode`);
          }

          return false;
        }

        _logger.default.info(`Booting Simulator with UDID '${this.udid}' in headless mode. All UI-related capabilities are going to be ignored`);

        await this.boot();
      } else {
        if (isServerRunning && uiClientPid) {
          _logger.default.info(`Both Simulator with UDID '${this.udid}' and the UI client are currently running`);

          return false;
        }

        if (isServerRunning) {
          _logger.default.info(`Simulator '${this.udid}' is booted while its UI is not visible. ` + `Trying to restart it with the Simulator window visible`);

          await this.shutdown({
            timeout: SIMULATOR_SHUTDOWN_TIMEOUT
          });
        }

        await this.launchWindow(uiClientPid, opts);
      }

      return true;
    });

    if (shouldWaitForBoot) {
      await this.waitForBoot(opts.startupTimeout);

      _logger.default.info(`Simulator with UDID ${this.udid} booted in ${timer.getDuration().asSeconds.toFixed(3)}s`);
    }
  }

  async launchWindow(isUiClientRunning, opts = {}) {
    await this.boot();

    if (!isUiClientRunning) {
      await this.startUIClient(opts);
    }
  }

  async boot() {
    if (await this.isRunning()) {
      _logger.default.info(`Simulator '${this.udid}' is already running`);

      return;
    }

    _logger.default.info(`Booting Simulator with UDID '${this.udid}'...`);

    try {
      await (0, _asyncbox.retryInterval)(3, 2000, async () => {
        try {
          await this.simctl.bootDevice();
        } catch (e) {
          if (!_lodash.default.includes(e.stderr, 'Unable to boot device in current state: Booted')) {
            throw e;
          }

          _logger.default.debug(`Simulator with UDID '${this.udid}' is already in Booted state`);
        }
      });
    } catch (err) {
      _logger.default.warn(err.stderr || err.message);
    }
  }

  verifyDevicePreferences(prefs = {}) {
    if (_lodash.default.isEmpty(prefs)) {
      return;
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowLastScale)) {
      if (!_lodash.default.isNumber(prefs.SimulatorWindowLastScale) || prefs.SimulatorWindowLastScale <= 0) {
        _logger.default.errorAndThrow(`SimulatorWindowLastScale is expected to be a positive float value. ` + `'${prefs.SimulatorWindowLastScale}' is assigned instead.`);
      }
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowCenter)) {
      const verificationPattern = /{-?\d+(\.\d+)?,-?\d+(\.\d+)?}/;

      if (!_lodash.default.isString(prefs.SimulatorWindowCenter) || !verificationPattern.test(prefs.SimulatorWindowCenter)) {
        _logger.default.errorAndThrow(`SimulatorWindowCenter is expected to match "{floatXPosition,floatYPosition}" format (without spaces). ` + `'${prefs.SimulatorWindowCenter}' is assigned instead.`);
      }
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowOrientation)) {
      const acceptableValues = ['Portrait', 'LandscapeLeft', 'PortraitUpsideDown', 'LandscapeRight'];

      if (acceptableValues.indexOf(prefs.SimulatorWindowOrientation) === -1) {
        _logger.default.errorAndThrow(`SimulatorWindowOrientation is expected to be one of ${acceptableValues}. ` + `'${prefs.SimulatorWindowOrientation}' is assigned instead.`);
      }
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowRotationAngle)) {
      if (!_lodash.default.isNumber(prefs.SimulatorWindowRotationAngle)) {
        _logger.default.errorAndThrow(`SimulatorWindowRotationAngle is expected to be a valid number. ` + `'${prefs.SimulatorWindowRotationAngle}' is assigned instead.`);
      }
    }
  }

  async updatePreferences(devicePrefs = {}, commonPrefs = {}) {
    if (!_lodash.default.isEmpty(devicePrefs)) {
      _logger.default.debug(`Setting preferences of ${this.udid} Simulator to ${JSON.stringify(devicePrefs)}`);
    }

    if (!_lodash.default.isEmpty(commonPrefs)) {
      _logger.default.debug(`Setting common Simulator preferences to ${JSON.stringify(commonPrefs)}`);
    }

    const homeFolderPath = process.env.HOME;

    if (!homeFolderPath) {
      _logger.default.warn(`Cannot get the path to HOME folder from the process environment. ` + `Ignoring Simulator preferences update.`);

      return false;
    }

    this.verifyDevicePreferences(devicePrefs);

    const plistPath = _path.default.resolve(homeFolderPath, 'Library', 'Preferences', 'com.apple.iphonesimulator.plist');

    if (!(await _appiumSupport.fs.hasAccess(plistPath))) {
      _logger.default.warn(`Simulator preferences file '${plistPath}' is not accessible. ` + `Ignoring Simulator preferences update.`);

      return false;
    }

    let newPrefs = {};

    if (!_lodash.default.isEmpty(devicePrefs)) {
      newPrefs.DevicePreferences = {
        [this.udid.toUpperCase()]: devicePrefs
      };
    }

    newPrefs = _lodash.default.merge(newPrefs, commonPrefs);
    return await preferencesPlistGuard.acquire(SimulatorXcode9.name, async () => {
      try {
        const currentPlistContent = await _appiumSupport.plist.parsePlistFile(plistPath);
        await _appiumSupport.plist.updatePlistFile(plistPath, _lodash.default.merge(currentPlistContent, newPrefs), true);

        _logger.default.debug(`Updated ${this.udid} Simulator preferences at '${plistPath}' with ${JSON.stringify(newPrefs)}`);

        return true;
      } catch (e) {
        _logger.default.warn(`Cannot update ${this.udid} Simulator preferences at '${plistPath}'. ` + `Try to delete the file manually in order to reset it. Original error: ${e.message}`);

        return false;
      }
    });
  }

  async clean() {
    _logger.default.info(`Cleaning simulator ${this.udid}`);

    await this.simctl.eraseDevice(10000);
  }

  async _activateWindow() {
    let selfName;
    let selfSdk;
    let bootedDevicesCount = 0;

    for (const [sdk, deviceArr] of _lodash.default.toPairs(await this.simctl.getDevices())) {
      for (const {
        state,
        udid,
        name
      } of deviceArr) {
        if (state === 'Booted') {
          bootedDevicesCount++;
        }

        if (!selfName && udid === this.udid) {
          selfSdk = sdk;
          selfName = name;
        }
      }
    }

    if (bootedDevicesCount < 2) {
      return await super._activateWindow();
    }

    return `
      tell application "System Events"
        tell process "Simulator"
          set frontmost to false
          set frontmost to true
          click (menu item 1 where (its name contains "${selfName} " and its name contains "${selfSdk}")) of menu 1 of menu bar item "Window" of menu bar 1
        end tell
      end tell
    `;
  }

  async isBiometricEnrolled() {
    const {
      stdout
    } = await this.simctl.spawnProcess(['notifyutil', '-g', ENROLLMENT_NOTIFICATION_RECEIVER]);
    const match = new RegExp(`${_lodash.default.escapeRegExp(ENROLLMENT_NOTIFICATION_RECEIVER)}\\s+([01])`).exec(stdout);

    if (!match) {
      throw new Error(`Cannot parse biometric enrollment state from '${stdout}'`);
    }

    _logger.default.info(`Current biometric enrolled state for ${this.udid} Simulator: ${match[1]}`);

    return match[1] === '1';
  }

  async enrollBiometric(isEnabled = true) {
    _logger.default.debug(`Setting biometric enrolled state for ${this.udid} Simulator to '${isEnabled ? 'enabled' : 'disabled'}'`);

    await this.simctl.spawnProcess(['notifyutil', '-s', ENROLLMENT_NOTIFICATION_RECEIVER, isEnabled ? '1' : '0']);
    await this.simctl.spawnProcess(['notifyutil', '-p', ENROLLMENT_NOTIFICATION_RECEIVER]);

    if ((await this.isBiometricEnrolled()) !== isEnabled) {
      throw new Error(`Cannot set biometric enrolled state for ${this.udid} Simulator to '${isEnabled ? 'enabled' : 'disabled'}'`);
    }
  }

  async sendBiometricMatch(shouldMatch = true, biometricName = 'touchId') {
    const domainComponent = (0, _utils.toBiometricDomainComponent)(biometricName);
    const domain = `com.apple.BiometricKit_Sim.${domainComponent}.${shouldMatch ? '' : 'no'}match`;
    await this.simctl.spawnProcess(['notifyutil', '-p', domain]);

    _logger.default.info(`Sent notification ${domain} to ${shouldMatch ? 'match' : 'not match'} ${biometricName} biometric ` + `for ${this.udid} Simulator`);
  }

  async getLaunchDaemonsRoot() {
    const devRoot = await (0, _utils.getDeveloperRoot)();
    return _path.default.resolve(devRoot, 'Platforms/iPhoneOS.platform/Developer/Library/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/LaunchDaemons');
  }

}

var _default = SimulatorXcode9;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOS5qcyJdLCJuYW1lcyI6WyJTSU1VTEFUT1JfU0hVVERPV05fVElNRU9VVCIsInN0YXJ0dXBMb2NrIiwiQXN5bmNMb2NrIiwicHJlZmVyZW5jZXNQbGlzdEd1YXJkIiwiRU5ST0xMTUVOVF9OT1RJRklDQVRJT05fUkVDRUlWRVIiLCJTaW11bGF0b3JYY29kZTkiLCJTaW11bGF0b3JYY29kZTgiLCJjb25zdHJ1Y3RvciIsInVkaWQiLCJ4Y29kZVZlcnNpb24iLCJydW4iLCJvcHRzIiwiXyIsImNsb25lRGVlcCIsImRlZmF1bHRzRGVlcCIsImRldmljZVByZWZlcmVuY2VzIiwiaXNIZWFkbGVzcyIsInN0YXJ0dXBUaW1lb3V0Iiwic2NhbGVGYWN0b3IiLCJTaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUiLCJwYXJzZUZsb2F0IiwiY29tbW9uUHJlZmVyZW5jZXMiLCJSb3RhdGVXaW5kb3dXaGVuU2lnbmFsZWRCeUd1ZXN0IiwiaXNCb29sZWFuIiwiY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQiLCJDb25uZWN0SGFyZHdhcmVLZXlib2FyZCIsImlzRW1wdHkiLCJ1cGRhdGVQcmVmZXJlbmNlcyIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJzdGFydCIsInNob3VsZFdhaXRGb3JCb290IiwiYWNxdWlyZSIsInVpQ2xpZW50QnVuZGxlSWQiLCJpc1NlcnZlclJ1bm5pbmciLCJpc1J1bm5pbmciLCJ1aUNsaWVudFBpZCIsImdldFVJQ2xpZW50UGlkIiwibG9nIiwiaW5mbyIsImtpbGxVSUNsaWVudCIsInBpZCIsImlzU2h1dGRvd24iLCJ3YWl0TXMiLCJpbnRlcnZhbE1zIiwiZSIsIkVycm9yIiwiYm9vdCIsInNodXRkb3duIiwidGltZW91dCIsImxhdW5jaFdpbmRvdyIsIndhaXRGb3JCb290IiwiZ2V0RHVyYXRpb24iLCJhc1NlY29uZHMiLCJ0b0ZpeGVkIiwiaXNVaUNsaWVudFJ1bm5pbmciLCJzdGFydFVJQ2xpZW50Iiwic2ltY3RsIiwiYm9vdERldmljZSIsImluY2x1ZGVzIiwic3RkZXJyIiwiZGVidWciLCJlcnIiLCJ3YXJuIiwibWVzc2FnZSIsInZlcmlmeURldmljZVByZWZlcmVuY2VzIiwicHJlZnMiLCJpc1VuZGVmaW5lZCIsImlzTnVtYmVyIiwiZXJyb3JBbmRUaHJvdyIsIlNpbXVsYXRvcldpbmRvd0NlbnRlciIsInZlcmlmaWNhdGlvblBhdHRlcm4iLCJpc1N0cmluZyIsInRlc3QiLCJTaW11bGF0b3JXaW5kb3dPcmllbnRhdGlvbiIsImFjY2VwdGFibGVWYWx1ZXMiLCJpbmRleE9mIiwiU2ltdWxhdG9yV2luZG93Um90YXRpb25BbmdsZSIsImRldmljZVByZWZzIiwiY29tbW9uUHJlZnMiLCJKU09OIiwic3RyaW5naWZ5IiwiaG9tZUZvbGRlclBhdGgiLCJwcm9jZXNzIiwiZW52IiwiSE9NRSIsInBsaXN0UGF0aCIsInBhdGgiLCJyZXNvbHZlIiwiZnMiLCJoYXNBY2Nlc3MiLCJuZXdQcmVmcyIsIkRldmljZVByZWZlcmVuY2VzIiwidG9VcHBlckNhc2UiLCJtZXJnZSIsIm5hbWUiLCJjdXJyZW50UGxpc3RDb250ZW50IiwicGxpc3QiLCJwYXJzZVBsaXN0RmlsZSIsInVwZGF0ZVBsaXN0RmlsZSIsImNsZWFuIiwiZXJhc2VEZXZpY2UiLCJfYWN0aXZhdGVXaW5kb3ciLCJzZWxmTmFtZSIsInNlbGZTZGsiLCJib290ZWREZXZpY2VzQ291bnQiLCJzZGsiLCJkZXZpY2VBcnIiLCJ0b1BhaXJzIiwiZ2V0RGV2aWNlcyIsInN0YXRlIiwiaXNCaW9tZXRyaWNFbnJvbGxlZCIsInN0ZG91dCIsInNwYXduUHJvY2VzcyIsIm1hdGNoIiwiUmVnRXhwIiwiZXNjYXBlUmVnRXhwIiwiZXhlYyIsImVucm9sbEJpb21ldHJpYyIsImlzRW5hYmxlZCIsInNlbmRCaW9tZXRyaWNNYXRjaCIsInNob3VsZE1hdGNoIiwiYmlvbWV0cmljTmFtZSIsImRvbWFpbkNvbXBvbmVudCIsImRvbWFpbiIsImdldExhdW5jaERhZW1vbnNSb290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QUFHQyxhQUFjLGFBQXZGLEdBQ04sT0FBTSxLQUFLbkgsSUFBSyxZQURuQjtBQUVEOztBQUtELFFBQU1zSCxvQkFBTixHQUE4QjtBQUM1QixVQUFNQyxPQUFPLEdBQUcsTUFBTSw4QkFBdEI7QUFDQSxXQUFPdkMsY0FBS0MsT0FBTCxDQUFhc0MsT0FBYixFQUNMLDBKQURLLENBQVA7QUFFRDs7QUExVzJDOztlQThXL0IxSCxlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNpbXVsYXRvclhjb2RlOCBmcm9tICcuL3NpbXVsYXRvci14Y29kZS04JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCBwbGlzdCwgdGltaW5nIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IEFzeW5jTG9jayBmcm9tICdhc3luYy1sb2NrJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiwgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IHRvQmlvbWV0cmljRG9tYWluQ29tcG9uZW50LCBnZXREZXZlbG9wZXJSb290IH0gZnJvbSAnLi91dGlscy5qcyc7XG5cbmNvbnN0IFNJTVVMQVRPUl9TSFVURE9XTl9USU1FT1VUID0gMTUgKiAxMDAwO1xuY29uc3Qgc3RhcnR1cExvY2sgPSBuZXcgQXN5bmNMb2NrKCk7XG5jb25zdCBwcmVmZXJlbmNlc1BsaXN0R3VhcmQgPSBuZXcgQXN5bmNMb2NrKCk7XG5jb25zdCBFTlJPTExNRU5UX05PVElGSUNBVElPTl9SRUNFSVZFUiA9ICdjb20uYXBwbGUuQmlvbWV0cmljS2l0LmVucm9sbG1lbnRDaGFuZ2VkJztcblxuY2xhc3MgU2ltdWxhdG9yWGNvZGU5IGV4dGVuZHMgU2ltdWxhdG9yWGNvZGU4IHtcbiAgY29uc3RydWN0b3IgKHVkaWQsIHhjb2RlVmVyc2lvbikge1xuICAgIHN1cGVyKHVkaWQsIHhjb2RlVmVyc2lvbik7XG4gIH1cblxuICAvKipcbiAgICogQHR5cGVkZWYge09iamVjdH0gRGV2aWNlUHJlZmVyZW5jZXNcbiAgICogQHByb3BlcnR5IHs/bnVtYmVyfSBTaW11bGF0b3JFeHRlcm5hbERpc3BsYXkgLSBUQkQuIEV4YW1wbGUgdmFsdWU6IDIuMTE0XG4gICAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gQ2hyb21lVGludCAtIFRCRC4gRXhhbXBsZSB2YWx1ZTogJydcbiAgICogQHByb3BlcnR5IHs/bnVtYmVyfSBTaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUgLSBTY2FsZSB2YWx1ZSBmb3IgdGhlIHBhcnRpY3VsYXIgU2ltdWxhdG9yIHdpbmRvdy5cbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxLjAgbWVhbnMgMTAwJSBzY2FsZS5cbiAgICogQHByb3BlcnR5IHs/c3RyaW5nfSBTaW11bGF0b3JXaW5kb3dPcmllbnRhdGlvbiAtIFNpbXVsYXRvciB3aW5kb3cgb3JpZW50YXRpb24uIFBvc3NpYmxlIHZhbHVlcyBhcmU6XG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnUG9ydHJhaXQnLCAnTGFuZHNjYXBlTGVmdCcsICdQb3J0cmFpdFVwc2lkZURvd24nIGFuZCAnTGFuZHNjYXBlUmlnaHQnLlxuICAgKiBAcHJvcGVydHkgez9udW1iZXJ9IFNpbXVsYXRvcldpbmRvd1JvdGF0aW9uQW5nbGUgLSBXaW5kb3cgcm90YXRpb24gYW5nbGUuIFRoaXMgdmFsdWUgaXMgZXhwZWN0ZWQgdG8gYmUgaW4gc3luY1xuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIF9TaW11bGF0b3JXaW5kb3dPcmllbnRhdGlvbl8uIFRoZSBjb3JyZXNwb25kaW5nIHZhbHVlcyBhcmU6XG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAsIDkwLCAxODAgYW5kIDI3MC5cbiAgICogQHByb3BlcnR5IHs/c3RyaW5nfSBTaW11bGF0b3JXaW5kb3dDZW50ZXIgLSBUaGUgY29vcmRpbmF0ZXMgb2YgU2ltdWxhdG9yJ3Mgd2luZG93IGNlbnRlciBpbiBwaXhlbHMsXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGV4YW1wbGUgJ3stMTI5NC41LCA3NzUuNX0nLlxuICAgKiBAcHJvcGVydHkgez9ib29sZWFufSBDb25uZWN0SGFyZHdhcmVLZXlib2FyZCAtIEVxdWFscyB0byAxIGlmIGhhcmR3YXJlIGtleWJvYXJkIHNob3VsZCBiZSBjb25uZWN0ZWQuXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT3RoZXJ3aXNlIDAuXG4gICAqL1xuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBDb21tb25QcmVmZXJlbmNlc1xuICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IENvbm5lY3RIYXJkd2FyZUtleWJvYXJkIC0gV2hldGhlciB0byBjb25uZWN0IGhhcmR3YXJlIGtleWJvYXJkXG4gICAqL1xuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBSdW5PcHRpb25zXG4gICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBzY2FsZUZhY3RvcjogQW55IHBvc2l0aXZlIGZsb2F0IHZhbHVlLiAxLjAgbWVhbnMgMToxIHNjYWxlLlxuICAgKiBEZWZpbmVzIHRoZSB3aW5kb3cgc2NhbGUgdmFsdWUgZm9yIHRoZSBVSSBjbGllbnQgd2luZG93IGZvciB0aGUgY3VycmVudCBTaW11bGF0b3IuXG4gICAqIEVxdWFscyB0byBgbnVsbGAgYnkgZGVmYXVsdCwgd2hpY2gga2VlcHMgdGhlIGN1cnJlbnQgc2NhbGUgdW5jaGFuZ2VkLlxuICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbm5lY3RIYXJkd2FyZUtleWJvYXJkOiB3aGV0aGVyIHRvIGNvbm5lY3QgdGhlIGhhcmR3YXJlIGtleWJvYXJkIHRvIHRoZVxuICAgKiBTaW11bGF0b3IgVUkgY2xpZW50LiBFcXVhbHMgdG8gYGZhbHNlYCBieSBkZWZhdWx0LlxuICAgKiBAcHJvcGVydHkge251bWJlcn0gc3RhcnR1cFRpbWVvdXQ6IG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbCBTaW11bGF0b3IgYm9vdGluZ1xuICAgKiBwcm9jZXNzIGlzIGNvbXBsZXRlZC4gVGhlIGRlZmF1bHQgdGltZW91dCB3aWxsIGJlIHVzZWQgaWYgbm90IHNldCBleHBsaWNpdGx5LlxuICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzSGVhZGxlc3M6IHdoZXRoZXIgdG8gc3RhcnQgdGhlIFNpbXVsYXRvciBpbiBoZWFkbGVzcyBtb2RlICh3aXRoIFVJXG4gICAqIGNsaWVudCBpbnZpc2libGUpLiBgZmFsc2VgIGJ5IGRlZmF1bHQuXG4gICAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IHRyYWNlUG9pbnRlciBbZmFsc2VdIC0gV2hldGhlciB0byBoaWdobGlnaHQgdG91Y2hlcyBvbiBTaW11bGF0b3JcbiAgICogc2NyZWVuLiBUaGlzIGlzIGhlbHBmdWwgd2hpbGUgZGVidWdnaW5nIGF1dG9tYXRlZCB0ZXN0cyBvciB3aGlsZSBvYnNlcnZpbmcgdGhlIGF1dG9tYXRpb25cbiAgICogcmVjb3JkaW5ncy5cbiAgICogQHByb3BlcnR5IHtEZXZpY2VQcmVmZXJlbmNlc30gZGV2aWNlUHJlZmVyZW5jZXM6IHByZWZlcmVuY2VzIG9mIHRoZSBuZXdseSBjcmVhdGVkIFNpbXVsYXRvclxuICAgKiBkZXZpY2VcbiAgICovXG5cbiAgLyoqXG4gICAqIEV4ZWN1dGVzIGdpdmVuIFNpbXVsYXRvciB3aXRoIG9wdGlvbnMuIFRoZSBTaW11bGF0b3Igd2lsbCBub3QgYmUgcmVzdGFydGVkIGlmXG4gICAqIGl0IGlzIGFscmVhZHkgcnVubmluZyBhbmQgdGhlIGN1cnJlbnQgVUkgc3RhdGUgbWF0Y2hlcyB0byBgaXNIZWFkbGVzc2Agb3B0aW9uLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtSdW5PcHRpb25zfSBvcHRzIC0gT25lIG9yIG1vcmUgb2YgYXZhaWxhYmxlIFNpbXVsYXRvciBvcHRpb25zXG4gICAqL1xuICBhc3luYyBydW4gKG9wdHMgPSB7fSkge1xuICAgIG9wdHMgPSBfLmNsb25lRGVlcChvcHRzKTtcbiAgICBfLmRlZmF1bHRzRGVlcChvcHRzLCB7XG4gICAgICBkZXZpY2VQcmVmZXJlbmNlczoge30sXG4gICAgICBpc0hlYWRsZXNzOiBmYWxzZSxcbiAgICAgIHN0YXJ0dXBUaW1lb3V0OiB0aGlzLnN0YXJ0dXBUaW1lb3V0LFxuICAgIH0pO1xuICAgIGlmIChvcHRzLnNjYWxlRmFjdG9yKSB7XG4gICAgICBvcHRzLmRldmljZVByZWZlcmVuY2VzLlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZSA9IHBhcnNlRmxvYXQob3B0cy5zY2FsZUZhY3Rvcik7XG4gICAgfVxuICAgIC8vIFRoaXMgb3B0aW9uIGlzIG5lY2Vzc2FyeSB0byBtYWtlIHRoZSBTaW11bGF0b3Igd2luZG93IGZvbGxvd1xuICAgIC8vIHRoZSBhY3R1YWwgWENVSURldmljZSBvcmllbnRhdGlvblxuICAgIGNvbnN0IGNvbW1vblByZWZlcmVuY2VzID0ge1xuICAgICAgUm90YXRlV2luZG93V2hlblNpZ25hbGVkQnlHdWVzdDogdHJ1ZVxuICAgIH07XG4gICAgaWYgKF8uaXNCb29sZWFuKG9wdHMuY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQpKSB7XG4gICAgICBvcHRzLmRldmljZVByZWZlcmVuY2VzLkNvbm5lY3RIYXJkd2FyZUtleWJvYXJkID0gb3B0cy5jb25uZWN0SGFyZHdhcmVLZXlib2FyZDtcbiAgICAgIGNvbW1vblByZWZlcmVuY2VzLkNvbm5lY3RIYXJkd2FyZUtleWJvYXJkID0gb3B0cy5jb25uZWN0SGFyZHdhcmVLZXlib2FyZDtcbiAgICB9XG4gICAgaWYgKCFfLmlzRW1wdHkob3B0cy5kZXZpY2VQcmVmZXJlbmNlcykgfHwgIV8uaXNFbXB0eShjb21tb25QcmVmZXJlbmNlcykpIHtcbiAgICAgIGF3YWl0IHRoaXMudXBkYXRlUHJlZmVyZW5jZXMob3B0cy5kZXZpY2VQcmVmZXJlbmNlcywgY29tbW9uUHJlZmVyZW5jZXMpO1xuICAgIH1cbiAgICBjb25zdCB0aW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICAgIGNvbnN0IHNob3VsZFdhaXRGb3JCb290ID0gYXdhaXQgc3RhcnR1cExvY2suYWNxdWlyZSh0aGlzLnVpQ2xpZW50QnVuZGxlSWQsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGlzU2VydmVyUnVubmluZyA9IGF3YWl0IHRoaXMuaXNSdW5uaW5nKCk7XG4gICAgICBjb25zdCB1aUNsaWVudFBpZCA9IGF3YWl0IHRoaXMuZ2V0VUlDbGllbnRQaWQoKTtcbiAgICAgIGlmIChvcHRzLmlzSGVhZGxlc3MpIHtcbiAgICAgICAgaWYgKGlzU2VydmVyUnVubmluZyAmJiAhdWlDbGllbnRQaWQpIHtcbiAgICAgICAgICBsb2cuaW5mbyhgU2ltdWxhdG9yIHdpdGggVURJRCAnJHt0aGlzLnVkaWR9JyBpcyBhbHJlYWR5IGJvb3RlZCBpbiBoZWFkbGVzcyBtb2RlLmApO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYXdhaXQgdGhpcy5raWxsVUlDbGllbnQoe3BpZDogdWlDbGllbnRQaWR9KSkge1xuICAgICAgICAgIGxvZy5pbmZvKGBEZXRlY3RlZCB0aGUgU2ltdWxhdG9yIFVJIGNsaWVudCB3YXMgcnVubmluZyBhbmQga2lsbGVkIGl0LiBWZXJpZnlpbmcgdGhlIGN1cnJlbnQgU2ltdWxhdG9yIHN0YXRlLi4uYCk7XG4gICAgICAgIH1cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAvLyBTdG9wcGluZyB0aGUgVUkgY2xpZW50IGtpbGxzIGFsbCBydW5uaW5nIHNlcnZlcnMgZm9yIHNvbWUgZWFybHkgWENvZGUgdmVyc2lvbnMuIFRoaXMgaXMgYSBrbm93biBidWdcbiAgICAgICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IGF3YWl0IHRoaXMuaXNTaHV0ZG93bigpLCB7XG4gICAgICAgICAgICB3YWl0TXM6IDUwMDAsXG4gICAgICAgICAgICBpbnRlcnZhbE1zOiAxMDAsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBpZiAoIWF3YWl0IHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgU2ltdWxhdG9yIHdpdGggVURJRCAnJHt0aGlzLnVkaWR9JyBjYW5ub3QgYmUgdHJhbnNpdGlvbmVkIHRvIGhlYWRsZXNzIG1vZGVgKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGxvZy5pbmZvKGBCb290aW5nIFNpbXVsYXRvciB3aXRoIFVESUQgJyR7dGhpcy51ZGlkfScgaW4gaGVhZGxlc3MgbW9kZS4gQWxsIFVJLXJlbGF0ZWQgY2FwYWJpbGl0aWVzIGFyZSBnb2luZyB0byBiZSBpZ25vcmVkYCk7XG4gICAgICAgIGF3YWl0IHRoaXMuYm9vdCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGlzU2VydmVyUnVubmluZyAmJiB1aUNsaWVudFBpZCkge1xuICAgICAgICAgIGxvZy5pbmZvKGBCb3RoIFNpbXVsYXRvciB3aXRoIFVESUQgJyR7dGhpcy51ZGlkfScgYW5kIHRoZSBVSSBjbGllbnQgYXJlIGN1cnJlbnRseSBydW5uaW5nYCk7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpc1NlcnZlclJ1bm5pbmcpIHtcbiAgICAgICAgICBsb2cuaW5mbyhgU2ltdWxhdG9yICcke3RoaXMudWRpZH0nIGlzIGJvb3RlZCB3aGlsZSBpdHMgVUkgaXMgbm90IHZpc2libGUuIGAgK1xuICAgICAgICAgICAgYFRyeWluZyB0byByZXN0YXJ0IGl0IHdpdGggdGhlIFNpbXVsYXRvciB3aW5kb3cgdmlzaWJsZWApO1xuICAgICAgICAgIGF3YWl0IHRoaXMuc2h1dGRvd24oe3RpbWVvdXQ6IFNJTVVMQVRPUl9TSFVURE9XTl9USU1FT1VUfSk7XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgdGhpcy5sYXVuY2hXaW5kb3codWlDbGllbnRQaWQsIG9wdHMpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSk7XG5cbiAgICBpZiAoc2hvdWxkV2FpdEZvckJvb3QpIHtcbiAgICAgIGF3YWl0IHRoaXMud2FpdEZvckJvb3Qob3B0cy5zdGFydHVwVGltZW91dCk7XG4gICAgICBsb2cuaW5mbyhgU2ltdWxhdG9yIHdpdGggVURJRCAke3RoaXMudWRpZH0gYm9vdGVkIGluICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc1NlY29uZHMudG9GaXhlZCgzKX1zYCk7XG4gICAgfVxuICB9XG5cbiAgLyoqKlxuICAgKiBCb290cyBzaW11bGF0b3IgYW5kIG9wZW5zIHNpbXVsYXRvcnMgVUkgQ2xpZW50IGlmIG5vdCBhbHJlYWR5IG9wZW5lZC5cbiAgICpcbiAgICogQHBhcmFtIHtib29sZWFufSBpc1VpQ2xpZW50UnVubmluZyAtIHByb2Nlc3MgaWQgb2Ygc2ltdWxhdG9yIFVJIGNsaWVudC5cbiAgICogQHBhcmFtIHtSdW5PcHRpb25zfSBvcHRzIC0gYXJndW1lbnRzIHRvIHN0YXJ0IHNpbXVsYXRvciBVSSBjbGllbnQgd2l0aC5cbiAgICovXG4gIGFzeW5jIGxhdW5jaFdpbmRvdyAoaXNVaUNsaWVudFJ1bm5pbmcsIG9wdHMgPSB7fSkge1xuICAgIGF3YWl0IHRoaXMuYm9vdCgpO1xuICAgIGlmICghaXNVaUNsaWVudFJ1bm5pbmcpIHtcbiAgICAgIGF3YWl0IHRoaXMuc3RhcnRVSUNsaWVudChvcHRzKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQm9vdHMgc2ltdWxhdG9yIGlmIG5vdCBhbHJlYWR5IGJvb3RlZC5cbiAgICovXG4gIGFzeW5jIGJvb3QgKCkge1xuICAgIGlmIChhd2FpdCB0aGlzLmlzUnVubmluZygpKSB7XG4gICAgICBsb2cuaW5mbyhgU2ltdWxhdG9yICcke3RoaXMudWRpZH0nIGlzIGFscmVhZHkgcnVubmluZ2ApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxvZy5pbmZvKGBCb290aW5nIFNpbXVsYXRvciB3aXRoIFVESUQgJyR7dGhpcy51ZGlkfScuLi5gKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgzLCAyMDAwLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5zaW1jdGwuYm9vdERldmljZSgpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgaWYgKCFfLmluY2x1ZGVzKGUuc3RkZXJyLCAnVW5hYmxlIHRvIGJvb3QgZGV2aWNlIGluIGN1cnJlbnQgc3RhdGU6IEJvb3RlZCcpKSB7XG4gICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBsb2cuZGVidWcoYFNpbXVsYXRvciB3aXRoIFVESUQgJyR7dGhpcy51ZGlkfScgaXMgYWxyZWFkeSBpbiBCb290ZWQgc3RhdGVgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihlcnIuc3RkZXJyIHx8IGVyci5tZXNzYWdlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSB2ZXJpZmljYXRpb24gb2YgZGV2aWNlIHByZWZlcmVuY2VzIGNvcnJlY3RuZXNzLlxuICAgKlxuICAgKiBAcGFyYW0ge0RldmljZVByZWZlcmVuY2VzfSBwcmVmcyBbe31dIC0gVGhlIHByZWZlcmVuY2VzIHRvIGJlIHZlcmlmaWVkXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiBhbnkgb2YgdGhlIGdpdmVuIHByZWZlcmVuY2UgdmFsdWVzIGRvZXMgbm90IG1hdGNoIHRoZSBleHBlY3RlZFxuICAgKiBmb3JtYXQuXG4gICAqL1xuICB2ZXJpZnlEZXZpY2VQcmVmZXJlbmNlcyAocHJlZnMgPSB7fSkge1xuICAgIGlmIChfLmlzRW1wdHkocHJlZnMpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKHByZWZzLlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZSkpIHtcbiAgICAgIGlmICghXy5pc051bWJlcihwcmVmcy5TaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUpIHx8IHByZWZzLlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZSA8PSAwKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUgaXMgZXhwZWN0ZWQgdG8gYmUgYSBwb3NpdGl2ZSBmbG9hdCB2YWx1ZS4gYCArXG4gICAgICAgICAgYCcke3ByZWZzLlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZX0nIGlzIGFzc2lnbmVkIGluc3RlYWQuYCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKHByZWZzLlNpbXVsYXRvcldpbmRvd0NlbnRlcikpIHtcbiAgICAgIC8vIGh0dHBzOi8vcmVnZXgxMDEuY29tL3IvMlpYT2lqLzJcbiAgICAgIGNvbnN0IHZlcmlmaWNhdGlvblBhdHRlcm4gPSAvey0/XFxkKyhcXC5cXGQrKT8sLT9cXGQrKFxcLlxcZCspP30vO1xuICAgICAgaWYgKCFfLmlzU3RyaW5nKHByZWZzLlNpbXVsYXRvcldpbmRvd0NlbnRlcikgfHwgIXZlcmlmaWNhdGlvblBhdHRlcm4udGVzdChwcmVmcy5TaW11bGF0b3JXaW5kb3dDZW50ZXIpKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTaW11bGF0b3JXaW5kb3dDZW50ZXIgaXMgZXhwZWN0ZWQgdG8gbWF0Y2ggXCJ7ZmxvYXRYUG9zaXRpb24sZmxvYXRZUG9zaXRpb259XCIgZm9ybWF0ICh3aXRob3V0IHNwYWNlcykuIGAgK1xuICAgICAgICAgIGAnJHtwcmVmcy5TaW11bGF0b3JXaW5kb3dDZW50ZXJ9JyBpcyBhc3NpZ25lZCBpbnN0ZWFkLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghXy5pc1VuZGVmaW5lZChwcmVmcy5TaW11bGF0b3JXaW5kb3dPcmllbnRhdGlvbikpIHtcbiAgICAgIGNvbnN0IGFjY2VwdGFibGVWYWx1ZXMgPSBbJ1BvcnRyYWl0JywgJ0xhbmRzY2FwZUxlZnQnLCAnUG9ydHJhaXRVcHNpZGVEb3duJywgJ0xhbmRzY2FwZVJpZ2h0J107XG4gICAgICBpZiAoYWNjZXB0YWJsZVZhbHVlcy5pbmRleE9mKHByZWZzLlNpbXVsYXRvcldpbmRvd09yaWVudGF0aW9uKSA9PT0gLTEpIHtcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coYFNpbXVsYXRvcldpbmRvd09yaWVudGF0aW9uIGlzIGV4cGVjdGVkIHRvIGJlIG9uZSBvZiAke2FjY2VwdGFibGVWYWx1ZXN9LiBgICtcbiAgICAgICAgICBgJyR7cHJlZnMuU2ltdWxhdG9yV2luZG93T3JpZW50YXRpb259JyBpcyBhc3NpZ25lZCBpbnN0ZWFkLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghXy5pc1VuZGVmaW5lZChwcmVmcy5TaW11bGF0b3JXaW5kb3dSb3RhdGlvbkFuZ2xlKSkge1xuICAgICAgaWYgKCFfLmlzTnVtYmVyKHByZWZzLlNpbXVsYXRvcldpbmRvd1JvdGF0aW9uQW5nbGUpKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTaW11bGF0b3JXaW5kb3dSb3RhdGlvbkFuZ2xlIGlzIGV4cGVjdGVkIHRvIGJlIGEgdmFsaWQgbnVtYmVyLiBgICtcbiAgICAgICAgICBgJyR7cHJlZnMuU2ltdWxhdG9yV2luZG93Um90YXRpb25BbmdsZX0nIGlzIGFzc2lnbmVkIGluc3RlYWQuYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSB0aGUgY29tbW9uIGlPUyBTaW11bGF0b3IgcHJlZmVyZW5jZXMgZmlsZSB3aXRoIG5ldyB2YWx1ZXMuXG4gICAqIEl0IGlzIG5lY2Vzc2FyeSB0byByZXN0YXJ0IHRoZSBjb3JyZXNwb25kaW5nIFNpbXVsYXRvciBiZWZvcmVcbiAgICogdGhlc2UgY2hhbmdlcyBhcmUgYXBwbGllZC5cbiAgICpcbiAgICogQHBhcmFtIHtEZXZpY2VQcmVmZXJlbmNlc30gZGV2aWNlUHJlZnMgW3t9XSAtIFRoZSBtYXBwaW5nLCB3aGljaCByZXByZXNlbnRzIG5ldyBkZXZpY2UgcHJlZmVyZW5jZSB2YWx1ZXNcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciB0aGUgZ2l2ZW4gU2ltdWxhdG9yLlxuICAgKiBAcGFyYW0ge0NvbW1vblByZWZlcmVuY2VzfSBjb21tb25QcmVmcyBbe31dIC0gVGhlIG1hcHBpbmcsIHdoaWNoIHJlcHJlc2VudHMgbmV3IGNvbW1vbiBwcmVmZXJlbmNlIHZhbHVlc1xuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGFsbCBTaW11bGF0b3JzLlxuICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBwcmVmZXJlbmNlcyB3ZXJlIHN1Y2Nlc3NmdWxseSB1cGRhdGVkLlxuICAgKi9cbiAgYXN5bmMgdXBkYXRlUHJlZmVyZW5jZXMgKGRldmljZVByZWZzID0ge30sIGNvbW1vblByZWZzID0ge30pIHtcbiAgICBpZiAoIV8uaXNFbXB0eShkZXZpY2VQcmVmcykpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBwcmVmZXJlbmNlcyBvZiAke3RoaXMudWRpZH0gU2ltdWxhdG9yIHRvICR7SlNPTi5zdHJpbmdpZnkoZGV2aWNlUHJlZnMpfWApO1xuICAgIH1cbiAgICBpZiAoIV8uaXNFbXB0eShjb21tb25QcmVmcykpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBjb21tb24gU2ltdWxhdG9yIHByZWZlcmVuY2VzIHRvICR7SlNPTi5zdHJpbmdpZnkoY29tbW9uUHJlZnMpfWApO1xuICAgIH1cbiAgICBjb25zdCBob21lRm9sZGVyUGF0aCA9IHByb2Nlc3MuZW52LkhPTUU7XG4gICAgaWYgKCFob21lRm9sZGVyUGF0aCkge1xuICAgICAgbG9nLndhcm4oYENhbm5vdCBnZXQgdGhlIHBhdGggdG8gSE9NRSBmb2xkZXIgZnJvbSB0aGUgcHJvY2VzcyBlbnZpcm9ubWVudC4gYCArXG4gICAgICAgIGBJZ25vcmluZyBTaW11bGF0b3IgcHJlZmVyZW5jZXMgdXBkYXRlLmApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLnZlcmlmeURldmljZVByZWZlcmVuY2VzKGRldmljZVByZWZzKTtcbiAgICBjb25zdCBwbGlzdFBhdGggPSBwYXRoLnJlc29sdmUoaG9tZUZvbGRlclBhdGgsICdMaWJyYXJ5JywgJ1ByZWZlcmVuY2VzJywgJ2NvbS5hcHBsZS5pcGhvbmVzaW11bGF0b3IucGxpc3QnKTtcbiAgICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhwbGlzdFBhdGgpKSB7XG4gICAgICBsb2cud2FybihgU2ltdWxhdG9yIHByZWZlcmVuY2VzIGZpbGUgJyR7cGxpc3RQYXRofScgaXMgbm90IGFjY2Vzc2libGUuIGAgK1xuICAgICAgICBgSWdub3JpbmcgU2ltdWxhdG9yIHByZWZlcmVuY2VzIHVwZGF0ZS5gKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgbGV0IG5ld1ByZWZzID0ge307XG4gICAgaWYgKCFfLmlzRW1wdHkoZGV2aWNlUHJlZnMpKSB7XG4gICAgICBuZXdQcmVmcy5EZXZpY2VQcmVmZXJlbmNlcyA9IHtbdGhpcy51ZGlkLnRvVXBwZXJDYXNlKCldOiBkZXZpY2VQcmVmc307XG4gICAgfVxuICAgIG5ld1ByZWZzID0gXy5tZXJnZShuZXdQcmVmcywgY29tbW9uUHJlZnMpO1xuICAgIHJldHVybiBhd2FpdCBwcmVmZXJlbmNlc1BsaXN0R3VhcmQuYWNxdWlyZShTaW11bGF0b3JYY29kZTkubmFtZSwgYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgY3VycmVudFBsaXN0Q29udGVudCA9IGF3YWl0IHBsaXN0LnBhcnNlUGxpc3RGaWxlKHBsaXN0UGF0aCk7XG4gICAgICAgIGF3YWl0IHBsaXN0LnVwZGF0ZVBsaXN0RmlsZShwbGlzdFBhdGgsIF8ubWVyZ2UoY3VycmVudFBsaXN0Q29udGVudCwgbmV3UHJlZnMpLCB0cnVlKTtcbiAgICAgICAgbG9nLmRlYnVnKGBVcGRhdGVkICR7dGhpcy51ZGlkfSBTaW11bGF0b3IgcHJlZmVyZW5jZXMgYXQgJyR7cGxpc3RQYXRofScgd2l0aCAke0pTT04uc3RyaW5naWZ5KG5ld1ByZWZzKX1gKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGBDYW5ub3QgdXBkYXRlICR7dGhpcy51ZGlkfSBTaW11bGF0b3IgcHJlZmVyZW5jZXMgYXQgJyR7cGxpc3RQYXRofScuIGAgK1xuICAgICAgICAgICAgICAgICBgVHJ5IHRvIGRlbGV0ZSB0aGUgZmlsZSBtYW51YWxseSBpbiBvcmRlciB0byByZXNldCBpdC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXQgdGhlIGN1cnJlbnQgU2ltdWxhdG9yIHRvIHRoZSBjbGVhbiBzdGF0ZS5cbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBjbGVhbiAoKSB7XG4gICAgbG9nLmluZm8oYENsZWFuaW5nIHNpbXVsYXRvciAke3RoaXMudWRpZH1gKTtcbiAgICBhd2FpdCB0aGlzLnNpbWN0bC5lcmFzZURldmljZSgxMDAwMCk7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICogQG92ZXJyaWRlXG4gICAqIEBwcml2YXRlXG4gICAqL1xuICBhc3luYyBfYWN0aXZhdGVXaW5kb3cgKCkge1xuICAgIGxldCBzZWxmTmFtZTtcbiAgICBsZXQgc2VsZlNkaztcbiAgICBsZXQgYm9vdGVkRGV2aWNlc0NvdW50ID0gMDtcbiAgICBmb3IgKGNvbnN0IFtzZGssIGRldmljZUFycl0gb2YgXy50b1BhaXJzKGF3YWl0IHRoaXMuc2ltY3RsLmdldERldmljZXMoKSkpIHtcbiAgICAgIGZvciAoY29uc3Qge3N0YXRlLCB1ZGlkLCBuYW1lfSBvZiBkZXZpY2VBcnIpIHtcbiAgICAgICAgaWYgKHN0YXRlID09PSAnQm9vdGVkJykge1xuICAgICAgICAgIGJvb3RlZERldmljZXNDb3VudCsrO1xuICAgICAgICB9XG4gICAgICAgIGlmICghc2VsZk5hbWUgJiYgdWRpZCA9PT0gdGhpcy51ZGlkKSB7XG4gICAgICAgICAgc2VsZlNkayA9IHNkaztcbiAgICAgICAgICBzZWxmTmFtZSA9IG5hbWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGJvb3RlZERldmljZXNDb3VudCA8IDIpIHtcbiAgICAgIHJldHVybiBhd2FpdCBzdXBlci5fYWN0aXZhdGVXaW5kb3coKTtcbiAgICB9XG5cbiAgICAvLyBUaGVyZSBhcmUgcG90ZW50aWFsbHkgbW9yZSB0aGF0IG9uZSBTaW11bGF0b3Igd2luZG93XG4gICAgcmV0dXJuIGBcbiAgICAgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCJcbiAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICBzZXQgZnJvbnRtb3N0IHRvIGZhbHNlXG4gICAgICAgICAgc2V0IGZyb250bW9zdCB0byB0cnVlXG4gICAgICAgICAgY2xpY2sgKG1lbnUgaXRlbSAxIHdoZXJlIChpdHMgbmFtZSBjb250YWlucyBcIiR7c2VsZk5hbWV9IFwiIGFuZCBpdHMgbmFtZSBjb250YWlucyBcIiR7c2VsZlNka31cIikpIG9mIG1lbnUgMSBvZiBtZW51IGJhciBpdGVtIFwiV2luZG93XCIgb2YgbWVudSBiYXIgMVxuICAgICAgICBlbmQgdGVsbFxuICAgICAgZW5kIHRlbGxcbiAgICBgO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgaXNCaW9tZXRyaWNFbnJvbGxlZCAoKSB7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCB0aGlzLnNpbWN0bC5zcGF3blByb2Nlc3MoW1xuICAgICAgJ25vdGlmeXV0aWwnLFxuICAgICAgJy1nJywgRU5ST0xMTUVOVF9OT1RJRklDQVRJT05fUkVDRUlWRVJcbiAgICBdKTtcbiAgICBjb25zdCBtYXRjaCA9IChuZXcgUmVnRXhwKGAke18uZXNjYXBlUmVnRXhwKEVOUk9MTE1FTlRfTk9USUZJQ0FUSU9OX1JFQ0VJVkVSKX1cXFxccysoWzAxXSlgKSlcbiAgICAgIC5leGVjKHN0ZG91dCk7XG4gICAgaWYgKCFtYXRjaCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcGFyc2UgYmlvbWV0cmljIGVucm9sbG1lbnQgc3RhdGUgZnJvbSAnJHtzdGRvdXR9J2ApO1xuICAgIH1cbiAgICBsb2cuaW5mbyhgQ3VycmVudCBiaW9tZXRyaWMgZW5yb2xsZWQgc3RhdGUgZm9yICR7dGhpcy51ZGlkfSBTaW11bGF0b3I6ICR7bWF0Y2hbMV19YCk7XG4gICAgcmV0dXJuIG1hdGNoWzFdID09PSAnMSc7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBlbnJvbGxCaW9tZXRyaWMgKGlzRW5hYmxlZCA9IHRydWUpIHtcbiAgICBsb2cuZGVidWcoYFNldHRpbmcgYmlvbWV0cmljIGVucm9sbGVkIHN0YXRlIGZvciAke3RoaXMudWRpZH0gU2ltdWxhdG9yIHRvICcke2lzRW5hYmxlZCA/ICdlbmFibGVkJyA6ICdkaXNhYmxlZCd9J2ApO1xuICAgIGF3YWl0IHRoaXMuc2ltY3RsLnNwYXduUHJvY2VzcyhbXG4gICAgICAnbm90aWZ5dXRpbCcsXG4gICAgICAnLXMnLCBFTlJPTExNRU5UX05PVElGSUNBVElPTl9SRUNFSVZFUiwgaXNFbmFibGVkID8gJzEnIDogJzAnXG4gICAgXSk7XG4gICAgYXdhaXQgdGhpcy5zaW1jdGwuc3Bhd25Qcm9jZXNzKFtcbiAgICAgICdub3RpZnl1dGlsJyxcbiAgICAgICctcCcsIEVOUk9MTE1FTlRfTk9USUZJQ0FUSU9OX1JFQ0VJVkVSXG4gICAgXSk7XG4gICAgaWYgKGF3YWl0IHRoaXMuaXNCaW9tZXRyaWNFbnJvbGxlZCgpICE9PSBpc0VuYWJsZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHNldCBiaW9tZXRyaWMgZW5yb2xsZWQgc3RhdGUgZm9yICR7dGhpcy51ZGlkfSBTaW11bGF0b3IgdG8gJyR7aXNFbmFibGVkID8gJ2VuYWJsZWQnIDogJ2Rpc2FibGVkJ30nYCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNlbmRzIGEgbm90aWZpY2F0aW9uIHRvIG1hdGNoL25vdCBtYXRjaCB0aGUgcGFydGljdWxhciBiaW9tZXRyaWMuXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0gez9ib29sZWFufSBzaG91bGRNYXRjaCBbdHJ1ZV0gLSBTZXQgaXQgdG8gdHJ1ZSBvciBmYWxzZSBpbiBvcmRlciB0byBlbXVsYXRlXG4gICAqIG1hdGNoaW5nL25vdCBtYXRjaGluZyB0aGUgY29ycmVzcG9uZGluZyBiaW9tZXRyaWNcbiAgICogQHBhcmFtIHs/c3RyaW5nfSBiaW9tZXRyaWNOYW1lIFt0b3VjaElkXSAtIEVpdGhlciB0b3VjaElkIG9yIGZhY2VJZCAoZmFjZUlkIGlzIG9ubHkgYXZhaWxhYmxlIHNpbmNlIGlPUyAxMSlcbiAgICovXG4gIGFzeW5jIHNlbmRCaW9tZXRyaWNNYXRjaCAoc2hvdWxkTWF0Y2ggPSB0cnVlLCBiaW9tZXRyaWNOYW1lID0gJ3RvdWNoSWQnKSB7XG4gICAgY29uc3QgZG9tYWluQ29tcG9uZW50ID0gdG9CaW9tZXRyaWNEb21haW5Db21wb25lbnQoYmlvbWV0cmljTmFtZSk7XG4gICAgY29uc3QgZG9tYWluID0gYGNvbS5hcHBsZS5CaW9tZXRyaWNLaXRfU2ltLiR7ZG9tYWluQ29tcG9uZW50fS4ke3Nob3VsZE1hdGNoID8gJycgOiAnbm8nfW1hdGNoYDtcbiAgICBhd2FpdCB0aGlzLnNpbWN0bC5zcGF3blByb2Nlc3MoW1xuICAgICAgJ25vdGlmeXV0aWwnLFxuICAgICAgJy1wJywgZG9tYWluXG4gICAgXSk7XG4gICAgbG9nLmluZm8oYFNlbnQgbm90aWZpY2F0aW9uICR7ZG9tYWlufSB0byAke3Nob3VsZE1hdGNoID8gJ21hdGNoJyA6ICdub3QgbWF0Y2gnfSAke2Jpb21ldHJpY05hbWV9IGJpb21ldHJpYyBgICtcbiAgICAgIGBmb3IgJHt0aGlzLnVkaWR9IFNpbXVsYXRvcmApO1xuICB9XG5cbiAgLyoqXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgZ2V0TGF1bmNoRGFlbW9uc1Jvb3QgKCkge1xuICAgIGNvbnN0IGRldlJvb3QgPSBhd2FpdCBnZXREZXZlbG9wZXJSb290KCk7XG4gICAgcmV0dXJuIHBhdGgucmVzb2x2ZShkZXZSb290LFxuICAgICAgJ1BsYXRmb3Jtcy9pUGhvbmVPUy5wbGF0Zm9ybS9EZXZlbG9wZXIvTGlicmFyeS9Db3JlU2ltdWxhdG9yL1Byb2ZpbGVzL1J1bnRpbWVzL2lPUy5zaW1ydW50aW1lL0NvbnRlbnRzL1Jlc291cmNlcy9SdW50aW1lUm9vdC9TeXN0ZW0vTGlicmFyeS9MYXVuY2hEYWVtb25zJyk7XG4gIH1cblxufVxuXG5leHBvcnQgZGVmYXVsdCBTaW11bGF0b3JYY29kZTk7XG4iXSwiZmlsZSI6ImxpYi9zaW11bGF0b3IteGNvZGUtOS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9

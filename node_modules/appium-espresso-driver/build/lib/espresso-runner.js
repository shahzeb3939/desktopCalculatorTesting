"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.TEST_APK_PKG = exports.REQUIRED_PARAMS = exports.EspressoRunner = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _serverBuilder = require("./server-builder");

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _package = require("../../package.json");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _utils = require("./utils");

var _axios = _interopRequireDefault(require("axios"));

const TEST_SERVER_ROOT = _path.default.resolve(__dirname, '..', '..', 'espresso-server');

const TEST_APK_PKG = 'io.appium.espressoserver.test';
exports.TEST_APK_PKG = TEST_APK_PKG;
const REQUIRED_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'appPackage', 'forceEspressoRebuild'];
exports.REQUIRED_PARAMS = REQUIRED_PARAMS;
const ESPRESSO_SERVER_LAUNCH_TIMEOUT_MS = 45000;
const TARGET_PACKAGE_CONTAINER = '/data/local/tmp/espresso.apppackage';

class EspressoRunner {
  constructor(opts = {}) {
    for (let req of REQUIRED_PARAMS) {
      if (!opts || !_appiumSupport.util.hasValue(opts[req])) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.host,
      port: this.systemPort,
      base: '',
      keepAlive: true
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);

    const modServerName = _appiumSupport.fs.sanitizeName(`${TEST_APK_PKG}_${_package.version}_${this.appPackage}_${this.adb.curDeviceId}.apk`, {
      replacement: '-'
    });

    this.modServerPath = _path.default.resolve(this.tmpDir, modServerName);
    this.showGradleLog = opts.showGradleLog;
    this.espressoBuildConfig = opts.espressoBuildConfig;
    this.serverLaunchTimeout = opts.serverLaunchTimeout || ESPRESSO_SERVER_LAUNCH_TIMEOUT_MS;
    this.androidInstallTimeout = opts.androidInstallTimeout;
    this.didInstrumentationCrash = false;
    this.disableSuppressAccessibilityService = opts.disableSuppressAccessibilityService;

    if (opts.useKeystore && opts.keystorePath && opts.keystorePassword && opts.keyAlias && opts.keyPassword) {
      this.signingConfig = (0, _serverBuilder.buildServerSigningConfig)({
        keystoreFile: opts.keystorePath,
        keystorePassword: opts.keystorePassword,
        keyAlias: opts.keyAlias,
        keyPassword: opts.keyPassword
      });
    } else {
      this.signingConfig = null;
    }
  }

  async isAppPackageChanged() {
    if (!(await this.adb.fileExists(TARGET_PACKAGE_CONTAINER))) {
      _logger.default.debug('The previous target application package is unknown');

      return true;
    }

    const previousAppPackage = (await this.adb.shell(['cat', TARGET_PACKAGE_CONTAINER])).trim();

    _logger.default.debug(`The previous target application package was '${previousAppPackage}'. ` + `The current package is '${this.appPackage}'`);

    return previousAppPackage !== this.appPackage;
  }

  async installServer() {
    const appState = await this.adb.getApplicationInstallState(this.modServerPath, TEST_APK_PKG);
    const shouldUninstallApp = [this.adb.APP_INSTALL_STATE.OLDER_VERSION_INSTALLED, this.adb.APP_INSTALL_STATE.NEWER_VERSION_INSTALLED].includes(appState);
    const shouldInstallApp = shouldUninstallApp || [this.adb.APP_INSTALL_STATE.NOT_INSTALLED].includes(appState);

    if (shouldUninstallApp) {
      _logger.default.info(`Uninstalling Espresso Test Server apk from the target device (pkg: '${TEST_APK_PKG}')`);

      try {
        await this.adb.uninstallApk(TEST_APK_PKG);
      } catch (err) {
        _logger.default.warn(`Error uninstalling '${TEST_APK_PKG}': ${err.message}`);
      }
    }

    if (shouldInstallApp) {
      _logger.default.info(`Installing Espresso Test Server apk from the target device (path: '${this.modServerPath}')`);

      try {
        await this.adb.install(this.modServerPath, {
          replace: false,
          timeout: this.androidInstallTimeout
        });

        _logger.default.info(`Installed Espresso Test Server apk '${this.modServerPath}' (pkg: '${TEST_APK_PKG}')`);
      } catch (err) {
        _logger.default.errorAndThrow(`Cannot install '${this.modServerPath}' because of '${err.message}'`);
      }
    }
  }

  async installTestApk() {
    let rebuild = this.forceEspressoRebuild;

    if (rebuild) {
      _logger.default.debug(`'forceEspressoRebuild' capability is enabled`);
    } else if (await this.isAppPackageChanged()) {
      _logger.default.info(`Forcing Espresso server rebuild because of changed application package`);

      rebuild = true;
    }

    if (rebuild && (await _appiumSupport.fs.exists(this.modServerPath))) {
      _logger.default.debug(`Deleting the obsolete Espresso server package '${this.modServerPath}'`);

      await _appiumSupport.fs.unlink(this.modServerPath);
    }

    if (!(await _appiumSupport.fs.exists(this.modServerPath))) {
      await this.buildNewModServer();
    }

    const isSigned = await this.adb.checkApkCert(this.modServerPath, TEST_APK_PKG);

    if (!isSigned) {
      await this.adb.sign(this.modServerPath);
    }

    if ((rebuild || !isSigned) && (await this.adb.uninstallApk(TEST_APK_PKG))) {
      _logger.default.info('Uninstalled the obsolete Espresso server package from the device under test');
    }

    await this.installServer();
  }

  async buildNewModServer() {
    let buildConfiguration = {};

    if (this.espressoBuildConfig) {
      let buildConfigurationStr;

      if (await _appiumSupport.fs.exists(this.espressoBuildConfig)) {
        _logger.default.info(`Loading the build configuration from '${this.espressoBuildConfig}'`);

        buildConfigurationStr = await _appiumSupport.fs.readFile(this.espressoBuildConfig, 'utf8');
      } else {
        _logger.default.info(`Loading the build configuration from 'espressoBuildConfig' capability`);

        buildConfigurationStr = this.espressoBuildConfig;
      }

      try {
        buildConfiguration = JSON.parse(buildConfigurationStr);
      } catch (e) {
        _logger.default.error('Cannot parse the build configuration JSON', e);

        throw e;
      }
    }

    const dirName = _appiumSupport.fs.sanitizeName(`espresso-server-${this.adb.curDeviceId}`, {
      replacement: '-'
    });

    const serverPath = _path.default.resolve(this.tmpDir, dirName);

    _logger.default.info(`Building espresso server in '${serverPath}'`);

    _logger.default.debug(`The build folder root could be customized by changing the 'tmpDir' capability`);

    await _appiumSupport.fs.rimraf(serverPath);
    await (0, _appiumSupport.mkdirp)(serverPath);

    _logger.default.debug(`Copying espresso server template from ('${TEST_SERVER_ROOT}' to '${serverPath}')`);

    await (0, _utils.copyGradleProjectRecursively)(TEST_SERVER_ROOT, serverPath);

    _logger.default.debug('Bulding espresso server');

    await new _serverBuilder.ServerBuilder({
      serverPath,
      buildConfiguration,
      showGradleLog: this.showGradleLog,
      testAppPackage: this.appPackage,
      signingConfig: this.signingConfig
    }).build();

    const apkPath = _path.default.resolve(serverPath, 'app', 'build', 'outputs', 'apk', 'androidTest', 'debug', 'app-debug-androidTest.apk');

    _logger.default.debug(`Copying built apk from '${apkPath}' to '${this.modServerPath}'`);

    await _appiumSupport.fs.copyFile(apkPath, this.modServerPath);
  }

  async cleanupSessionLeftovers() {
    _logger.default.debug('Performing cleanup of automation leftovers');

    try {
      const {
        value
      } = (await (0, _axios.default)({
        url: `http://${this.host}:${this.systemPort}/sessions`,
        timeout: 500
      })).data;
      const activeSessionIds = value.map(sess => sess.id);

      if (activeSessionIds.length) {
        _logger.default.debug(`The following obsolete sessions are still running: ${JSON.stringify(activeSessionIds)}`);

        _logger.default.debug('Cleaning up the obsolete sessions');

        await _bluebird.default.all(activeSessionIds.map(id => (0, _axios.default)({
          url: `http://${this.host}:${this.systemPort}/session/${id}`,
          method: 'DELETE'
        })));
        await _bluebird.default.delay(1000);
      } else {
        _logger.default.debug('No obsolete sessions have been detected');
      }
    } catch (e) {
      _logger.default.debug(`No obsolete sessions have been detected (${e.message})`);
    }
  }

  async startSession(caps) {
    await this.cleanupSessionLeftovers();
    const cmd = ['shell', 'am', 'instrument', '-w', '-e', 'debug', process.env.ESPRESSO_JAVA_DEBUG === 'true'];

    if (_lodash.default.isBoolean(this.disableSuppressAccessibilityService)) {
      cmd.push('-e', 'DISABLE_SUPPRESS_ACCESSIBILITY_SERVICES', this.disableSuppressAccessibilityService);
    }

    cmd.push(`${TEST_APK_PKG}/androidx.test.runner.AndroidJUnitRunner`);

    _logger.default.info(`Starting Espresso Server v${_package.version} with cmd: adb ${cmd.join(' ')}`);

    let hasSocketError = false;
    let didInstrumentationQuit = false;
    this.instProcess = this.adb.createSubProcess(cmd);
    this.instProcess.on('exit', (code, signal) => {
      _logger.default.info(`Instrumentation process exited with code ${code} from signal ${signal}`);

      didInstrumentationQuit = true;
    });
    this.instProcess.on('die', (code, signal) => {
      _logger.default.error(`Instrumentation process died with code ${code} and signal ${signal}`);

      didInstrumentationQuit = true;
    });
    this.instProcess.on('stream-line', line => {
      if (_lodash.default.isEmpty(line.trim())) {
        return;
      }

      _logger.default.debug(`[Instrumentation] ${line.trim()}`);

      if (line.toLowerCase().includes('java.net.socketexception')) {
        hasSocketError = true;
      } else if (line.includes('Process crashed')) {
        this.didInstrumentationCrash = true;
      }
    });
    const timer = new _appiumSupport.timing.Timer().start();
    await this.instProcess.start(0);

    _logger.default.info(`Waiting up to ${this.serverLaunchTimeout}ms for Espresso server to be online`);

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        if (hasSocketError) {
          _logger.default.errorAndThrow(`Espresso server has failed to start due to an unexpected exception. ` + `Make sure the 'INTERNET' permission is requested in the Android manifest of your ` + `application under test (<uses-permission android:name="android.permission.INTERNET" />)`);
        } else if (didInstrumentationQuit) {
          _logger.default.errorAndThrow(`Espresso server process has been unexpectedly terminated. ` + `Check the Appium server log and the logcat output for more details`);
        }

        try {
          await this.jwproxy.command('/status', 'GET');
          return true;
        } catch (e) {
          return false;
        }
      }, {
        waitMs: this.serverLaunchTimeout,
        intervalMs: 500
      });
    } catch (e) {
      if (/Condition unmet/.test(e.message)) {
        _logger.default.errorAndThrow(`Timed out waiting for Espresso server to be ` + `online within ${this.serverLaunchTimeout}ms. The timeout value could be ` + `customized using 'espressoServerLaunchTimeout' capability`);
      }

      throw e;
    }

    _logger.default.info(`Espresso server is online. ` + `The initialization process took ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);

    _logger.default.info('Starting the session');

    await this.jwproxy.command('/session', 'POST', {
      capabilities: {
        firstMatch: [caps],
        alwaysMatch: {}
      }
    });
    await this.recordTargetAppPackage();
  }

  async recordTargetAppPackage() {
    await this.adb.shell([`echo "${this.appPackage}" > "${TARGET_PACKAGE_CONTAINER}"`]);

    _logger.default.info(`Recorded the target application package '${this.appPackage}' to ${TARGET_PACKAGE_CONTAINER}`);
  }

  async deleteSession() {
    _logger.default.debug('Deleting Espresso server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation Espresso deleteSession worked; ` + `Error was: ${err}`);
    }

    if (this.instProcess && this.instProcess.isRunning) {
      await this.instProcess.stop();
    }
  }

}

exports.EspressoRunner = EspressoRunner;
var _default = EspressoRunner;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9lc3ByZXNzby1ydW5uZXIuanMiXSwibmFtZXMiOlsiVEVTVF9TRVJWRVJfUk9PVCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiVEVTVF9BUEtfUEtHIiwiUkVRVUlSRURfUEFSQU1TIiwiRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUX01TIiwiVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSIiwiRXNwcmVzc29SdW5uZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJyZXEiLCJ1dGlsIiwiaGFzVmFsdWUiLCJFcnJvciIsImp3cHJveHkiLCJKV1Byb3h5Iiwic2VydmVyIiwiaG9zdCIsInBvcnQiLCJzeXN0ZW1Qb3J0IiwiYmFzZSIsImtlZXBBbGl2ZSIsInByb3h5UmVxUmVzIiwiYmluZCIsIm1vZFNlcnZlck5hbWUiLCJmcyIsInNhbml0aXplTmFtZSIsInZlcnNpb24iLCJhcHBQYWNrYWdlIiwiYWRiIiwiY3VyRGV2aWNlSWQiLCJyZXBsYWNlbWVudCIsIm1vZFNlcnZlclBhdGgiLCJ0bXBEaXIiLCJzaG93R3JhZGxlTG9nIiwiZXNwcmVzc29CdWlsZENvbmZpZyIsInNlcnZlckxhdW5jaFRpbWVvdXQiLCJhbmRyb2lkSW5zdGFsbFRpbWVvdXQiLCJkaWRJbnN0cnVtZW50YXRpb25DcmFzaCIsImRpc2FibGVTdXBwcmVzc0FjY2Vzc2liaWxpdHlTZXJ2aWNlIiwidXNlS2V5c3RvcmUiLCJrZXlzdG9yZVBhdGgiLCJrZXlzdG9yZVBhc3N3b3JkIiwia2V5QWxpYXMiLCJrZXlQYXNzd29yZCIsInNpZ25pbmdDb25maWciLCJrZXlzdG9yZUZpbGUiLCJpc0FwcFBhY2thZ2VDaGFuZ2VkIiwiZmlsZUV4aXN0cyIsImxvZ2dlciIsImRlYnVnIiwicHJldmlvdXNBcHBQYWNrYWdlIiwic2hlbGwiLCJ0cmltIiwiaW5zdGFsbFNlcnZlciIsImFwcFN0YXRlIiwiZ2V0QXBwbGljYXRpb25JbnN0YWxsU3RhdGUiLCJzaG91bGRVbmluc3RhbGxBcHAiLCJBUFBfSU5TVEFMTF9TVEFURSIsIk9MREVSX1ZFUlNJT05fSU5TVEFMTEVEIiwiTkVXRVJfVkVSU0lPTl9JTlNUQUxMRUQiLCJpbmNsdWRlcyIsInNob3VsZEluc3RhbGxBcHAiLCJOT1RfSU5TVEFMTEVEIiwiaW5mbyIsInVuaW5zdGFsbEFwayIsImVyciIsIndhcm4iLCJtZXNzYWdlIiwiaW5zdGFsbCIsInJlcGxhY2UiLCJ0aW1lb3V0IiwiZXJyb3JBbmRUaHJvdyIsImluc3RhbGxUZXN0QXBrIiwicmVidWlsZCIsImZvcmNlRXNwcmVzc29SZWJ1aWxkIiwiZXhpc3RzIiwidW5saW5rIiwiYnVpbGROZXdNb2RTZXJ2ZXIiLCJpc1NpZ25lZCIsImNoZWNrQXBrQ2VydCIsInNpZ24iLCJidWlsZENvbmZpZ3VyYXRpb24iLCJidWlsZENvbmZpZ3VyYXRpb25TdHIiLCJyZWFkRmlsZSIsIkpTT04iLCJwYXJzZSIsImUiLCJlcnJvciIsImRpck5hbWUiLCJzZXJ2ZXJQYXRoIiwicmltcmFmIiwiU2VydmVyQnVpbGRlciIsInRlc3RBcHBQYWNrYWdlIiwiYnVpbGQiLCJhcGtQYXRoIiwiY29weUZpbGUiLCJjbGVhbnVwU2Vzc2lvbkxlZnRvdmVycyIsInZhbHVlIiwidXJsIiwiZGF0YSIsImFjdGl2ZVNlc3Npb25JZHMiLCJtYXAiLCJzZXNzIiwiaWQiLCJsZW5ndGgiLCJzdHJpbmdpZnkiLCJCIiwiYWxsIiwibWV0aG9kIiwiZGVsYXkiLCJzdGFydFNlc3Npb24iLCJjYXBzIiwiY21kIiwicHJvY2VzcyIsImVudiIsIkVTUFJFU1NPX0pBVkFfREVCVUciLCJfIiwiaXNCb29sZWFuIiwicHVzaCIsImpvaW4iLCJoYXNTb2NrZXRFcnJvciIsImRpZEluc3RydW1lbnRhdGlvblF1aXQiLCJpbnN0UHJvY2VzcyIsImNyZWF0ZVN1YlByb2Nlc3MiLCJvbiIsImNvZGUiLCJzaWduYWwiLCJsaW5lIiwiaXNFbXB0eSIsInRvTG93ZXJDYXNlIiwidGltZXIiLCJ0aW1pbmciLCJUaW1lciIsInN0YXJ0IiwiY29tbWFuZCIsIndhaXRNcyIsImludGVydmFsTXMiLCJ0ZXN0IiwiZ2V0RHVyYXRpb24iLCJhc01pbGxpU2Vjb25kcyIsInRvRml4ZWQiLCJjYXBhYmlsaXRpZXMiLCJmaXJzdE1hdGNoIiwiYWx3YXlzTWF0Y2giLCJyZWNvcmRUYXJnZXRBcHBQYWNrYWdlIiwiZGVsZXRlU2Vzc2lvbiIsImlzUnVubmluZyIsInN0b3AiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsZ0JBQWdCLEdBQUdDLGNBQUtDLE9BQUwsQ0FBYUMsU0FBYixFQUF3QixJQUF4QixFQUE4QixJQUE5QixFQUFvQyxpQkFBcEMsQ0FBekI7O0FBQ0EsTUFBTUMsWUFBWSxHQUFHLCtCQUFyQjs7QUFDQSxNQUFNQyxlQUFlLEdBQUcsQ0FDdEIsS0FEc0IsRUFFdEIsUUFGc0IsRUFHdEIsTUFIc0IsRUFJdEIsWUFKc0IsRUFLdEIsWUFMc0IsRUFNdEIsWUFOc0IsRUFPdEIsc0JBUHNCLENBQXhCOztBQVNBLE1BQU1DLGlDQUFpQyxHQUFHLEtBQTFDO0FBQ0EsTUFBTUMsd0JBQXdCLEdBQUcscUNBQWpDOztBQUVBLE1BQU1DLGNBQU4sQ0FBcUI7QUFDbkJDLEVBQUFBLFdBQVcsQ0FBRUMsSUFBSSxHQUFHLEVBQVQsRUFBYTtBQUN0QixTQUFLLElBQUlDLEdBQVQsSUFBZ0JOLGVBQWhCLEVBQWlDO0FBQy9CLFVBQUksQ0FBQ0ssSUFBRCxJQUFTLENBQUNFLG9CQUFLQyxRQUFMLENBQWNILElBQUksQ0FBQ0MsR0FBRCxDQUFsQixDQUFkLEVBQXdDO0FBQ3RDLGNBQU0sSUFBSUcsS0FBSixDQUFXLFdBQVVILEdBQUksZ0JBQXpCLENBQU47QUFDRDs7QUFDRCxXQUFLQSxHQUFMLElBQVlELElBQUksQ0FBQ0MsR0FBRCxDQUFoQjtBQUNEOztBQUNELFNBQUtJLE9BQUwsR0FBZSxJQUFJQyx5QkFBSixDQUFZO0FB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SUFBRCxDQURBO0FBRVpnQyxRQUFBQSxXQUFXLEVBQUU7QUFGRDtBQUQrQixLQUF6QyxDQUFOO0FBTUEsVUFBTSxLQUFLQyxzQkFBTCxFQUFOO0FBQ0Q7O0FBRUQsUUFBTUEsc0JBQU4sR0FBZ0M7QUFDOUIsVUFBTSxLQUFLcEgsR0FBTCxDQUFTdUIsS0FBVCxDQUFlLENBQUUsU0FBUSxLQUFLeEIsVUFBVyxRQUFPdEIsd0JBQXlCLEdBQTFELENBQWYsQ0FBTjs7QUFDQTJDLG9CQUFPZSxJQUFQLENBQWEsNENBQTJDLEtBQUtwQyxVQUFXLFFBQU90Qix3QkFBeUIsRUFBeEc7QUFDRDs7QUFFRCxRQUFNNEksYUFBTixHQUF1QjtBQUNyQmpHLG9CQUFPQyxLQUFQLENBQWEsa0NBQWI7O0FBR0EsUUFBSTtBQUNGLFlBQU0sS0FBS3BDLE9BQUwsQ0FBYXlILE9BQWIsQ0FBcUIsR0FBckIsRUFBMEIsUUFBMUIsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPckUsR0FBUCxFQUFZO0FBQ1pqQixzQkFBT2tCLElBQVAsQ0FBYSwwREFBRCxHQUNQLGNBQWFELEdBQUksRUFEdEI7QUFFRDs7QUFFRCxRQUFJLEtBQUt5RCxXQUFMLElBQW9CLEtBQUtBLFdBQUwsQ0FBaUJ3QixTQUF6QyxFQUFvRDtBQUNsRCxZQUFNLEtBQUt4QixXQUFMLENBQWlCeUIsSUFBakIsRUFBTjtBQUNEO0FBQ0Y7O0FBcFNrQjs7O2VBd1NON0ksYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgU2VydmVyQnVpbGRlciwgYnVpbGRTZXJ2ZXJTaWduaW5nQ29uZmlnIH0gZnJvbSAnLi9zZXJ2ZXItYnVpbGRlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCB1dGlsLCBta2RpcnAsIHRpbWluZyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IHZlcnNpb24gfSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGltcG9ydC9uby11bnJlc29sdmVkXG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgY29weUdyYWRsZVByb2plY3RSZWN1cnNpdmVseSB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcblxuXG5jb25zdCBURVNUX1NFUlZFUl9ST09UID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ2VzcHJlc3NvLXNlcnZlcicpO1xuY29uc3QgVEVTVF9BUEtfUEtHID0gJ2lvLmFwcGl1bS5lc3ByZXNzb3NlcnZlci50ZXN0JztcbmNvbnN0IFJFUVVJUkVEX1BBUkFNUyA9IFtcbiAgJ2FkYicsXG4gICd0bXBEaXInLFxuICAnaG9zdCcsXG4gICdzeXN0ZW1Qb3J0JyxcbiAgJ2RldmljZVBvcnQnLFxuICAnYXBwUGFja2FnZScsXG4gICdmb3JjZUVzcHJlc3NvUmVidWlsZCcsXG5dO1xuY29uc3QgRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUX01TID0gNDUwMDA7XG5jb25zdCBUQVJHRVRfUEFDS0FHRV9DT05UQUlORVIgPSAnL2RhdGEvbG9jYWwvdG1wL2VzcHJlc3NvLmFwcHBhY2thZ2UnO1xuXG5jbGFzcyBFc3ByZXNzb1J1bm5lciB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBmb3IgKGxldCByZXEgb2YgUkVRVUlSRURfUEFSQU1TKSB7XG4gICAgICBpZiAoIW9wdHMgfHwgIXV0aWwuaGFzVmFsdWUob3B0c1tyZXFdKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE9wdGlvbiAnJHtyZXF9JyBpcyByZXF1aXJlZCFgKTtcbiAgICAgIH1cbiAgICAgIHRoaXNbcmVxXSA9IG9wdHNbcmVxXTtcbiAgICB9XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkoe1xuICAgICAgc2VydmVyOiB0aGlzLmhvc3QsXG4gICAgICBwb3J0OiB0aGlzLnN5c3RlbVBvcnQsXG4gICAgICBiYXNlOiAnJyxcbiAgICAgIGtlZXBBbGl2ZTogdHJ1ZSxcbiAgICB9KTtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy5qd3Byb3h5KTtcblxuICAgIGNvbnN0IG1vZFNlcnZlck5hbWUgPSBmcy5zYW5pdGl6ZU5hbWUoYCR7VEVTVF9BUEtfUEtHfV8ke3ZlcnNpb259XyR7dGhpcy5hcHBQYWNrYWdlfV8ke3RoaXMuYWRiLmN1ckRldmljZUlkfS5hcGtgLCB7XG4gICAgICByZXBsYWNlbWVudDogJy0nLFxuICAgIH0pO1xuICAgIHRoaXMubW9kU2VydmVyUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgbW9kU2VydmVyTmFtZSk7XG4gICAgdGhpcy5zaG93R3JhZGxlTG9nID0gb3B0cy5zaG93R3JhZGxlTG9nO1xuICAgIHRoaXMuZXNwcmVzc29CdWlsZENvbmZpZyA9IG9wdHMuZXNwcmVzc29CdWlsZENvbmZpZztcblxuICAgIHRoaXMuc2VydmVyTGF1bmNoVGltZW91dCA9IG9wdHMuc2VydmVyTGF1bmNoVGltZW91dCB8fCBFU1BSRVNTT19TRVJWRVJfTEFVTkNIX1RJTUVPVVRfTVM7XG4gICAgdGhpcy5hbmRyb2lkSW5zdGFsbFRpbWVvdXQgPSBvcHRzLmFuZHJvaWRJbnN0YWxsVGltZW91dDtcbiAgICB0aGlzLmRpZEluc3RydW1lbnRhdGlvbkNyYXNoID0gZmFsc2U7XG5cbiAgICB0aGlzLmRpc2FibGVTdXBwcmVzc0FjY2Vzc2liaWxpdHlTZXJ2aWNlID0gb3B0cy5kaXNhYmxlU3VwcHJlc3NBY2Nlc3NpYmlsaXR5U2VydmljZTtcblxuICAgIC8vIEVzcHJlc3NvIFNlcnZlciBhcHAgbmVlZHMgdG8gYmUgc2lnbmVkIHdpdGggc2FtZSBrZXlTdG9yZSBhcyBhcHBQYWNrYWdlXG4gICAgaWYgKG9wdHMudXNlS2V5c3RvcmUgJiYgb3B0cy5rZXlzdG9yZVBhdGggJiYgb3B0cy5rZXlzdG9yZVBhc3N3b3JkICYmIG9wdHMua2V5QWxpYXMgJiYgb3B0cy5rZXlQYXNzd29yZCkge1xuICAgICAgdGhpcy5zaWduaW5nQ29uZmlnID0gYnVpbGRTZXJ2ZXJTaWduaW5nQ29uZmlnKHtcbiAgICAgICAga2V5c3RvcmVGaWxlOiBvcHRzLmtleXN0b3JlUGF0aCxcbiAgICAgICAga2V5c3RvcmVQYXNzd29yZDogb3B0cy5rZXlzdG9yZVBhc3N3b3JkLFxuICAgICAgICBrZXlBbGlhczogb3B0cy5rZXlBbGlhcyxcbiAgICAgICAga2V5UGFzc3dvcmQ6IG9wdHMua2V5UGFzc3dvcmRcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNpZ25pbmdDb25maWcgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGlzQXBwUGFja2FnZUNoYW5nZWQgKCkge1xuICAgIGlmICghYXdhaXQgdGhpcy5hZGIuZmlsZUV4aXN0cyhUQVJHRVRfUEFDS0FHRV9DT05UQUlORVIpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ1RoZSBwcmV2aW91cyB0YXJnZXQgYXBwbGljYXRpb24gcGFja2FnZSBpcyB1bmtub3duJyk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgY29uc3QgcHJldmlvdXNBcHBQYWNrYWdlID0gKGF3YWl0IHRoaXMuYWRiLnNoZWxsKFsnY2F0JywgVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSXSkpLnRyaW0oKTtcbiAgICBsb2dnZXIuZGVidWcoYFRoZSBwcmV2aW91cyB0YXJnZXQgYXBwbGljYXRpb24gcGFja2FnZSB3YXMgJyR7cHJldmlvdXNBcHBQYWNrYWdlfScuIGAgK1xuICAgICAgYFRoZSBjdXJyZW50IHBhY2thZ2UgaXMgJyR7dGhpcy5hcHBQYWNrYWdlfSdgKTtcbiAgICByZXR1cm4gcHJldmlvdXNBcHBQYWNrYWdlICE9PSB0aGlzLmFwcFBhY2thZ2U7XG4gIH1cblxuICAvKipcbiAgICogSW5zdGFsbHMgRXNwcmVzc28gc2VydmVyIGFwayBvbiB0byB0aGUgZGV2aWNlIG9yIGVtdWxhdG9yLlxuICAgKiBFYWNoIGFkYiBjb21tYW5kIHVzZXMgZGVmYXVsdCB0aW1lb3V0IGJ5IHRoZW0uXG4gICAqL1xuICBhc3luYyBpbnN0YWxsU2VydmVyICgpIHtcbiAgICBjb25zdCBhcHBTdGF0ZSA9IGF3YWl0IHRoaXMuYWRiLmdldEFwcGxpY2F0aW9uSW5zdGFsbFN0YXRlKHRoaXMubW9kU2VydmVyUGF0aCwgVEVTVF9BUEtfUEtHKTtcblxuICAgIGNvbnN0IHNob3VsZFVuaW5zdGFsbEFwcCA9IFtcbiAgICAgIHRoaXMuYWRiLkFQUF9JTlNUQUxMX1NUQVRFLk9MREVSX1ZFUlNJT05fSU5TVEFMTEVELFxuICAgICAgdGhpcy5hZGIuQVBQX0lOU1RBTExfU1RBVEUuTkVXRVJfVkVSU0lPTl9JTlNUQUxMRURcbiAgICBdLmluY2x1ZGVzKGFwcFN0YXRlKTtcbiAgICBjb25zdCBzaG91bGRJbnN0YWxsQXBwID0gc2hvdWxkVW5pbnN0YWxsQXBwIHx8IFtcbiAgICAgIHRoaXMuYWRiLkFQUF9JTlNUQUxMX1NUQVRFLk5PVF9JTlNUQUxMRURcbiAgICBdLmluY2x1ZGVzKGFwcFN0YXRlKTtcblxuICAgIGlmIChzaG91bGRVbmluc3RhbGxBcHApIHtcbiAgICAgIGxvZ2dlci5pbmZvKGBVbmluc3RhbGxpbmcgRXNwcmVzc28gVGVzdCBTZXJ2ZXIgYXBrIGZyb20gdGhlIHRhcmdldCBkZXZpY2UgKHBrZzogJyR7VEVTVF9BUEtfUEtHfScpYCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmFkYi51bmluc3RhbGxBcGsoVEVTVF9BUEtfUEtHKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2dnZXIud2FybihgRXJyb3IgdW5pbnN0YWxsaW5nICcke1RFU1RfQVBLX1BLR30nOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChzaG91bGRJbnN0YWxsQXBwKSB7XG4gICAgICBsb2dnZXIuaW5mbyhgSW5zdGFsbGluZyBFc3ByZXNzbyBUZXN0IFNlcnZlciBhcGsgZnJvbSB0aGUgdGFyZ2V0IGRldmljZSAocGF0aDogJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofScpYCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmFkYi5pbnN0YWxsKHRoaXMubW9kU2VydmVyUGF0aCwgeyByZXBsYWNlOiBmYWxzZSwgdGltZW91dDogdGhpcy5hbmRyb2lkSW5zdGFsbFRpbWVvdXQgfSk7XG4gICAgICAgIGxvZ2dlci5pbmZvKGBJbnN0YWxsZWQgRXNwcmVzc28gVGVzdCBTZXJ2ZXIgYXBrICcke3RoaXMubW9kU2VydmVyUGF0aH0nIChwa2c6ICcke1RFU1RfQVBLX1BLR30nKWApO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBDYW5ub3QgaW5zdGFsbCAnJHt0aGlzLm1vZFNlcnZlclBhdGh9JyBiZWNhdXNlIG9mICcke2Vyci5tZXNzYWdlfSdgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBpbnN0YWxsVGVzdEFwayAoKSB7XG4gICAgbGV0IHJlYnVpbGQgPSB0aGlzLmZvcmNlRXNwcmVzc29SZWJ1aWxkO1xuICAgIGlmIChyZWJ1aWxkKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYCdmb3JjZUVzcHJlc3NvUmVidWlsZCcgY2FwYWJpbGl0eSBpcyBlbmFibGVkYCk7XG4gICAgfSBlbHNlIGlmIChhd2FpdCB0aGlzLmlzQXBwUGFja2FnZUNoYW5nZWQoKSkge1xuICAgICAgbG9nZ2VyLmluZm8oYEZvcmNpbmcgRXNwcmVzc28gc2VydmVyIHJlYnVpbGQgYmVjYXVzZSBvZiBjaGFuZ2VkIGFwcGxpY2F0aW9uIHBhY2thZ2VgKTtcbiAgICAgIHJlYnVpbGQgPSB0cnVlO1xuICAgIH1cblxuICAgIGlmIChyZWJ1aWxkICYmIGF3YWl0IGZzLmV4aXN0cyh0aGlzLm1vZFNlcnZlclBhdGgpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYERlbGV0aW5nIHRoZSBvYnNvbGV0ZSBFc3ByZXNzbyBzZXJ2ZXIgcGFja2FnZSAnJHt0aGlzLm1vZFNlcnZlclBhdGh9J2ApO1xuICAgICAgYXdhaXQgZnMudW5saW5rKHRoaXMubW9kU2VydmVyUGF0aCk7XG4gICAgfVxuICAgIGlmICghKGF3YWl0IGZzLmV4aXN0cyh0aGlzLm1vZFNlcnZlclBhdGgpKSkge1xuICAgICAgYXdhaXQgdGhpcy5idWlsZE5ld01vZFNlcnZlcigpO1xuICAgIH1cbiAgICBjb25zdCBpc1NpZ25lZCA9IGF3YWl0IHRoaXMuYWRiLmNoZWNrQXBrQ2VydCh0aGlzLm1vZFNlcnZlclBhdGgsIFRFU1RfQVBLX1BLRyk7XG4gICAgaWYgKCFpc1NpZ25lZCkge1xuICAgICAgYXdhaXQgdGhpcy5hZGIuc2lnbih0aGlzLm1vZFNlcnZlclBhdGgpO1xuICAgIH1cbiAgICBpZiAoKHJlYnVpbGQgfHwgIWlzU2lnbmVkKSAmJiBhd2FpdCB0aGlzLmFkYi51bmluc3RhbGxBcGsoVEVTVF9BUEtfUEtHKSkge1xuICAgICAgbG9nZ2VyLmluZm8oJ1VuaW5zdGFsbGVkIHRoZSBvYnNvbGV0ZSBFc3ByZXNzbyBzZXJ2ZXIgcGFja2FnZSBmcm9tIHRoZSBkZXZpY2UgdW5kZXIgdGVzdCcpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuaW5zdGFsbFNlcnZlcigpO1xuICB9XG5cbiAgYXN5bmMgYnVpbGROZXdNb2RTZXJ2ZXIgKCkge1xuICAgIGxldCBidWlsZENvbmZpZ3VyYXRpb24gPSB7fTtcbiAgICBpZiAodGhpcy5lc3ByZXNzb0J1aWxkQ29uZmlnKSB7XG4gICAgICBsZXQgYnVpbGRDb25maWd1cmF0aW9uU3RyO1xuICAgICAgaWYgKGF3YWl0IGZzLmV4aXN0cyh0aGlzLmVzcHJlc3NvQnVpbGRDb25maWcpKSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKGBMb2FkaW5nIHRoZSBidWlsZCBjb25maWd1cmF0aW9uIGZyb20gJyR7dGhpcy5lc3ByZXNzb0J1aWxkQ29uZmlnfSdgKTtcbiAgICAgICAgYnVpbGRDb25maWd1cmF0aW9uU3RyID0gYXdhaXQgZnMucmVhZEZpbGUodGhpcy5lc3ByZXNzb0J1aWxkQ29uZmlnLCAndXRmOCcpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oYExvYWRpbmcgdGhlIGJ1aWxkIGNvbmZpZ3VyYXRpb24gZnJvbSAnZXNwcmVzc29CdWlsZENvbmZpZycgY2FwYWJpbGl0eWApO1xuICAgICAgICBidWlsZENvbmZpZ3VyYXRpb25TdHIgPSB0aGlzLmVzcHJlc3NvQnVpbGRDb25maWc7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBidWlsZENvbmZpZ3VyYXRpb24gPSBKU09OLnBhcnNlKGJ1aWxkQ29uZmlndXJhdGlvblN0cik7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignQ2Fubm90IHBhcnNlIHRoZSBidWlsZCBjb25maWd1cmF0aW9uIEpTT04nLCBlKTtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgZGlyTmFtZSA9IGZzLnNhbml0aXplTmFtZShgZXNwcmVzc28tc2VydmVyLSR7dGhpcy5hZGIuY3VyRGV2aWNlSWR9YCwge1xuICAgICAgcmVwbGFjZW1lbnQ6ICctJyxcbiAgICB9KTtcbiAgICBjb25zdCBzZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCBkaXJOYW1lKTtcbiAgICBsb2dnZXIuaW5mbyhgQnVpbGRpbmcgZXNwcmVzc28gc2VydmVyIGluICcke3NlcnZlclBhdGh9J2ApO1xuICAgIGxvZ2dlci5kZWJ1ZyhgVGhlIGJ1aWxkIGZvbGRlciByb290IGNvdWxkIGJlIGN1c3RvbWl6ZWQgYnkgY2hhbmdpbmcgdGhlICd0bXBEaXInIGNhcGFiaWxpdHlgKTtcbiAgICBhd2FpdCBmcy5yaW1yYWYoc2VydmVyUGF0aCk7XG4gICAgYXdhaXQgbWtkaXJwKHNlcnZlclBhdGgpO1xuICAgIGxvZ2dlci5kZWJ1ZyhgQ29weWluZyBlc3ByZXNzbyBzZXJ2ZXIgdGVtcGxhdGUgZnJvbSAoJyR7VEVTVF9TRVJWRVJfUk9PVH0nIHRvICcke3NlcnZlclBhdGh9JylgKTtcbiAgICBhd2FpdCBjb3B5R3JhZGxlUHJvamVjdFJlY3Vyc2l2ZWx5KFRFU1RfU0VSVkVSX1JPT1QsIHNlcnZlclBhdGgpO1xuICAgIGxvZ2dlci5kZWJ1ZygnQnVsZGluZyBlc3ByZXNzbyBzZXJ2ZXInKTtcbiAgICBhd2FpdCBuZXcgU2VydmVyQnVpbGRlcih7XG4gICAgICBzZXJ2ZXJQYXRoLCBidWlsZENvbmZpZ3VyYXRpb24sXG4gICAgICBzaG93R3JhZGxlTG9nOiB0aGlzLnNob3dHcmFkbGVMb2csXG4gICAgICB0ZXN0QXBwUGFja2FnZTogdGhpcy5hcHBQYWNrYWdlLFxuICAgICAgc2lnbmluZ0NvbmZpZzogdGhpcy5zaWduaW5nQ29uZmlnXG4gICAgfSkuYnVpbGQoKTtcbiAgICBjb25zdCBhcGtQYXRoID0gcGF0aC5yZXNvbHZlKHNlcnZlclBhdGgsICdhcHAnLCAnYnVpbGQnLCAnb3V0cHV0cycsICdhcGsnLCAnYW5kcm9pZFRlc3QnLCAnZGVidWcnLCAnYXBwLWRlYnVnLWFuZHJvaWRUZXN0LmFwaycpO1xuICAgIGxvZ2dlci5kZWJ1ZyhgQ29weWluZyBidWlsdCBhcGsgZnJvbSAnJHthcGtQYXRofScgdG8gJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofSdgKTtcbiAgICBhd2FpdCBmcy5jb3B5RmlsZShhcGtQYXRoLCB0aGlzLm1vZFNlcnZlclBhdGgpO1xuICB9XG5cbiAgYXN5bmMgY2xlYW51cFNlc3Npb25MZWZ0b3ZlcnMgKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnUGVyZm9ybWluZyBjbGVhbnVwIG9mIGF1dG9tYXRpb24gbGVmdG92ZXJzJyk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qge3ZhbHVlfSA9IChhd2FpdCBheGlvcyh7XG4gICAgICAgIHVybDogYGh0dHA6Ly8ke3RoaXMuaG9zdH06JHt0aGlzLnN5c3RlbVBvcnR9L3Nlc3Npb25zYCxcbiAgICAgICAgdGltZW91dDogNTAwLFxuICAgICAgfSkpLmRhdGE7XG4gICAgICBjb25zdCBhY3RpdmVTZXNzaW9uSWRzID0gdmFsdWUubWFwKChzZXNzKSA9PiBzZXNzLmlkKTtcbiAgICAgIGlmIChhY3RpdmVTZXNzaW9uSWRzLmxlbmd0aCkge1xuICAgICAgICBsb2dnZXIuZGVidWcoYFRoZSBmb2xsb3dpbmcgb2Jzb2xldGUgc2Vzc2lvbnMgYXJlIHN0aWxsIHJ1bm5pbmc6ICR7SlNPTi5zdHJpbmdpZnkoYWN0aXZlU2Vzc2lvbklkcyl9YCk7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZygnQ2xlYW5pbmcgdXAgdGhlIG9ic29sZXRlIHNlc3Npb25zJyk7XG4gICAgICAgIGF3YWl0IEIuYWxsKGFjdGl2ZVNlc3Npb25JZHMubWFwKChpZCkgPT5cbiAgICAgICAgICBheGlvcyh7XG4gICAgICAgICAgICB1cmw6IGBodHRwOi8vJHt0aGlzLmhvc3R9OiR7dGhpcy5zeXN0ZW1Qb3J0fS9zZXNzaW9uLyR7aWR9YCxcbiAgICAgICAgICAgIG1ldGhvZDogJ0RFTEVURScsXG4gICAgICAgICAgfSlcbiAgICAgICAgKSk7XG4gICAgICAgIC8vIExldCBhbGwgc2Vzc2lvbnMgdG8gYmUgcHJvcGVybHkgdGVybWluYXRlZCBiZWZvcmUgY29udGludWluZ1xuICAgICAgICBhd2FpdCBCLmRlbGF5KDEwMDApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdObyBvYnNvbGV0ZSBzZXNzaW9ucyBoYXZlIGJlZW4gZGV0ZWN0ZWQnKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYE5vIG9ic29sZXRlIHNlc3Npb25zIGhhdmUgYmVlbiBkZXRlY3RlZCAoJHtlLm1lc3NhZ2V9KWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoY2Fwcykge1xuICAgIGF3YWl0IHRoaXMuY2xlYW51cFNlc3Npb25MZWZ0b3ZlcnMoKTtcblxuICAgIGNvbnN0IGNtZCA9IFtcbiAgICAgICdzaGVsbCcsXG4gICAgICAnYW0nLCAnaW5zdHJ1bWVudCcsXG4gICAgICAnLXcnLFxuICAgICAgJy1lJywgJ2RlYnVnJywgcHJvY2Vzcy5lbnYuRVNQUkVTU09fSkFWQV9ERUJVRyA9PT0gJ3RydWUnLFxuICAgIF07XG5cbiAgICBpZiAoXy5pc0Jvb2xlYW4odGhpcy5kaXNhYmxlU3VwcHJlc3NBY2Nlc3NpYmlsaXR5U2VydmljZSkpIHtcbiAgICAgIGNtZC5wdXNoKCctZScsICdESVNBQkxFX1NVUFBSRVNTX0FDQ0VTU0lCSUxJVFlfU0VSVklDRVMnLCB0aGlzLmRpc2FibGVTdXBwcmVzc0FjY2Vzc2liaWxpdHlTZXJ2aWNlKTtcbiAgICB9XG5cbiAgICBjbWQucHVzaChgJHtURVNUX0FQS19QS0d9L2FuZHJvaWR4LnRlc3QucnVubmVyLkFuZHJvaWRKVW5pdFJ1bm5lcmApO1xuXG4gICAgbG9nZ2VyLmluZm8oYFN0YXJ0aW5nIEVzcHJlc3NvIFNlcnZlciB2JHt2ZXJzaW9ufSB3aXRoIGNtZDogYWRiICR7Y21kLmpvaW4oJyAnKX1gKTtcblxuICAgIGxldCBoYXNTb2NrZXRFcnJvciA9IGZhbHNlO1xuICAgIGxldCBkaWRJbnN0cnVtZW50YXRpb25RdWl0ID0gZmFsc2U7XG5cbiAgICAvLyBzdGFydCB0aGUgaW5zdHJ1bWVudGF0aW9uIHByb2Nlc3NcbiAgICB0aGlzLmluc3RQcm9jZXNzID0gdGhpcy5hZGIuY3JlYXRlU3ViUHJvY2VzcyhjbWQpO1xuICAgIHRoaXMuaW5zdFByb2Nlc3Mub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICBsb2dnZXIuaW5mbyhgSW5zdHJ1bWVudGF0aW9uIHByb2Nlc3MgZXhpdGVkIHdpdGggY29kZSAke2NvZGV9IGZyb20gc2lnbmFsICR7c2lnbmFsfWApO1xuICAgICAgZGlkSW5zdHJ1bWVudGF0aW9uUXVpdCA9IHRydWU7XG4gICAgfSk7XG4gICAgdGhpcy5pbnN0UHJvY2Vzcy5vbignZGllJywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGBJbnN0cnVtZW50YXRpb24gcHJvY2VzcyBkaWVkIHdpdGggY29kZSAke2NvZGV9IGFuZCBzaWduYWwgJHtzaWduYWx9YCk7XG4gICAgICBkaWRJbnN0cnVtZW50YXRpb25RdWl0ID0gdHJ1ZTtcbiAgICB9KTtcbiAgICB0aGlzLmluc3RQcm9jZXNzLm9uKCdzdHJlYW0tbGluZScsIChsaW5lKSA9PiB7XG4gICAgICBpZiAoXy5pc0VtcHR5KGxpbmUudHJpbSgpKSkge1xuICAgICAgICAvLyBEbyBub3QgcHJpbnQgZW1wdHkgbGluZXMgaW50byB0aGUgc3lzdGVtIGxvZ1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGxvZ2dlci5kZWJ1ZyhgW0luc3RydW1lbnRhdGlvbl0gJHtsaW5lLnRyaW0oKX1gKTtcbiAgICAgIC8vIEEgJ1NvY2tldEV4Y2VwdGlvbicgaW5kaWNhdGVzIHRoYXQgd2UgY291bGRuJ3QgY29ubmVjdCB0byB0aGUgRXNwcmVzc28gU2VydmVyLCBiZWNhdXNlIHRoZSBJTlRFUk5FVCBwZXJtaXNzaW9uIGlzIG5vdCBzZXRcbiAgICAgIGlmIChsaW5lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ2phdmEubmV0LnNvY2tldGV4Y2VwdGlvbicpKSB7XG4gICAgICAgIGhhc1NvY2tldEVycm9yID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSBpZiAobGluZS5pbmNsdWRlcygnUHJvY2VzcyBjcmFzaGVkJykpIHtcbiAgICAgICAgdGhpcy5kaWRJbnN0cnVtZW50YXRpb25DcmFzaCA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCB0aW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICAgIGF3YWl0IHRoaXMuaW5zdFByb2Nlc3Muc3RhcnQoMCk7XG4gICAgbG9nZ2VyLmluZm8oYFdhaXRpbmcgdXAgdG8gJHt0aGlzLnNlcnZlckxhdW5jaFRpbWVvdXR9bXMgZm9yIEVzcHJlc3NvIHNlcnZlciB0byBiZSBvbmxpbmVgKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgIGlmIChoYXNTb2NrZXRFcnJvcikge1xuICAgICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBFc3ByZXNzbyBzZXJ2ZXIgaGFzIGZhaWxlZCB0byBzdGFydCBkdWUgdG8gYW4gdW5leHBlY3RlZCBleGNlcHRpb24uIGAgK1xuICAgICAgICAgICAgYE1ha2Ugc3VyZSB0aGUgJ0lOVEVSTkVUJyBwZXJtaXNzaW9uIGlzIHJlcXVlc3RlZCBpbiB0aGUgQW5kcm9pZCBtYW5pZmVzdCBvZiB5b3VyIGAgK1xuICAgICAgICAgICAgYGFwcGxpY2F0aW9uIHVuZGVyIHRlc3QgKDx1c2VzLXBlcm1pc3Npb24gYW5kcm9pZDpuYW1lPVwiYW5kcm9pZC5wZXJtaXNzaW9uLklOVEVSTkVUXCIgLz4pYCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZGlkSW5zdHJ1bWVudGF0aW9uUXVpdCkge1xuICAgICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBFc3ByZXNzbyBzZXJ2ZXIgcHJvY2VzcyBoYXMgYmVlbiB1bmV4cGVjdGVkbHkgdGVybWluYXRlZC4gYCArXG4gICAgICAgICAgICBgQ2hlY2sgdGhlIEFwcGl1bSBzZXJ2ZXIgbG9nIGFuZCB0aGUgbG9nY2F0IG91dHB1dCBmb3IgbW9yZSBkZXRhaWxzYCk7XG4gICAgICAgIH1cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSwge1xuICAgICAgICB3YWl0TXM6IHRoaXMuc2VydmVyTGF1bmNoVGltZW91dCxcbiAgICAgICAgaW50ZXJ2YWxNczogNTAwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKC9Db25kaXRpb24gdW5tZXQvLnRlc3QoZS5tZXNzYWdlKSkge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgVGltZWQgb3V0IHdhaXRpbmcgZm9yIEVzcHJlc3NvIHNlcnZlciB0byBiZSBgICtcbiAgICAgICAgICBgb25saW5lIHdpdGhpbiAke3RoaXMuc2VydmVyTGF1bmNoVGltZW91dH1tcy4gVGhlIHRpbWVvdXQgdmFsdWUgY291bGQgYmUgYCArXG4gICAgICAgICAgYGN1c3RvbWl6ZWQgdXNpbmcgJ2VzcHJlc3NvU2VydmVyTGF1bmNoVGltZW91dCcgY2FwYWJpbGl0eWApO1xuICAgICAgfVxuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gICAgbG9nZ2VyLmluZm8oYEVzcHJlc3NvIHNlcnZlciBpcyBvbmxpbmUuIGAgK1xuICAgICAgYFRoZSBpbml0aWFsaXphdGlvbiBwcm9jZXNzIHRvb2sgJHt0aW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXNgKTtcbiAgICBsb2dnZXIuaW5mbygnU3RhcnRpbmcgdGhlIHNlc3Npb24nKTtcblxuICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge1xuICAgICAgY2FwYWJpbGl0aWVzOiB7XG4gICAgICAgIGZpcnN0TWF0Y2g6IFtjYXBzXSxcbiAgICAgICAgYWx3YXlzTWF0Y2g6IHt9XG4gICAgICB9XG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5yZWNvcmRUYXJnZXRBcHBQYWNrYWdlKCk7XG4gIH1cblxuICBhc3luYyByZWNvcmRUYXJnZXRBcHBQYWNrYWdlICgpIHtcbiAgICBhd2FpdCB0aGlzLmFkYi5zaGVsbChbYGVjaG8gXCIke3RoaXMuYXBwUGFja2FnZX1cIiA+IFwiJHtUQVJHRVRfUEFDS0FHRV9DT05UQUlORVJ9XCJgXSk7XG4gICAgbG9nZ2VyLmluZm8oYFJlY29yZGVkIHRoZSB0YXJnZXQgYXBwbGljYXRpb24gcGFja2FnZSAnJHt0aGlzLmFwcFBhY2thZ2V9JyB0byAke1RBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUn1gKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnRGVsZXRpbmcgRXNwcmVzc28gc2VydmVyIHNlc3Npb24nKTtcbiAgICAvLyByZWx5IG9uIGp3cHJveHkncyBpbnRlbGxpZ2VuY2UgdG8ga25vdyB3aGF0IHdlJ3JlIHRhbGtpbmcgYWJvdXQgYW5kXG4gICAgLy8gZGVsZXRlIHRoZSBjdXJyZW50IHNlc3Npb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy8nLCAnREVMRVRFJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIEVzcHJlc3NvIGRlbGV0ZVNlc3Npb24gd29ya2VkOyBgICtcbiAgICAgICAgICBgRXJyb3Igd2FzOiAke2Vycn1gKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pbnN0UHJvY2VzcyAmJiB0aGlzLmluc3RQcm9jZXNzLmlzUnVubmluZykge1xuICAgICAgYXdhaXQgdGhpcy5pbnN0UHJvY2Vzcy5zdG9wKCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB7IEVzcHJlc3NvUnVubmVyLCBSRVFVSVJFRF9QQVJBTVMsIFRFU1RfQVBLX1BLRyB9O1xuZXhwb3J0IGRlZmF1bHQgRXNwcmVzc29SdW5uZXI7XG4iXSwiZmlsZSI6ImxpYi9lc3ByZXNzby1ydW5uZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
